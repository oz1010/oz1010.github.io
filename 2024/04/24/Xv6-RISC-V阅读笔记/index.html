<!doctype html><html lang=zh-CN><meta charset=UTF-8><meta content="width=device-width" name=viewport><meta content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/icon-180.png rel=apple-touch-icon sizes=180x180><link href=/images/icon-32.png rel=icon sizes=32x32 type=image/png><link href=/images/icon-16.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/oz1010_logo.svg rel=mask-icon><style>:root{--body-bg-color:#f5f7f9;--content-bg-color:#fff;--card-bg-color:#f5f5f5;--text-color:#555;--selection-bg:#262a30;--selection-color:#eee;--blockquote-color:#666;--link-color:#555;--link-hover-color:#222;--brand-color:#fff;--brand-hover-color:#fff;--table-row-odd-bg-color:#f9f9f9;--table-row-hover-bg-color:#f5f5f5;--menu-item-bg-color:#f5f5f5;--theme-color:#222;--btn-default-bg:#fff;--btn-default-color:#555;--btn-default-border-color:#555;--btn-default-hover-bg:#222;--btn-default-hover-color:#fff;--btn-default-hover-border-color:#222;--highlight-background:#f6f6f6;--highlight-foreground:#2f3337;--highlight-gutter-background:#e2e2e2;--highlight-gutter-foreground:#42464a;color-scheme:light}html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{margin:.67em 0;font-size:2em}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace;font-size:1em}a{background:0 0}abbr[title]{border-bottom:none;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace;font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:100%;line-height:1.15}button,input{overflow:visible}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted buttontext}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;white-space:normal;max-width:100%;padding:0;display:table}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}details{display:block}summary{display:list-item}template,[hidden]{display:none}::selection{background:var(--selection-bg);color:var(--selection-color)}html,body{height:100%}body{background:var(--body-bg-color);box-sizing:border-box;color:var(--text-color);min-height:100%;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-size:1em;line-height:2;transition:padding .2s ease-in-out;position:relative}h1,h2,h3,h4,h5,h6{margin:30px 0 15px;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-weight:700;line-height:1.5}h1{font-size:1.5em}h2{font-size:1.375em}h3{font-size:1.25em}h4{font-size:1.125em}h5{font-size:1em}h6{font-size:.875em}a{color:var(--link-color);cursor:pointer;overflow-wrap:break-word;border-bottom:1px solid #999;outline:0;text-decoration:none}a:hover{border-bottom-color:var(--link-hover-color);color:var(--link-hover-color)}iframe,img,video,embed{max-width:100%;margin-left:auto;margin-right:auto;display:block}hr{background-image:repeating-linear-gradient(-45deg,#ddd,#ddd 4px,#0000 4px 8px);border:0;height:3px;margin:40px 0}blockquote{color:var(--blockquote-color);border-left:4px solid #ddd;margin:0;padding:0 15px}blockquote cite:before{content:"-";padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}.table-container{overflow:auto}table{border-collapse:collapse;border-spacing:0;width:100%;margin:0 0 20px;font-size:.875em}tbody tr:nth-of-type(odd){background:var(--table-row-odd-bg-color)}tbody tr:hover{background:var(--table-row-hover-bg-color)}caption,th,td{padding:8px}th,td{border:1px solid #ddd;border-bottom-width:3px}th{padding-bottom:10px;font-weight:700}td{border-bottom-width:1px}.btn{background:var(--btn-default-bg);border:2px solid var(--btn-default-border-color);color:var(--btn-default-color);border-radius:2px;padding:0 20px;font-size:.875em;line-height:2;transition:background-color .2s ease-in-out;display:inline-block}.btn:hover{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{text-align:left;width:1.28571em}.toggle{line-height:0}.toggle .toggle-line{background:#fff;width:100%;height:2px;transition:left .4s,opacity .4s,top .4s,transform .4s,width .4s;display:block;position:relative;top:0;left:0}.toggle .toggle-line:first-child{margin-top:1px}.toggle .toggle-line:not(:first-child){margin-top:4px}.toggle.toggle-arrow :first-child{width:50%;top:2px;left:50%;transform:rotate(45deg)}.toggle.toggle-arrow :last-child{width:50%;top:-2px;left:50%;transform:rotate(-45deg)}.toggle.toggle-close :nth-child(2){opacity:0}.toggle.toggle-close :first-child{top:6px;transform:rotate(45deg)}.toggle.toggle-close :last-child{top:-6px;transform:rotate(-45deg)}pre code.hljs{padding:1em;display:block;overflow-x:auto}code.hljs{padding:3px 5px}.hljs{color:#2f3337;background:#f6f6f6}.hljs-subst{color:#2f3337}.hljs-comment{color:#656e77}.hljs-keyword,.hljs-selector-tag,.hljs-meta .hljs-keyword,.hljs-doctag,.hljs-section,.hljs-attr{color:#015692}.hljs-attribute{color:#803378}.hljs-name,.hljs-type,.hljs-number,.hljs-selector-id,.hljs-quote,.hljs-template-tag{color:#b75501}.hljs-selector-class{color:#015692}.hljs-string,.hljs-regexp,.hljs-symbol,.hljs-variable,.hljs-template-variable,.hljs-link,.hljs-selector-attr{color:#54790d}.hljs-meta,.hljs-selector-pseudo{color:#015692}.hljs-built_in,.hljs-title,.hljs-literal{color:#b75501}.hljs-bullet,.hljs-code{color:#535a60}.hljs-meta .hljs-string{color:#54790d}.hljs-deletion{color:#c02d2e}.hljs-addition{color:#2f6f44}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.highlight:hover .copy-btn,.code-container:hover .copy-btn{opacity:1}.code-container{position:relative}.code-lang{opacity:.1;pointer-events:none;font-size:40px;line-height:1;position:absolute;right:5px}.copy-btn{color:#333;cursor:pointer;opacity:0;background:#fff;border:0;padding:2px 6px;font-size:.8125em;line-height:1.6;transition:opacity .2s ease-in-out;position:absolute;top:0;right:0}code,kbd,figure.highlight,pre{background:var(--highlight-background);color:var(--highlight-foreground)}figure.highlight,pre{margin:0 auto 20px;line-height:1.6}figure.highlight figcaption,pre .caption{background:var(--highlight-gutter-background);color:var(--highlight-foreground);padding:.5em;font-size:.875em;line-height:1.2;display:flow-root}figure.highlight figcaption a,pre .caption a{color:var(--highlight-foreground);float:right}figure.highlight figcaption a:hover,pre .caption a:hover{border-bottom-color:var(--highlight-foreground)}pre,code{font-family:consolas,Menlo,monospace,PingFang SC,Microsoft YaHei}code{overflow-wrap:break-word;border-radius:3px;padding:2px 4px;font-size:.875em}kbd{white-space:nowrap;border:2px solid #ccc;border-radius:.2em;padding:.1em .3em;font-family:inherit;box-shadow:.1em .1em .2em #0000001a}figure.highlight{position:relative;overflow:auto}figure.highlight pre{border:0;margin:0;padding:10px 0}figure.highlight table{border:0;width:auto;margin:0}figure.highlight td{border:0;padding:0}figure.highlight .gutter{-webkit-user-select:none;user-select:none}figure.highlight .gutter pre{background:var(--highlight-gutter-background);color:var(--highlight-gutter-foreground);text-align:right;padding-left:10px;padding-right:10px}figure.highlight .code pre{width:100%;padding-left:10px}figure.highlight .marked{background:#0000004d}pre .caption{margin-bottom:10px}.gist table{width:auto}.gist table td{border:0}pre{padding:10px;overflow:auto}pre code{text-shadow:none;background:0 0;padding:0}.blockquote-center{text-align:center;border-left:0;margin:40px 0;padding:0;position:relative}.blockquote-center:before,.blockquote-center:after{opacity:.6;width:100%;line-height:1;position:absolute;left:0}.blockquote-center:before{text-align:left;content:"";border-top:1px solid #ccc;font-family:"Font Awesome 6 Free";font-weight:900;top:-20px}.blockquote-center:after{text-align:right;content:"";border-bottom:1px solid #ccc;font-family:"Font Awesome 6 Free";font-weight:900;bottom:-20px}.blockquote-center p,.blockquote-center div{text-align:center}.group-picture{margin-bottom:20px}.group-picture .group-picture-row{gap:3px;margin-bottom:3px;display:flex}.group-picture .group-picture-column{flex:1}.group-picture .group-picture-column img{object-fit:cover;width:100%;height:100%;margin:0}.post-body .label{color:#555;padding:0 2px}.post-body .label.default{background:#f0f0f0}.post-body .label.primary{background:#efe6f7}.post-body .label.info{background:#e5f2f8}.post-body .label.success{background:#e7f4e9}.post-body .label.warning{background:#fcf6e1}.post-body .label.danger{background:#fae8eb}.post-body .link-grid{grid-gap:1.5rem;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;margin-bottom:20px;padding:1rem;display:grid}.post-body .link-grid .link-grid-container{border:solid #ddd;min-width:0;min-height:5rem;padding:.5rem;transition:background .3s;position:relative;box-shadow:1rem 1rem .5rem #00000080}.post-body .link-grid .link-grid-container:hover{background:var(--card-bg-color);animation:.5s next-shake}.post-body .link-grid .link-grid-container:active{transform:translate(.2rem,.2rem);box-shadow:.5rem .5rem .25rem #00000080}.post-body .link-grid .link-grid-container .link-grid-image{box-sizing:border-box;border:1px solid #ddd;border-radius:50%;width:5rem;height:5rem;padding:3px;position:absolute}.post-body .link-grid .link-grid-container p{margin:0 1rem 0 6rem}.post-body .link-grid .link-grid-container p:first-of-type{font-size:1.2em}.post-body .link-grid .link-grid-container p:last-of-type{opacity:.7;font-size:.8em;line-height:1.3rem}.post-body .link-grid .link-grid-container a{border:0;width:100%;height:100%;position:absolute;top:0;left:0}@keyframes next-shake{0%{transform:translate(1pt,1pt)rotate(0)}10%{transform:translate(-1pt,-2pt)rotate(-1deg)}20%{transform:translate(-3pt)rotate(1deg)}30%{transform:translate(3pt,2pt)rotate(0)}40%{transform:translate(1pt,-1pt)rotate(1deg)}50%{transform:translate(-1pt,2pt)rotate(-1deg)}60%{transform:translate(-3pt,1pt)rotate(0)}70%{transform:translate(3pt,1pt)rotate(-1deg)}80%{transform:translate(-1pt,-1pt)rotate(1deg)}90%{transform:translate(1pt,2pt)rotate(0)}to{transform:translate(1pt,-2pt)rotate(-1deg)}}.post-body .note{border:1px solid #eee;border-left-width:5px;border-radius:3px;margin-bottom:20px;padding:1em;position:relative}.post-body .note summary{cursor:pointer;outline:0}.post-body .note summary p{display:inline}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{border-bottom:initial;margin:0;padding-top:0}.post-body .note :first-child{margin-top:0}.post-body .note :last-child{margin-bottom:0}.post-body .note.default{border-left-color:#777}.post-body .note.default h2,.post-body .note.default h3,.post-body .note.default h4,.post-body .note.default h5,.post-body .note.default h6{color:#777}.post-body .note.primary{border-left-color:#6f42c1}.post-body .note.primary h2,.post-body .note.primary h3,.post-body .note.primary h4,.post-body .note.primary h5,.post-body .note.primary h6{color:#6f42c1}.post-body .note.info{border-left-color:#428bca}.post-body .note.info h2,.post-body .note.info h3,.post-body .note.info h4,.post-body .note.info h5,.post-body .note.info h6{color:#428bca}.post-body .note.success{border-left-color:#5cb85c}.post-body .note.success h2,.post-body .note.success h3,.post-body .note.success h4,.post-body .note.success h5,.post-body .note.success h6{color:#5cb85c}.post-body .note.warning{border-left-color:#f0ad4e}.post-body .note.warning h2,.post-body .note.warning h3,.post-body .note.warning h4,.post-body .note.warning h5,.post-body .note.warning h6{color:#f0ad4e}.post-body .note.danger{border-left-color:#d9534f}.post-body .note.danger h2,.post-body .note.danger h3,.post-body .note.danger h4,.post-body .note.danger h5,.post-body .note.danger h6{color:#d9534f}.post-body .tabs{margin-bottom:20px}.post-body .tabs,.tabs-comment{padding-top:10px}.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{background:var(--content-bg-color);z-index:5;flex-wrap:wrap;justify-content:center;margin:0;padding:0;display:flex;position:sticky;top:0}@media (width<=413px){.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{margin-bottom:5px;display:block}}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border:1px solid #0000;border-top-width:3px;border-bottom-color:#ddd;border-radius:0;flex-grow:1;list-style-type:none}@media (width<=413px){.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border:1px solid #0000;border-left-width:3px;border-radius:0}}.post-body .tabs ul.nav-tabs li.tab a,.tabs-comment ul.nav-tabs li.tab a{border-bottom:initial;text-align:center;padding:.25em .75em;line-height:1.8;transition:all .2s ease-out;display:block}.post-body .tabs ul.nav-tabs li.tab a i[class^=fa],.tabs-comment ul.nav-tabs li.tab a i[class^=fa]{width:1.28571em}.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#fc6423 #ddd #0000}@media (width<=413px){.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#ddd #ddd #ddd #fc6423}}.post-body .tabs ul.nav-tabs li.tab.active a,.tabs-comment ul.nav-tabs li.tab.active a{cursor:default}.post-body .tabs .tab-content,.tabs-comment .tab-content{border:1px solid #ddd;border-top-color:#0000;border-radius:0}@media (width<=413px){.post-body .tabs .tab-content,.tabs-comment .tab-content{border-top-color:#ddd;border-radius:0}}.post-body .tabs .tab-content .tab-pane,.tabs-comment .tab-content .tab-pane{padding:20px 20px 0}.post-body .tabs .tab-content .tab-pane:not(.active),.tabs-comment .tab-content .tab-pane:not(.active){display:none}.pagination .prev,.pagination .next,.pagination .page-number,.pagination .space{margin:-1px 10px 0;padding:0 10px;display:inline-block}@media (width<=767px){.pagination .prev,.pagination .next,.pagination .page-number,.pagination .space{margin:0 5px}}.pagination .page-number.current{color:var(--content-bg-color);background:#ccc;border-color:#ccc}.pagination{text-align:center;border-top:1px solid #eee;margin:120px 0 0}.pagination .prev,.pagination .next,.pagination .page-number{border-top:1px solid #eee;border-bottom:0;transition:border-color .2s ease-in-out}.pagination .prev:hover,.pagination .next:hover,.pagination .page-number:hover{border-top-color:var(--link-hover-color)}@media (width<=767px){.pagination{border-top:0}.pagination .prev,.pagination .next,.pagination .page-number{border-top:0;border-bottom:1px solid #eee}.pagination .prev:hover,.pagination .next:hover,.pagination .page-number:hover{border-bottom-color:var(--link-hover-color)}}.pagination .space{margin:0;padding:0}.comments{margin-top:60px;overflow:hidden}.comment-button-group{flex-wrap:wrap;justify-content:center;margin:1em 0;display:flex}.comment-button-group .comment-button{margin:.1em .2em}.comment-button-group .comment-button.active{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.comment-position{display:none}.comment-position.active{display:block}.tabs-comment{margin-top:4em;padding-top:0}.tabs-comment .comments{margin-top:0;padding-top:0}.headband{background:var(--theme-color);height:3px}@media (width<=991px){.headband{display:none}}.site-brand-container{flex-shrink:0;padding:0 10px;display:flex}.use-motion .column,.use-motion .site-brand-container .toggle{opacity:0}.site-meta{text-align:center;flex-grow:1}@media (width<=767px){.site-meta{text-align:center}}.custom-logo-image{margin-top:20px}@media (width<=991px){.custom-logo-image{display:none}}.brand{color:var(--brand-color);border-bottom:0;padding:0;display:inline-block}.brand:hover{color:var(--brand-hover-color)}.site-title{margin:0;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-size:1.375em;font-weight:400;line-height:1.5}.site-subtitle{color:#ddd;margin:10px 10px 0;font-size:.8125em}.use-motion .site-title,.use-motion .site-subtitle,.use-motion .custom-logo-image{opacity:0;position:relative;top:-10px}.site-nav-toggle,.site-nav-right{display:none}@media (width<=767px){.site-nav-toggle,.site-nav-right{flex-direction:column;justify-content:center;display:flex}}.site-nav-toggle .toggle,.site-nav-right .toggle{color:var(--text-color);width:22px;padding:10px}.site-nav-toggle .toggle .toggle-line,.site-nav-right .toggle .toggle-line{background:var(--text-color);border-radius:1px}@media (width<=767px){.site-nav{--scroll-height:0;visibility:hidden;height:0;transition:height .2s ease-in-out,visibility .2s ease-in-out;overflow:hidden}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height);visibility:unset}}.menu{text-align:center;margin:0;padding:1em 0}.menu-item{margin:0 10px;list-style:none;display:inline-block}@media (width<=767px){.menu-item{margin-top:10px;display:block}.menu-item.menu-item-search{display:none}}.menu-item a{border-bottom:0;font-size:.8125em;transition:border-color .2s ease-in-out;display:block}.menu-item a:hover,.menu-item a.menu-item-active{background:var(--menu-item-bg-color)}.menu-item i[class^=fa]{margin-right:8px}.menu-item .badge{color:var(--content-bg-color);text-shadow:1px 1px #0000001a;background:#ccc;border-radius:10px;margin-left:.35em;padding:2px 5px;font-weight:700;line-height:1}.use-motion .menu-item{visibility:hidden}@media (width<=991px){.sidebar{left:-320px}.sidebar-active .sidebar{left:0}.sidebar{z-index:20;background:#222;width:320px;max-height:100vh;transition:left .2s ease-out,right .2s ease-out;position:fixed;top:0;bottom:0;overflow-y:auto;box-shadow:inset 0 2px 6px #000}.sidebar a{color:#999;border-bottom-color:#555}.sidebar a:hover{color:#eee;border-bottom-color:#eee}.links-of-author:not(:first-child){margin-top:15px}.links-of-author a{vertical-align:middle;border-bottom-color:#555;margin-bottom:10px;margin-right:10px;display:inline-block}.links-of-author a:before{content:" ";background:#ffff58;border-radius:50%;width:4px;height:4px;margin-right:3px;display:inline-block;transform:translateY(-2px)}.links-of-blogroll-item{padding:0 5px}.popular-posts .popular-posts-item .popular-posts-link:hover{background:0 0}.sidebar-dimmer{opacity:0;visibility:hidden;z-index:10;background:#000;width:100%;height:100%;transition:visibility .4s,opacity .4s;position:fixed;top:0;left:0}.sidebar-active .sidebar-dimmer{opacity:.7;visibility:visible}}.sidebar-inner{color:#999;text-align:center;flex-direction:column;justify-content:center;padding:18px 10px;display:flex}.sidebar-toggle{cursor:pointer;opacity:.6;z-index:30;background:#222;width:16px;height:16px;padding:5px;position:fixed;bottom:61px;left:30px}@media (width<=991px){.sidebar-toggle{left:20px}}.sidebar-toggle:hover{opacity:.8}@media (width<=991px){.sidebar-toggle{opacity:.8}}.sidebar-toggle:hover .toggle-line{background:#fc6423}@media (any-hover:hover){body:not(.sidebar-active) .sidebar-toggle:hover :first-child{width:50%;top:2px;left:50%;transform:rotate(45deg)}body:not(.sidebar-active) .sidebar-toggle:hover :last-child{width:50%;top:-2px;left:50%;transform:rotate(-45deg)}}.sidebar-active .sidebar-toggle :nth-child(2){opacity:0}.sidebar-active .sidebar-toggle :first-child{top:6px;transform:rotate(45deg)}.sidebar-active .sidebar-toggle :last-child{top:-6px;transform:rotate(-45deg)}.sidebar-nav{pointer-events:none;visibility:hidden;height:0;margin:0;padding-left:0;font-size:.875em;transition:height .2s ease-in-out,visibility .2s ease-in-out;overflow:hidden}.sidebar-nav-active .sidebar-nav{pointer-events:unset;height:calc(2em + 1px);visibility:unset}.sidebar-nav li{color:var(--text-color);cursor:pointer;border-bottom:1px solid #0000;transition:border-bottom-color .2s ease-in-out,color .2s ease-in-out;display:inline-block}.sidebar-nav li.sidebar-nav-overview{margin-left:10px}.sidebar-nav li:hover{color:#fc6423}.sidebar-toc-active .sidebar-nav-toc,.sidebar-overview-active .sidebar-nav-overview{color:#fc6423;border-bottom-color:#fc6423;transition-delay:.2s}.sidebar-toc-active .sidebar-nav-toc:hover,.sidebar-overview-active .sidebar-nav-overview:hover{color:#fc6423}.sidebar-panel-container{flex:1;align-items:start;padding-top:0;transition:padding-top .2s ease-in-out;display:grid;overflow:hidden auto}.sidebar-nav-active .sidebar-panel-container{padding-top:20px}.sidebar-panel{opacity:0;pointer-events:none;visibility:hidden;grid-area:1/1;height:0;transition:opacity .2s ease-in-out,transform .2s ease-in-out,visibility .2s ease-in-out;animation:.2s ease-in-out deactivate-sidebar-panel;overflow:hidden;transform:translateY(0)}.sidebar-nav-active .sidebar-panel,.sidebar-overview-active .sidebar-panel.post-toc-wrap{transform:translateY(-20px)}.sidebar-overview-active:not(.sidebar-nav-active) .sidebar-panel.post-toc-wrap{transition-delay:0s,.2s,0s}.sidebar-overview-active .sidebar-panel.site-overview-wrap,.sidebar-toc-active .sidebar-panel.post-toc-wrap{opacity:1;pointer-events:unset;height:auto;visibility:unset;transition-delay:.2s,.2s,0s;animation-name:activate-sidebar-panel;transform:translateY(0)}.sidebar-panel.site-overview-wrap{flex-direction:column;justify-content:flex-start;gap:10px;display:flex}@keyframes deactivate-sidebar-panel{0%{height:var(--inactive-panel-height,0)}to{height:var(--active-panel-height,0)}}@keyframes activate-sidebar-panel{0%{height:var(--inactive-panel-height,auto)}to{height:var(--active-panel-height,auto)}}.post-toc{font-size:.875em}.post-toc ol{text-align:left;margin:0;padding:0 2px 0 10px;list-style:none}.post-toc ol>:last-child{margin-bottom:5px}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition:all .2s ease-in-out}.post-toc .nav-item{text-overflow:ellipsis;white-space:nowrap;line-height:1.8;overflow:hidden}.post-toc .nav .active>a{color:#fc6423;border-bottom-color:#fc6423}.post-toc .nav .active-current>a,.post-toc .nav .active-current>a:hover{color:#fc6423}.site-author-image{border:1px solid #eee;border-radius:50%;max-width:120px;padding:2px}.site-author-name{color:var(--text-color);margin:0;font-weight:600}.site-description{color:#999;margin-top:0;font-size:.8125em}.site-state{flex-wrap:wrap;justify-content:center;line-height:1.4;display:flex}.site-state-item{padding:0 15px}.site-state-item a{border-bottom:0;display:block}.site-state-item-count{font-size:1em;font-weight:600;display:block}.site-state-item-name{color:#999;font-size:.8125em}.sidebar .sidebar-button:not(:first-child){margin-top:15px}.sidebar .sidebar-button button{color:#fc6423;cursor:pointer;background:0 0;border:1px solid #fc6423;border-radius:4px;padding:0 15px;line-height:2}.sidebar .sidebar-button button:hover{color:#fff;background:#fc6423}.sidebar .sidebar-button button i[class^=fa]{margin-right:5px}.links-of-author a{font-size:.8125em}.links-of-author i[class^=fa]{margin-right:2px}.cc-license .cc-opacity{opacity:.7;border-bottom:0}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}.links-of-blogroll{font-size:.8125em}.links-of-blogroll-title{font-size:.875em;font-weight:600}.links-of-blogroll-list{flex-flow:column wrap;justify-content:center;gap:5px;margin:5px 0 0;padding:0;list-style:none;display:flex}.links-of-blogroll-item{max-width:100%}.links-of-blogroll-item a{box-sizing:border-box;text-overflow:ellipsis;white-space:nowrap;max-width:100%;display:inline-block;overflow:hidden}.footer{color:#999;padding:20px 0;font-size:.875em;transition:left .2s ease-in-out,right .2s ease-in-out}.footer.footer-fixed{position:absolute;bottom:0;left:0;right:0}.footer-inner{box-sizing:border-box;text-align:center;flex-direction:column;justify-content:center;width:calc(100% - 20px);margin:0 auto;display:flex}@media (width<=767px){.footer-inner{width:auto}}@media (width>=1200px){.footer-inner{width:1160px}}@media (width>=1600px){.footer-inner{width:73%}}.use-motion .footer{opacity:0}.languages{font-size:1.125em;display:inline-block;position:relative}.languages .lang-select-label span{margin:0 .5em}.languages .lang-select{opacity:0;width:100%;height:100%;position:absolute;top:0;left:0}.with-love{color:red;margin:0 5px;display:inline-block}@keyframes icon-animate{0%,to{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}.back-to-top{color:#fff;cursor:pointer;opacity:.6;z-index:30;background:#222;align-items:center;height:26px;font-size:12px;transition:bottom .2s ease-in-out;display:flex;position:fixed;bottom:-100px;left:30px}.back-to-top span{margin-right:8px}.back-to-top .fa{text-align:center;width:26px}@media (width<=991px){.back-to-top{left:20px}}.back-to-top:hover{opacity:.8}@media (width<=991px){.back-to-top{opacity:.8}}.back-to-top:hover{color:#fc6423}.back-to-top.back-to-top-on{bottom:30px}.rtl.post-body p,.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ul,.rtl.post-body ol{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.post-button{text-align:center;margin-top:40px}.use-motion .post-block,.use-motion .pagination,.use-motion .comments,.use-motion .post-header,.use-motion .post-body,.use-motion .collection-header{visibility:hidden}.posts-collapse .post-content{margin-bottom:35px;margin-left:35px;position:relative}@media (width<=767px){.posts-collapse .post-content{margin-left:0;margin-right:0}}.posts-collapse .post-content .collection-title{font-size:1.125em;position:relative}.posts-collapse .post-content .collection-title:before{content:" ";background:#999;border:1px solid #fff;border-radius:50%;width:10px;height:10px;margin-top:-4px;margin-left:-6px;position:absolute;top:50%}.posts-collapse .post-content .collection-year{margin:60px 0;font-size:1.5em;font-weight:700;position:relative}.posts-collapse .post-content .collection-year .collection-year-count{color:var(--content-bg-color);text-shadow:1px 1px #0000001a;background:#ccc;border-radius:10px;margin-left:.35em;padding:2px 5px;font-size:.75em;font-weight:700;line-height:1}.posts-collapse .post-content .collection-year:before{content:" ";background:#bbb;border-radius:50%;width:8px;height:8px;margin-top:-4px;margin-left:-4px;position:absolute;top:50%}.posts-collapse .post-content .collection-header{margin-left:20px;display:block}.posts-collapse .post-content .collection-header small{color:#bbb;margin-left:5px}.posts-collapse .post-content .post-header{border-bottom:1px dashed #ccc;margin:30px 2px 0;padding-left:15px;transition:border .2s ease-in-out;position:relative}.posts-collapse .post-content .post-header:before{content:" ";background:#bbb;border:1px solid #fff;border-radius:50%;width:6px;height:6px;transition:background .2s ease-in-out;position:absolute;top:.75em;left:-6px}.posts-collapse .post-content .post-header:hover{border-bottom-color:#666}.posts-collapse .post-content .post-header:hover:before{background:#222}.posts-collapse .post-content .post-meta-container{margin-right:10px;font-size:.75em;display:inline}.posts-collapse .post-content .post-title{display:inline}.posts-collapse .post-content .post-title a{color:var(--link-color);border-bottom:0}.posts-collapse .post-content .post-title .fa{margin-left:5px;font-size:.875em}.posts-collapse .post-content:before{content:" ";background:#f5f5f5;width:4px;height:100%;margin-left:-2px;position:absolute;top:1.25em}.post-body{overflow-wrap:break-word;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif}@media (width>=1200px){.post-body{font-size:1.125em}}@media (width>=992px){.post-body{text-align:justify}}@media (width<=991px){.post-body{text-align:justify}}.post-body h1 .header-anchor,.post-body h2 .header-anchor,.post-body h3 .header-anchor,.post-body h4 .header-anchor,.post-body h5 .header-anchor,.post-body h6 .header-anchor,.post-body h1 .headerlink,.post-body h2 .headerlink,.post-body h3 .headerlink,.post-body h4 .headerlink,.post-body h5 .headerlink,.post-body h6 .headerlink{color:inherit;float:right;opacity:0;border-bottom-style:none;margin-left:10px;font-size:.875em}.post-body h1 .header-anchor:before,.post-body h2 .header-anchor:before,.post-body h3 .header-anchor:before,.post-body h4 .header-anchor:before,.post-body h5 .header-anchor:before,.post-body h6 .header-anchor:before,.post-body h1 .headerlink:before,.post-body h2 .headerlink:before,.post-body h3 .headerlink:before,.post-body h4 .headerlink:before,.post-body h5 .headerlink:before,.post-body h6 .headerlink:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900}.post-body h1:hover .header-anchor,.post-body h2:hover .header-anchor,.post-body h3:hover .header-anchor,.post-body h4:hover .header-anchor,.post-body h5:hover .header-anchor,.post-body h6:hover .header-anchor,.post-body h1:hover .headerlink,.post-body h2:hover .headerlink,.post-body h3:hover .headerlink,.post-body h4:hover .headerlink,.post-body h5:hover .headerlink,.post-body h6:hover .headerlink{opacity:.5}.post-body h1:hover .header-anchor:hover,.post-body h2:hover .header-anchor:hover,.post-body h3:hover .header-anchor:hover,.post-body h4:hover .header-anchor:hover,.post-body h5:hover .header-anchor:hover,.post-body h6:hover .header-anchor:hover,.post-body h1:hover .headerlink:hover,.post-body h2:hover .headerlink:hover,.post-body h3:hover .headerlink:hover,.post-body h4:hover .headerlink:hover,.post-body h5:hover .headerlink:hover,.post-body h6:hover .headerlink:hover{opacity:1}.post-body .exturl .fa{margin-left:4px;font-size:.875em}.post-body figure:not(.highlight) figcaption{color:#999;text-align:center;margin:-15px auto 15px;font-size:.875em;font-weight:700;line-height:1}.post-body iframe,.post-body img,.post-body video,.post-body embed{margin-bottom:20px}.post-body .video-container{width:100%;height:0;margin-bottom:20px;padding-top:75%;position:relative;overflow:hidden}.post-body .video-container iframe,.post-body .video-container object,.post-body .video-container embed{width:100%;height:100%;margin:0;position:absolute;top:0;left:0}.post-gallery{min-height:200px;display:flex}.post-gallery .post-gallery-image{flex:1}.post-gallery .post-gallery-image:not(:first-child){clip-path:polygon(40px 0,100% 0,100% 100%,0 100%);margin-left:-20px}.post-gallery .post-gallery-image:not(:last-child){margin-right:-20px}.post-gallery .post-gallery-image img{object-fit:cover;opacity:1;width:100%;height:100%}.posts-expand .post-gallery{margin-bottom:60px}.posts-collapse .post-gallery{margin:15px 0}.posts-expand .post-header{text-align:center;margin-bottom:60px;font-size:1.125em}.posts-expand .post-title{margin:initial;overflow-wrap:break-word;font-size:1.5em;font-weight:400}.posts-expand .post-title-link{color:var(--link-color);border-bottom:0;max-width:100%;display:inline-block;position:relative}.posts-expand .post-title-link:before{background:var(--link-color);content:"";width:100%;height:2px;transition:transform .2s ease-in-out;position:absolute;bottom:0;left:0;transform:scaleX(0)}.posts-expand .post-title-link:hover:before{transform:scaleX(1)}.posts-expand .post-title-link .fa{margin-left:5px;font-size:.875em}.post-sticky-flag{margin-right:8px;display:inline-block;transform:rotate(30deg)}.posts-expand .post-meta-container{color:#999;margin-top:3px;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-size:.75em}.posts-expand .post-meta-container .post-description{margin-top:2px;font-size:.875em}.posts-expand .post-meta-container time{border-bottom:1px dashed #999}.post-meta{flex-wrap:wrap;justify-content:center;display:flex}:not(.post-meta-break)+.post-meta-item:before{content:"|";margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (width<=991px){.post-meta-item-text{display:none}}.post-meta-break{flex-basis:100%;height:0}.post-nav{border-top:1px solid #eee;justify-content:space-between;gap:30px;margin-top:1em;padding:10px 5px 0;display:flex}.post-nav-item{flex:1}.post-nav-item a{border-bottom:0;font-size:.875em;line-height:1.6;display:block}.post-nav-item a:active{top:2px}.post-nav-item .fa{font-size:.75em}.post-nav-item:first-child .fa{margin-right:5px}.post-nav-item:last-child{text-align:right}.post-nav-item:last-child .fa{margin-left:5px}.post-footer{flex-direction:column;justify-content:center;display:flex}.post-eof{background:#ccc;width:8%;height:1px;margin:80px auto 60px}.post-block:last-of-type .post-eof{display:none}.post-copyright ul{background:var(--card-bg-color);border-left:3px solid #ff2a2a;margin:1em 0 0;padding:.5em 1em;list-style:none;position:relative;overflow:hidden}.post-copyright ul:after{content:"";opacity:.1;font-family:"Font Awesome 6 Brands";font-size:200px;position:absolute;top:-150px;right:-50px}.post-tags{text-align:center;margin-top:40px}.post-tags a{font-size:.8125em;display:inline-block}.post-tags a:not(:last-child){margin-right:10px}.social-like{border-top:1px solid #eee;flex-wrap:wrap;justify-content:center;margin-top:1em;padding-top:1em;font-size:.875em;display:flex}.social-like a{border-bottom:none}.reward-container{text-align:center;margin:1em 0 0;padding:1em 0}.reward-container button{color:#fc6423;cursor:pointer;vertical-align:text-top;background:0 0;border:2px solid #fc6423;border-radius:2px;outline:0;padding:0 15px;line-height:2}.reward-container button:hover{color:#fff;background:#fc6423}.post-reward{padding-top:20px;display:none}.post-reward.active{display:block}.post-reward div{display:inline-block}.post-reward div span{display:block}.post-reward img{width:180px;max-width:100%;margin:.8em 2em 0;display:inline-block}@keyframes next-roll{0%{transform:rotate(30deg)}to{transform:rotate(-30deg)}}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{margin:0;padding:0;list-style:none}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{color:var(--content-bg-color);text-shadow:1px 1px #0000001a;background:#ccc;border-radius:10px;margin-left:.35em;padding:2px 5px;font-size:.75em;font-weight:700;line-height:1}.category-all-page .category-list-child{padding-left:10px}.event-list hr{background:#222;margin:20px 0 45px}.event-list hr:after{color:#fff;content:"NOW";background:#222;padding:0 5px;font-weight:700;display:inline-block}.event-list .event{--event-background:#222;--event-foreground:#bbb;--event-title:#fff;background:var(--event-background);padding:15px}.event-list .event .event-summary{color:var(--event-title);border-bottom:0;margin:0;padding:0 0 0 35px;position:relative}.event-list .event .event-summary:before{background:var(--event-title);content:" ";border-radius:50%;width:12px;height:12px;margin-top:-6px;animation:1s ease-in-out infinite alternate dot-flash;position:absolute;top:50%;left:0}.event-list .event:nth-of-type(odd) .event-summary:before{animation-delay:.5s}.event-list .event:not(:last-child){margin-bottom:20px}.event-list .event .event-relative-time{color:var(--event-foreground);padding-left:12px;font-size:12px;font-weight:400;display:inline-block}.event-list .event .event-details{color:var(--event-foreground);padding:6px 0 6px 35px;line-height:18px;display:block}.event-list .event .event-details:before{color:var(--event-foreground);width:14px;margin-right:9px;font-family:"Font Awesome 6 Free";font-weight:900;display:inline-block}.event-list .event .event-details.event-location:before{content:""}.event-list .event .event-details.event-duration:before{content:""}.event-list .event .event-details.event-description:before{content:""}.event-list .event-past{--event-background:#f5f5f5;--event-foreground:#999;--event-title:#222}@keyframes dot-flash{0%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}ul.breadcrumb{text-align:center;margin:1em 0;padding:0 2em;font-size:.75em;list-style:none}ul.breadcrumb li{display:inline}ul.breadcrumb li:not(:first-child):before{content:"/ ";padding:.5em;font-weight:400}ul.breadcrumb li:last-child{font-weight:700}.tag-cloud{text-align:center}.tag-cloud a{margin:10px;display:inline-block}.tag-cloud-0{color:#aaa;border-bottom-color:#aaa}.tag-cloud-1{color:#9a9a9a;border-bottom-color:#9a9a9a}.tag-cloud-2{color:#8b8b8b;border-bottom-color:#8b8b8b}.tag-cloud-3{color:#7c7c7c;border-bottom-color:#7c7c7c}.tag-cloud-4{color:#6c6c6c;border-bottom-color:#6c6c6c}.tag-cloud-5{color:#5d5d5d;border-bottom-color:#5d5d5d}.tag-cloud-6{color:#4e4e4e;border-bottom-color:#4e4e4e}.tag-cloud-7{color:#3e3e3e;border-bottom-color:#3e3e3e}.tag-cloud-8{color:#2f2f2f;border-bottom-color:#2f2f2f}.tag-cloud-9{color:#202020;border-bottom-color:#202020}.tag-cloud-10{color:#111;border-bottom-color:#111}.search-active{margin-right:var(--dialog-scrollgutter,0);overflow:hidden}.search-pop-overlay{visibility:hidden;z-index:40;background:0 0;width:100%;height:100%;transition:visibility .4s,background .4s;display:flex;position:fixed;top:0;left:0}.search-active .search-pop-overlay{visibility:visible;background:#0000004d}.search-popup{background:var(--card-bg-color);border-radius:5px;width:700px;height:80%;margin:auto;transition:transform .4s;transform:scale(0)}.search-active .search-popup{transform:scale(1)}@media (width<=767px){.search-popup{border-radius:0;width:100%;height:100%}}.search-popup .search-icon,.search-popup .popup-btn-close{color:#999;padding:0 10px;font-size:18px}.search-popup .popup-btn-close{cursor:pointer}.search-popup .popup-btn-close:hover .fa{color:#222}.search-popup .search-header{background:#eee;border-top-left-radius:5px;border-top-right-radius:5px;padding:5px;display:flex}.search-popup input.search-input{background:0 0;border:0;outline:0;width:100%}.search-popup input.search-input::-webkit-search-cancel-button{display:none}.search-popup .search-result-container{flex-direction:column;height:calc(100% - 55px);padding:5px 25px;display:flex;overflow:auto}.search-popup .search-result-container hr{flex-shrink:0;margin:5px 0 10px}.search-popup .search-result-container hr:first-child{display:none}.search-popup .search-result-list{margin:0 5px;padding:0}.search-popup a.search-result-title{font-weight:700}.search-popup p.search-result{border-bottom:1px dashed #ccc;margin:0 0 10px;padding:5px 0}.search-popup .search-input-container{flex-grow:1;padding:2px}.search-popup .search-result-icon{color:#ccc;margin:auto}mark.search-keyword{color:#ff2a2a;background:0 0;border-bottom:1px dashed #ff2a2a;font-weight:700}.use-motion .animated{visibility:inherit;animation-fill-mode:none}.use-motion .sidebar .animated{animation-fill-mode:both}header.header{background:var(--content-bg-color);border-radius:initial;box-shadow:initial}@media (width<=991px){header.header{border-radius:initial}}.main{justify-content:space-between;align-items:stretch;width:calc(100% - 20px);margin:0 auto;display:flex}@media (width<=767px){.main{width:auto}}@media (width>=1200px){.main{width:1160px}}@media (width>=1600px){.main{width:73%}}@media (width<=991px){.main{width:auto;display:block}}.main-inner{border-radius:initial;box-sizing:border-box;width:calc(100% - 252px)}@media (width<=991px){.main-inner{border-radius:initial;width:100%}}.footer-inner{padding-left:252px}@media (width<=991px){.footer-inner{width:auto;padding-left:0;padding-right:0}}.column{width:240px}@media (width<=991px){.column{width:auto}}.site-brand-container{background:var(--theme-color)}@media (width<=991px){.site-nav-on .site-brand-container{box-shadow:0 0 16px #00000080}}.site-meta{padding:20px 0}@media (width>=768px) and (width<=991px){.site-nav-toggle,.site-nav-right{flex-direction:column;justify-content:center;display:flex}}.site-nav-toggle .toggle,.site-nav-right .toggle{color:#fff}.site-nav-toggle .toggle .toggle-line,.site-nav-right .toggle .toggle-line{background:#fff}@media (width>=768px) and (width<=991px){.site-nav{--scroll-height:0;visibility:hidden;height:0;transition:height .2s ease-in-out,visibility .2s ease-in-out;overflow:hidden}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height);visibility:unset}}.menu .menu-item{margin:0;display:block}.menu .menu-item a{align-items:center;padding:5px 20px;transition-property:background-color;display:flex;position:relative}.menu .menu-item a .badge{margin-left:auto}@media (width<=991px){.menu .menu-item.menu-item-search{display:none}}.sub-menu{margin:0;padding:6px 0}.sub-menu .menu-item{display:inline-block}.sub-menu .menu-item a{padding:initial;background:0 0;margin:5px 10px}.sub-menu .menu-item a:hover{color:#fc6423;background:0 0}.sub-menu .menu-item-active{color:#fc6423;border-bottom-color:#fc6423}.sub-menu .menu-item-active:hover{border-bottom-color:#fc6423}@media (width>=992px){.sidebar{position:sticky;top:12px}.sidebar-toggle{display:none}.sidebar-inner{background:var(--content-bg-color);border-radius:initial;box-shadow:initial;box-sizing:border-box;color:var(--text-color);visibility:hidden;max-height:calc(100vh - 24px);margin-top:12px}.site-state-item{padding:0 10px}.sidebar .sidebar-button{border-top:1px dotted #ccc;border-bottom:1px dotted #ccc}.sidebar .sidebar-button button{color:#fc6423;border:0;width:100%;display:block}.sidebar .sidebar-button button:hover{color:#e34603;background:0 0;border:0}.links-of-author{flex-wrap:wrap;justify-content:center;display:flex}.links-of-author-item{width:50%;margin:5px 0 0}.links-of-author-item a{box-sizing:border-box;text-overflow:ellipsis;white-space:nowrap;border-bottom:0;border-radius:4px;max-width:100%;padding:0 5px;display:inline-block;overflow:hidden}.links-of-author-item a:hover{background:var(--body-bg-color)}.links-of-blogroll-item a{padding:0 5px}}.main-inner{background:var(--content-bg-color);box-shadow:initial;padding:40px}@media (width<=991px){.main-inner{padding:20px}}.sub-menu{border-bottom:1px solid #ddd}.post-block:first-of-type{padding-top:40px}@media (width<=767px){.pagination{margin-bottom:10px}}</style><link integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css rel=stylesheet><link integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css rel=stylesheet><script integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin defer src=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js></script><script class=next-config data-name=main type=application/json>{"hostname":"oz1010.github.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"stackoverflow-light","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"duration":100,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script defer src=/js/config.js></script><meta content="参考原文 Chapter 1 系统接口 Unix utilities实验 实验说明 启动系统 sleep 重点：使用user/user.h的sleep接口实现，单位为jiffies(1/10)。 pingpong 重点：使用pip接口通信。 primes 目的：主进程准备好2-35的数字写入管道。 从管道中读取数字n（此数字为素数），创建一个子进程，并将剩余的非n的倍数的数写入子管道中。然后进程等" name=description><meta content=article property=og:type><meta content=Xv6-RISC-V阅读笔记 property=og:title><meta content=https://oz1010.github.com/2024/04/24/Xv6-RISC-V%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/index.html property=og:url><meta content="oz1010's blog" property=og:site_name><meta content="参考原文 Chapter 1 系统接口 Unix utilities实验 实验说明 启动系统 sleep 重点：使用user/user.h的sleep接口实现，单位为jiffies(1/10)。 pingpong 重点：使用pip接口通信。 primes 目的：主进程准备好2-35的数字写入管道。 从管道中读取数字n（此数字为素数），创建一个子进程，并将剩余的非n的倍数的数写入子管道中。然后进程等" property=og:description><meta content=zh_CN property=og:locale><meta content=2024-04-24T01:44:41.000Z property=article:published_time><meta content=2025-08-25T09:48:33.667Z property=article:modified_time><meta content=oz1010 property=article:author><meta content=summary name=twitter:card><link href=https://oz1010.github.com/2024/04/24/Xv6-RISC-V%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://oz1010.github.com/2024/04/24/Xv6-RISC-V%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/","path":"2024/04/24/Xv6-RISC-V阅读笔记/","title":"Xv6-RISC-V阅读笔记"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>Xv6-RISC-V阅读笔记 | oz1010's blog</title><script integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin defer src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script defer src=/js/utils.js></script><script defer src=/js/motion.js></script><script defer src=/js/sidebar.js></script><script defer src=/js/next-boot.js></script><script integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin defer src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js></script><script defer src=/js/third-party/search/local-search.js></script><script defer src=/js/third-party/pace.js></script><noscript><link href=/css/noscript.css rel=stylesheet></noscript><link title="oz1010's blog" href=/atom.xml rel=alternate type=application/atom+xml><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>oz1010's blog</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>记录生活或技能</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>4</span></a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>13</span></a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>17</span></a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#chapter-1-%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3><span class=nav-number>1.</span> <span class=nav-text>Chapter 1 系统接口</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#unix-utilities%E5%AE%9E%E9%AA%8C><span class=nav-number>1.1.</span> <span class=nav-text>Unix utilities实验</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%90%AF%E5%8A%A8%E7%B3%BB%E7%BB%9F><span class=nav-number>1.1.1.</span> <span class=nav-text>启动系统</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#sleep><span class=nav-number>1.1.2.</span> <span class=nav-text>sleep</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#pingpong><span class=nav-number>1.1.3.</span> <span class=nav-text>pingpong</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#primes><span class=nav-number>1.1.4.</span> <span class=nav-text>primes</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#find><span class=nav-number>1.1.5.</span> <span class=nav-text>find</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#xargs><span class=nav-number>1.1.6.</span> <span class=nav-text>xargs</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#chapter-2-%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84><span class=nav-number>2.</span> <span class=nav-text>Chapter 2 系统结构</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#system-call%E5%AE%9E%E9%AA%8C><span class=nav-number>2.1.</span> <span class=nav-text>system call实验</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#system-call-tracing><span class=nav-number>2.1.1.</span> <span class=nav-text>System call tracing</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#sysinfo><span class=nav-number>2.1.2.</span> <span class=nav-text>Sysinfo</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0><span class=nav-number>2.2.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#chapter-3-%E9%A1%B5%E8%A1%A8><span class=nav-number>3.</span> <span class=nav-text>Chapter 3 页表</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4><span class=nav-number>3.1.</span> <span class=nav-text>创建地址空间</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D><span class=nav-number>3.2.</span> <span class=nav-text>物理内存分配</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4><span class=nav-number>3.3.</span> <span class=nav-text>进程地址空间</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#sbrk><span class=nav-number>3.4.</span> <span class=nav-text>sbrk</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#exec><span class=nav-number>3.5.</span> <span class=nav-text>exec</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0-1><span class=nav-number>3.6.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#chapter-4-traps%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8><span class=nav-number>4.</span> <span class=nav-text>Chapter 4 traps和系统调用</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#riscv%E7%9A%84trap%E6%9C%BA%E5%88%B6><span class=nav-number>4.1.</span> <span class=nav-text>riscv的trap机制</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84traps%E6%B5%81%E7%A8%8B><span class=nav-number>4.2.</span> <span class=nav-text>用户空间的traps流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B><span class=nav-number>4.3.</span> <span class=nav-text>系统调用流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8><span class=nav-number>4.4.</span> <span class=nav-text>系统调用参数列表</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E7%9A%84traps%E6%B5%81%E7%A8%8B><span class=nav-number>4.5.</span> <span class=nav-text>内核空间的traps流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8><span class=nav-number>4.6.</span> <span class=nav-text>缺页异常</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0-2><span class=nav-number>4.7.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E4%B8%AD%E6%96%AD%E5%92%8C%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8><span class=nav-number>5.</span> <span class=nav-text>中断和设备驱动</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%88%E7%AB%AF%E8%BE%93%E5%85%A5><span class=nav-number>5.1.</span> <span class=nav-text>终端输入</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%88%E7%AB%AF%E8%BE%93%E5%87%BA><span class=nav-number>5.2.</span> <span class=nav-text>终端输出</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%B9%B6%E5%8F%91><span class=nav-number>5.3.</span> <span class=nav-text>驱动的并发</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%AE%A1%E6%97%B6%E5%99%A8%E4%B8%AD%E6%96%AD><span class=nav-number>5.4.</span> <span class=nav-text>计时器中断</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0-3><span class=nav-number>5.5.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#chapter-6-%E9%94%81><span class=nav-number>6.</span> <span class=nav-text>Chapter 6 锁</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%AB%9E%E4%BA%89><span class=nav-number>6.1.</span> <span class=nav-text>竞争</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%94%81><span class=nav-number>6.2.</span> <span class=nav-text>锁</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%BD%BF%E7%94%A8%E9%94%81><span class=nav-number>6.3.</span> <span class=nav-text>使用锁</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%86%8D%E5%85%A5%E9%94%81><span class=nav-number>6.4.</span> <span class=nav-text>再入锁</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%94%81%E5%92%8C%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F><span class=nav-number>6.5.</span> <span class=nav-text>锁和中断处理程序</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%8C%87%E4%BB%A4%E5%92%8C%E5%86%85%E5%AD%98%E9%A1%BA%E5%BA%8F><span class=nav-number>6.6.</span> <span class=nav-text>指令和内存顺序</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%9D%A1%E7%9C%A0%E9%94%81><span class=nav-number>6.7.</span> <span class=nav-text>睡眠锁</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0-4><span class=nav-number>6.8.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E8%B0%83%E5%BA%A6><span class=nav-number>7.</span> <span class=nav-text>调度</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%A4%8D%E7%94%A8><span class=nav-number>7.1.</span> <span class=nav-text>复用</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2><span class=nav-number>7.2.</span> <span class=nav-text>上下文切换</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%B0%83%E5%BA%A6-1><span class=nav-number>7.3.</span> <span class=nav-text>调度</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#mycpu%E5%92%8Cmyproc><span class=nav-number>7.4.</span> <span class=nav-text>mycpu和myproc</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92><span class=nav-number>7.5.</span> <span class=nav-text>睡眠和唤醒</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%AE%A1%E9%81%93><span class=nav-number>7.6.</span> <span class=nav-text>管道</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%BF%9B%E7%A8%8B%E9%94%81><span class=nav-number>7.7.</span> <span class=nav-text>进程锁</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0-5><span class=nav-number>7.8.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F><span class=nav-number>8.</span> <span class=nav-text>文件系统</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%A6%82%E8%BF%B0><span class=nav-number>8.1.</span> <span class=nav-text>概述</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BC%93%E5%AD%98%E5%B1%82><span class=nav-number>8.2.</span> <span class=nav-text>缓存层</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%97%A5%E5%BF%97%E5%B1%82><span class=nav-number>8.3.</span> <span class=nav-text>日志层</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#block%E5%9D%97%E5%88%86%E9%85%8D%E5%99%A8><span class=nav-number>8.4.</span> <span class=nav-text>block块分配器</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#inode%E5%B1%82><span class=nav-number>8.5.</span> <span class=nav-text>inode层</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E5%A4%B9%E5%B1%82><span class=nav-number>8.6.</span> <span class=nav-text>文件夹层</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%9B%AE%E5%BD%95%E5%90%8D%E7%A7%B0><span class=nav-number>8.7.</span> <span class=nav-text>目录名称</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%B1%82><span class=nav-number>8.8.</span> <span class=nav-text>文件描述符层</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BB%83%E4%B9%A0-6><span class=nav-number>8.9.</span> <span class=nav-text>练习</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E9%99%84%E5%BD%95><span class=nav-number>9.</span> <span class=nav-text>附录</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#ch.1-unix-utilities%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81><span class=nav-number>9.1.</span> <span class=nav-text>CH.1 Unix utilities实验代码</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#sleep-1><span class=nav-number>9.1.1.</span> <span class=nav-text>sleep</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#pingpong-1><span class=nav-number>9.1.2.</span> <span class=nav-text>pingpong</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#primes-1><span class=nav-number>9.1.3.</span> <span class=nav-text>primes</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#find-1><span class=nav-number>9.1.4.</span> <span class=nav-text>find</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#xargs-1><span class=nav-number>9.1.5.</span> <span class=nav-text>xargs</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#ch.2-system-calls%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81><span class=nav-number>9.2.</span> <span class=nav-text>CH.2 system calls实验代码</span></a></ol></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=oz1010 class=site-author-image itemprop=image src=/images/avatar.jpg><p class=site-author-name itemprop=name>oz1010<div class=site-description itemprop=description>普通而有趣的技术员</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>17</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>13</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>4</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author animated"><span class=links-of-author-item> <a rel="noopener me" title="GitHub → https://github.com/oz1010" href=https://github.com/oz1010 target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item> <a rel="noopener me" title="E-Mail → mailto:alfdxl@163.com" href=mailto:alfdxl@163.com target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span></div><div class="cc-license animated" itemprop=license><a class=cc-opacity href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><img alt="Creative Commons" src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg></a></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://oz1010.github.com/2024/04/24/Xv6-RISC-V%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="Xv6-RISC-V阅读笔记 | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Xv6-RISC-V阅读笔记</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-24 09:44:41" datetime=2024-04-24T09:44:41+08:00>2024-04-24</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 17:48:33" datetime=2025-08-25T17:48:33+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Xv6/ itemprop=url rel=index><span itemprop=name>Xv6</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>6.4k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>23 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><p><a href=https://pdos.csail.mit.edu/6.828/2023/xv6/book-riscv-rev3.pdf rel=noopener target=_blank>参考原文</a><h1 id=chapter-1-系统接口>Chapter 1 系统接口</h1><h2 id=unix-utilities实验>Unix utilities实验</h2><p><a href=https://pdos.csail.mit.edu/6.828/2023/labs/util.html rel=noopener target=_blank>实验说明</a><h3 id=启动系统>启动系统</h3><h3 id=sleep>sleep</h3><p>重点：使用<code>user/user.h</code>的sleep接口实现，单位为jiffies(1/10)。<h3 id=pingpong>pingpong</h3><p>重点：使用pip接口通信。<h3 id=primes>primes</h3><p>目的：主进程准备好2-35的数字写入管道。<p>从管道中读取数字n（此数字为素数），创建一个子进程，并将剩余的非n的倍数的数写入子管道中。然后进程等待子进程的退出。子进程会重复父进程的动作，直到读取的数字到达35，则不再创建子进程。<h3 id=find>find</h3><p>重点：熟悉文件属性读取，和路径拼接。<h3 id=xargs>xargs</h3><p>重点：使用exec接口实现，并需要构建新的参数数组。<h1 id=chapter-2-系统结构>Chapter 2 系统结构</h1><blockquote><p>RISC-V has three modes in which the CPU can execute instructions: machine mode, supervisor mode, and user mode.</blockquote><blockquote><p>An application can execute only user-mode instructions and is said to be running in user space, while the software in supervisor mode can also execute privileged instructions and is said to be running in kernel space.</blockquote><blockquote><p>CPUs provide a special instruction ( RISC-V provides the <code>ecall</code> instruction ) that switches the CPU from user mode to supervisor mode and enters the kernel at an entry point specified by the kernel.</blockquote><blockquote><p>the entire operating system resides in the kernel, so that the implementations of all system calls run in supervisor mode. This organization is called a monolithic kernel.</blockquote><blockquote><p>OS designers can minimize the amount of operating system code that runs in supervisor mode, and execute the bulk of the operating system in user mode. This kernel organization is called a microkernel.</blockquote><p>源码文件功能描述如下<table><thead><tr class=header><th>文件名<th>功能描述<tbody><tr class=odd><td>bio.c<td>Disk block cache for the file system.<tr class=even><td>console.c<td>Connect to the user keyboard and screen.<tr class=odd><td>entry.S<td>Very first boot instructions.<tr class=even><td>exec.c<td>exec() system call.<tr class=odd><td>file.c<td>File descriptor support.<tr class=even><td>fs.c<td>File system.<tr class=odd><td>kalloc.c<td>Physical page allocator.<tr class=even><td>kernelvec.S<td>Handle traps from kernel, and timer interrupts.<tr class=odd><td>log.c<td>File system logging and crash recovery.<tr class=even><td>main.c<td>Control initialization of other modules during boot.<tr class=odd><td>pipe.c<td>Pipes.<tr class=even><td>plic.c<td>RISC-V interrupt controller.<tr class=odd><td>printf.c<td>Formatted output to the console.<tr class=even><td>proc.c<td>Processes and scheduling.<tr class=odd><td>sleeplock.c<td>Locks that yield the CPU.<tr class=even><td>spinlock.c<td>Locks that don’t yield the CPU.<tr class=odd><td>start.c<td>Early machine-mode boot code.<tr class=even><td>string.c<td>C string and byte-array library.<tr class=odd><td>swtch.S<td>Thread switching.<tr class=even><td>syscall.c<td>Dispatch system calls to handling function.<tr class=odd><td>sysfile.c<td>File-related system calls.<tr class=even><td>sysproc.c<td>Process-related system calls.<tr class=odd><td>trampoline.S<td>Assembly code to switch between user and kernel.<tr class=even><td>trap.c<td>C code to handle and return from traps and interrupts.<tr class=odd><td>uart.c<td>Serial-port console device driver.<tr class=even><td>virtio_disk.c<td>Disk device driver.<tr class=odd><td>vm.c<td>Manage page tables and address spaces.</table><p>进程虚拟空间分布<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>地址    功能域</span><br><span class=line></span><br><span class=line>MAXVA   &lt;---------></span><br><span class=line>        trampoline</span><br><span class=line>        &lt;---------></span><br><span class=line>        trapframe</span><br><span class=line>        &lt;---------></span><br><span class=line>        heap</span><br><span class=line>        &lt;---------></span><br><span class=line>        user stack</span><br><span class=line>        &lt;---------></span><br><span class=line>        user text</span><br><span class=line>        and data</span><br><span class=line>        (followed by global variables)</span><br><span class=line>        (Instructions come first)</span><br><span class=line>0       &lt;---------></span><br></pre></table></figure><p>risc-v指针宽度为64位，但硬件只使用低39位用于在页表中寻找虚拟地址，而xv6系统中只使用了38位。因此最大地址为<code>2^38 - 1=0x3f,ffff,ffff MAXVA</code>(kernel/riscv.h:363)<p>进程重要信息存储在<code>struct proc</code>(kernel/proc.h:85)<blockquote><p>RISC-V <code>ecall</code> instruction raises the hardware privilege level and changes the program counter to a kernel-defined entry point.</blockquote><p>When the system call completes, the kernel switches back to the user stack and returns to user space by calling the <code>sret</code> instruction, which lowers the hardware privilege level and resumes executing user instructions just after the system call instruction.<p>启动流程：<ul><li>boot loader将kernel加载到内存<code>0x8000 0000</code><li>在machine mode下，跳转到<code>_entry</code>(kernel/entry.S:7)，设置堆栈，并跳转运行C代码<li>在C代码入口函数<code>start</code>(kernel/start.c:21)中，切换到supervisor mode，配置时钟中断，并跳转到主函数。<li>在主函数<code>main</code>(kernel/main.c:11)中，初始化设备和子系统，创建第一个进程<li>在初始化进程<code>userinit</code>(kernel/proc.c:233)中，寄存器a7装载<code>SYS_EXEC</code>(kernel/syscall.h:8)后再次进入内核<li>在内核系统调用处理函数<code>syscall</code>(kernel/syscall.c:132)中，启动<code>/init</code>进程<li>系统调用完成后，返回进程<code>init</code>(user/init.c)，创建一个新console设备文件，并打开文件描述符0,1,2。</ul><blockquote><p>it sets the previous privilege mode to supervisor in the register mstatus, it sets the return address to main by writing main’s address into the register mepc, disables virtual address translation in supervisor mode by writing 0 into the page-table register satp, and delegates all interrupts and exceptions to supervisor mode.</blockquote><h2 id=system-call实验>system call实验</h2><h3 id=system-call-tracing>System call tracing</h3><p>新增一个<code>trace</code>系统调用，它接收一个整数参数，它表明哪些系统调用被标记。当被标记的系统调用返回时，需要打印<code>&lt;pid>: syscall &lt;call name> -> &lt;return value></code>。此标记对子进程和forks都有效，但对其他进程无效。<p>关键点<ul><li><code>user/trace.c</code>中设置调用<code>trace(x)</code>后需要再<code>trace(0)</code>清空进程标记；<li><code>user/user.h</code>中增加用户调用系统函数<code>int trace(int sys_mask);</code>，<code>user/usys.pl</code>增加<code>trace</code>生成相关汇编代码；<li><code>kernel/syscall.h</code>新增宏编号<code>#define SYS_trace 22</code>，<code>kernel/sysproc.c</code>新增标记实现函数<code>uint64 sys_trace(void)</code><li><code>syscall</code>增加标记打印逻辑，需要注意<code>allocproc</code>中共用<code>struct proc proc[NPROC];</code>，申请后要清空之前的标记；</ul><h3 id=sysinfo>Sysinfo</h3><p>新增一个<code>sysinfo</code>系统调用，它会收集系统空闲内存字节大小<code>freemem</code>和正在使用的进程数量<code>nproc</code>。需要提供用户测试程序<code>sysinfotest</code>调用这个接口，若整个调用没有问题，则打印<code>"sysinfotest: OK"</code>。<p>关键点<ul><li>需要使用接口<code>copyout</code>将内核空间的数据拷贝到用户空间中</ul><h2 id=练习>练习</h2><ol type=1><li>增加一个系统调用，返回系统剩余可用内存大小</ol><h1 id=chapter-3-页表>Chapter 3 页表</h1><h2 id=创建地址空间>创建地址空间</h2><p>核心的数据结构<code>pagetable_t kernel_pagetable</code>(kernel/vm.c:1)中，核心的功能函数是<code>walk</code>，用于查找虚拟地址对应的PTE。<p><code>main</code>中调用<code>kvminit</code>(kernel/vm.c:54)创建内核页表，再调用<code>kvmmake</code>，最终通过<code>kvmmap</code>、<code>mappages</code>和<code>walk</code>完成物理地址虚拟地址映射。<p><code>main</code>中调用<code>kvminithart</code>(kernel/vm.c:62)安装内核页表。主要讲根页表的地址设置到<code>satp</code>寄存器中，设置前后需要刷新<code>TLB</code>缓存。<blockquote><p>The RISC-V has an instruction sfence.vma that flushes the current CPU’s TLB. Xv6 executes sfence.vma in kvminithart after reloading the satp register</blockquote><h2 id=物理内存分配>物理内存分配</h2><p>分配器定义在<code>kalloc.c</code>(kernel/kalloc.c:1)。每个空闲页的列表元素都是一个<code>struct run</code>。<p><code>main</code>中调用<code>kinit</code>(kernel/kalloc.c:27)来初始化分配器。它将初始化空闲列表<code>kmem->freelist</code>(kernel/kalloc.c:21)用于保存内核结束位置到<code>PHYSTOP</code>区间的每一页。<h2 id=进程地址空间>进程地址空间</h2><p>每个进程都有独立的页表。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>MAXVA   &lt;---------></span><br><span class=line>        trampoline  RX--</span><br><span class=line>        &lt;---------></span><br><span class=line>        trapframe   R-W-</span><br><span class=line>        &lt;---------></span><br><span class=line>        unused</span><br><span class=line>        &lt;---------></span><br><span class=line>        heap        R-WU</span><br><span class=line>        &lt;---------></span><br><span class=line>        stack       R-WU</span><br><span class=line>        &lt;---------></span><br><span class=line>        guard page</span><br><span class=line>        &lt;---------></span><br><span class=line>        data        R-WU</span><br><span class=line>        &lt;---------></span><br><span class=line>        unused</span><br><span class=line>        &lt;---------></span><br><span class=line>        text        RX-U</span><br><span class=line>0       &lt;---------></span><br></pre></table></figure><p>一个进程的用户内存从虚拟地址零开始，可以增长到<code>MAXVA</code>(kernel/riscv.h:360)，允许最大使用256GB内存。<p>零地址放置的text代码，没有写入权限，当异常的程序试图向零地址写入数据，会出发<code>page fault</code>。<h2 id=sbrk>sbrk</h2><p><code>sbrk</code>是进程为调整内存时的系统调用。它由函数<code>growproc</code>(kernel/proc.c:260)实现。<h2 id=exec>exec</h2><p><code>exec</code>是一个系统调用，它可以用从文件读取的数据替换进程用户空间数据，这样的文件被称为二进制或可行性文件。函数<code>exec</code>(kernel/exec.c:23)会读取并解析ELF格式的文件，它包含<code>struct elfhdr</code>ELF文件头部和一系列<code>struct proghdr</code>程序区域头部。每个程序区域头部描述程序必须加载到内存的位置。<p><code>/init</code>程序区域头部像下面这样<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>$ objdump -p user/_init </span><br><span class=line></span><br><span class=line>user/_init:     file format elf64-little</span><br><span class=line></span><br><span class=line>Program Header:</span><br><span class=line>0x70000003 off    0x0000000000006bac vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**0</span><br><span class=line>         filesz 0x0000000000000033 memsz 0x0000000000000000 flags r--</span><br><span class=line>    LOAD off    0x0000000000001000 vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**12</span><br><span class=line>         filesz 0x0000000000001000 memsz 0x0000000000001000 flags r-x</span><br><span class=line>    LOAD off    0x0000000000002000 vaddr 0x0000000000001000 paddr 0x0000000000001000 align 2**12</span><br><span class=line>         filesz 0x0000000000000010 memsz 0x0000000000000030 flags rw-</span><br><span class=line>   STACK off    0x0000000000000000 vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**4</span><br><span class=line>         filesz 0x0000000000000000 memsz 0x0000000000000000 flags rw-</span><br></pre></table></figure><p>值得注意的是，头部信息中<code>filesz</code>可能会小于<code>memsz</code>，那时因为这些变量值为0，文件中无需存储，但加载时需要申请<code>memsz</code>大小的空间并清零。<p>然后，函数需要拷贝参数列表，并将堆栈和PC设置好。最后将释放旧页表，使用新页表。<h2 id=练习-1>练习</h2><ol type=1><li>解析riscv的设备树，找出总共拥有多少物理内存<li>写一个用户程序调用<code>sbrk(1)</code>，观察调用前后页表的变化。内核申请了多少空间？新内存的PTE包含哪些数据？<li>修改源码让内核使用超级页<li>在Unix系统中，若<code>exec</code>处理的可执行文件以<code>#!</code>开头，则会使用第一行剩余部分替换程序作为解释文件执行。修改源码让内核支持这个特性。<li>实现一个地址空间随机分布的内核。</ol><h1 id=chapter-4-traps和系统调用>Chapter 4 traps和系统调用</h1><h2 id=riscv的trap机制>riscv的trap机制</h2><blockquote><p>Each RISC-V CPU has a set of control registers that the kernel writes to tell the CPU how to handle traps, and that the kernel can read to find out about a trap that has occurred.</blockquote><p>在文件<code>riscv.h</code>(kernel/riscv.h:1)中包含系统用到的所有描述。这里列举最重要的寄存器<ul><li><code>stvec</code>: 内核写入trap处理程序的地址<li><code>sepc</code>: 当trap发生时，处理器会保存<code>pc</code>；当从trap返回时，调用<code>sret</code>会从此寄存器恢复<code>pc</code>。<li><code>scause</code>: 处理器会存放一个数字描述trap的原因<li><code>sscratch</code>: trap处理程序使用<code>sscratch</code>来避免改写用户寄存器<li><code>sstatus</code>: SIE位控制设备中断是否使能；SPP位指示trap触发前是user mode还是supervisor mode；</ul><p>xv6只将它们使用在计时器中断的特殊场景<p>硬件处理所有类型trap流程：<ul><li>若<code>sstatus</code>的SIE位被清零，则后面的步骤略过<li><code>sstatus</code>的SIE位清零<li>拷贝<code>pc</code>值到<code>sepc</code><li>保存当前模式到<code>sstatus</code>的SPP位<li>设置<code>scause</code><li>模式切换为supervisor mode<li>拷贝<code>stvec</code>到<code>pc</code><li>继续从<code>pc</code>处开始执行</ul><blockquote><p>Note that the CPU doesn’t switch to the kernel page table, doesn’t switch to a stack in the kernel, and doesn’t save any registers other than the pc.</blockquote><h2 id=用户空间的traps流程>用户空间的traps流程</h2><p>用户空间trap路径是：<code>uservec</code>(kernel/trampoline.S:21)-><code>usertrap</code>(kernel/trap.c:37)-return-><code>usertrapret</code>(kernel/trap.c:90)->userret(kernel/trampoline.S:101)<p>xv6使用trampoline页来存储<code>stvec</code>，它页包含<code>uservec</code>。trampoline页会被每个进程映射到TRAMPOLINE的地址处。<p><code>uservec</code>函数会将32个用户寄存器存储到TRAPFRAME地址所在的<code>trapframe</code>结构中，然后将寄存器<code>satp</code>切换为内核页表，再调用<code>usertrap</code>函数。<p><code>usertrap</code>(kernel/trap.c:37)函数会检测trap的原因并处理它。首先将设置<code>stvec</code>为<code>kernelvec</code>，以便处理内核trap。保存<code>sepc</code>寄存器。如果trap是系统调用，则调用<code>syscall</code>处理它；若是设备中断，<code>devintr</code>处理它；否则，是一种异常场景，调用内核终止异常的进程。若是系统调用，则在函数结束时会调用<code>usertrapret</code><p>返回用户空间的第一步是调用<code>usertrapret</code>(kernel/trap.c:90)。它会将<code>stvec</code>设置回<code>uservec</code>，<code>uservec</code>的映射地址可以通过TRAMPOLINE、trampoline和uservec计算出来（注意内核中这些是物理地址）。然后恢复<code>pc</code>，最后调用<code>userret</code>函数并将<code>a0</code>设置为用户页表。<p><code>userret</code>(kernel/trampoline.S:101)函数将切换<code>satp</code>为用户页表，并恢复32个用户寄存器。最后调用<code>sret</code>返回用户空间。<h2 id=系统调用流程>系统调用流程</h2><p>以initcode.S中第一个系统调用<code>exec</code>为例。<p>initcode.S在寄存器<code>a0</code>和<code>a1</code>存放着<code>exec</code>的参数，并将系统调用编号存放在<code>a7</code>中。根据系统调用编号在<code>syscalls</code>(kernel/syscall.c:107)数组中匹配到处理函数。指令<code>ecall</code>会触发trap切换到内核中并引发<code>uservec</code>、<code>usertrap</code>和<code>syscall</code>执行。<h2 id=系统调用参数列表>系统调用参数列表</h2><p>内核trap代码将用户寄存器放在当前进程的trap frame上，可以通过内核函数<code>argint</code>、<code>argaddr</code>和<code>argfd</code>返回第n个参数，它们通过调用<code>argraw</code>实现(kernel/syscall.c:34)。<p>有些参数通过用户地址传递，<code>fechstr</code>(kernel/syscall.c:25)函数能够拷贝用户传递的字符串。<h2 id=内核空间的traps流程>内核空间的traps流程</h2><p>内核空间trap路径是：<code>kernelvec</code>(kernel/kernelvec.S:12)-><code>kerneltrap</code>(kernel/trap.c:135)-><code>kernelvec</code>(kernel/kernelvec.S:12)<p>若trap不是设备中断，则异常会直接导致xv6内核出panic。<p>当处理器遇到trap进入内核空间时，总会禁用中断，直到设置<code>stvec</code>后。<h2 id=缺页异常>缺页异常</h2><p>若发生在用户空间，内核将终止相关进程。若发生在内核空间，则会直接panic。<p>许多内核利用缺页异常来实现写时复制（copy-on-write, COW）机制。COW fork的基本方法是，为父进程和子进程初始化共享所有物理页，但将他们的全部设置为只读。当进程向某页写入数据时，会触发store page faults。此时内核需要重新申请新的一页将数据拷贝过来，并再次进行映射。一个重要的优化项是，对于缺页发生在仅从该进程中引用的，无需进行拷贝。<p>另一个广泛使用的特性是惰性分配（lazy allocation）。当一个应用调用<code>sbrk</code>请求更多内存，内核只调整其使用大小，但不会申请物理内存和创建PTEs。当这些新地址被访问时，才会申请对应的内存页并完成映射。<p>还有一个广泛使用的特性是需求分页（demand paging）。当大型程序启动时，内核无需将所有数据加载到内存中，而仅仅配置足够的用户地址空间，并将其设置为无效。当发生页错误时，内核将页的内容读入并映射到用户空间。<p>为应对程序运行时需要的空间比硬件RAM大的场景，操作系统可以实现磁盘映射（paging to disk）。<h2 id=练习-2>练习</h2><ol type=1><li>配置内核页表，让内核可以直接使用用户空间地址；<li>实现惰性内存分配机制；<li>实现COW fork；<li>是否有方法消除TRAPFRAME页映射到每个用户地址空间？比如，修改<code>uservec</code>函数将32个用户寄存器存入内核栈，或将其存入<code>proc</code>结构中？<li>是否有方法消除TRAMPOLINE页映射？</ol><h1 id=中断和设备驱动>中断和设备驱动</h1><p>在xv6中，内核trap会处理和识别设备中断，最终交于<code>devintr</code>(kernel/trap.c:178)。<blockquote><p>Many device drivers execute code in two contexts: a top half that runs in a process’s kernel thread, and a bottom half that executes at interrupt time.</blockquote><h2 id=终端输入>终端输入</h2><p>终端驱动(kernel/console.c)是一个简单的驱动框架的示例。<blockquote><p>The UART hardware that the driver talks to is a 16550 chip [13] emulated by QEMU. On a real computer, a 16550 would manage an RS232 serial link connecting to a terminal or other computer. When running QEMU, it’s connected to your keyboard and display.</blockquote><p>UART的基地址是0x10000000(UART0, kernel/memlayout.h:21)，UART0各寄存器定义在文件(kernel/uart.c:22)中。<p>xv6的<code>main</code>调用<code>consoleinit</code>(kernel/console.c:182)函数，然后再调用<code>uartinit</code>(kernel/uart.c:53)函数来初始化UART硬件。<p>在init.c(user/init.c:19)打开的文件描述符，它能够读取xv6的命令。调用<code>read</code>系统调用，通过内核来调用<code>consoleread</code>(kernel/console.c:80)。它会一直等待中断并缓存数据到<code>cons.buf</code>中，直到整个行输入完成，会将缓存中数据拷贝给用户最终返回到用户空间。<p>当用户输入一个字符，UART硬件设备会想处理器产生一个中断，它会激活xv6的trap处理程序。设备中断最后会调用<code>devintr</code>(kernel/trap.c:178)进行处理。接着，通过PLIC硬件单元来分辨是哪个设备中断，如果是UART设备<code>devintr</code>会调用<code>uartintr</code>。<p><code>uartintr</code>(kernel/uart.c:176)会从UART硬件读取任意输入字符，并交于<code>consoleintr</code>(kernel/console.c:136)进行处理；<code>consoleintr</code>的任务就是将输入放到<code>cons.buf</code>，直到整行输入完成，立即唤醒<code>consoleread</code>。<h2 id=终端输出>终端输出</h2><p>在一个连接到终端的文件描述符的<code>write</code>系统调用，最终会调用<code>uartputc</code>(kernel/uart.c:87)。对于每个字符，会调用<code>uartstart</code>来开启设备发送。<h2 id=驱动的并发>驱动的并发</h2><blockquote><p>These calls acquire a lock, which protects the console driver’s data structures from concurrent access.</blockquote><h2 id=计时器中断>计时器中断</h2><blockquote><p>Xv6 uses timer interrupts to maintain its clock and to enable it to switch among compute-bound processes; the yield calls in usertrap and kerneltrap cause this switching.</blockquote><blockquote><p>RISC-V requires that timer interrupts be taken in machine mode, not supervisor mode.</blockquote><p>代码在start.c配置接收计时器中断(kernel/start.c:63)。部分工作的目的是编写CLINT硬件（core-local interruptor），在特定延时后产生一个中断。最终，<code>start</code>配置<code>mtvec</code>到<code>timervec</code>并使能计时器中断。<blockquote><p>A timer interrupt can occur at any point when user or kernel code is executing; there’s no way for the kernel to disable timer interrupts during critical operations.</blockquote><blockquote><p>The basic strategy is for the handler to ask the RISC-V to raise a “software interrupt” and immediately return.</blockquote><p>在machine mode的中断处理程序是<code>timervec</code>(kernel/kernelvec.S:95)，它主要配置CLINT的<code>MTIMECMP</code>寄存器，并设置<code>sip</code>为2后立刻返回。<h2 id=练习-3>练习</h2><ol type=1><li>修改uart.c完全不使用中断，同时也需要修改console.c<li>增加一个以太网卡驱动</ol><h1 id=chapter-6-锁>Chapter 6 锁</h1><blockquote><p>Xv6 uses a number of concurrency control techniques, depending on the situation; many more are possible. This chapter focuses on a widely used technique: the lock.</blockquote><h2 id=竞争>竞争</h2><h2 id=锁>锁</h2><blockquote><p>On the RISC-V this instruction is <code>amoswap r, a</code>. <code>amoswap</code> reads the value at the memory address <code>a</code>, writes the contents of register <code>r</code> to that address, and puts the value it read into <code>r</code>.</blockquote><blockquote><p>It performs this sequence atomically, using special hardware to prevent any other CPU from using the memory address between the read and the write.</blockquote><blockquote><p>Xv6’s acquire (kernel/spinlock.c:22) uses the portable C library call __sync_lock_test_and_set, which boils down to the amoswap instruction; the return value is the old (swapped) contents of lk->locked.</blockquote><p><code>acquire</code>(kernel/spinlock.c:22)利用riscv处理器的指令<code>amoswap.w.aq a0, a0, (s1)</code>实现。当获取锁成功时<code>lk->locked</code>为1。<p><code>release</code>(kernel/spinlock.c:47)利用riscv处理器的指令<code>amoswap.w zero, zero, (s1)</code>实现。当释放锁成功时<code>lk->locked</code>为0。<h2 id=使用锁>使用锁</h2><blockquote><p>A hard part about using locks is deciding how many locks to use and which data and invariants each lock should protect.</blockquote><h2 id=再入锁>再入锁</h2><blockquote><p>It might appear that some deadlocks and lock-ordering challenges could be avoided by using re-entrant locks, which are also called recursive locks. The idea is that if the lock is held by a process and if that process attempts to acquire the lock again, then the kernel could just allow this (since the process already has the lock), instead of calling panic, as the xv6 kernel does.</blockquote><h2 id=锁和中断处理程序>锁和中断处理程序</h2><blockquote><p>Some xv6 spinlocks protect data that is used by both threads and interrupt handlers.</blockquote><blockquote><p>To avoid this situation, if a spinlock is used by an interrupt handler, a CPU must never hold that lock with interrupts enabled.</blockquote><p>例如，<code>clockintr</code>计时器中断处理会增加<code>ticks</code>(kernel/trap.c:164)，同时内核线程<code>sys_sleep</code>(kernel/sysproc.c:59)会读取<code>ticks</code>的值。锁<code>tickslock</code>会让两次访问串行化。<h2 id=指令和内存顺序>指令和内存顺序</h2><blockquote><p>It is natural to think of programs executing in the order in which source code statements appear. That’s a reasonable mental model for single-threaded code, but is incorrect when multiple threads interact through shared memory.</blockquote><blockquote><p>To tell the hardware and compiler not to re-order, xv6 uses __sync_synchronize() in both acquire (kernel/spinlock.c:22) and release (kernel/spinlock.c:47). __sync_synchronize() is a memory barrier: it tells the compiler and CPU to not reorder loads or stores across the barrier.</blockquote><h2 id=睡眠锁>睡眠锁</h2><blockquote><p>Xv6 provides such locks in the form of sleep-locks. acquiresleep (kernel/sleeplock.c:22) yields the CPU while waiting</blockquote><h2 id=练习-4>练习</h2><ol type=1><li>若屏蔽<code>kalloc</code>(kernel/kalloc.c:69)<code>acquire</code>和<code>release</code>的调用，会出现哪些问题？若没有看到问题，原因是什么？<li>在<code>kfree</code>中屏蔽锁（恢复<code>kalloc</code>中的锁），会出现哪些问题？<li>修改<code>kalloc.c</code>源码让内存申请支持并发，CPU不用相互等待。<li>使用POSIX线程进行编码。例如，实现一个并行哈希表并测试<code>puts/gets</code>数据量是否随着核数量的增加而增加。<li>在xv6中实现pthreads的子集。实现一个用户级的线程库，这样一个用户进程就可以有多个线程，并安排这些线程运行在不同的cpu上并行运行。想出一个设计，正确地处理一个线程进行阻塞系统调用，并改变其共享地址空间。</ol><h1 id=调度>调度</h1><h2 id=复用>复用</h2><blockquote><p>Xv6 multiplexes by switching each CPU from one process to another in two situations. First, xv6’s sleep and wakeup mechanism switches when a process waits for device or pipe I/O to complete, or waits for a child to exit, or waits in the sleep system call. Second, xv6 periodically forces a switch to cope with processes that compute for long periods without sleeping.</blockquote><h2 id=上下文切换>上下文切换</h2><blockquote><p>it just saves and restores sets of 32 RISC-V registers, called contexts.</blockquote><p>当进程想放弃CPU时，内核线程会调用<code>swtch</code>来保存它的上下文并返回调度器上下文。每个上下文都包含在<code>struct context</code>(kernel/proc.h:2)，进程的<code>struct proc</code>和CPU的<code>struct cpu</code>都包含上下文。<p><code>swtch</code>(kernel/swtch.S:3)只保存被调用者保存的寄存器。C编译器会生成代码保存调用者保存的寄存器到栈上。<blockquote><p>When swtch returns, it returns to the instructions pointed to by the restored ra register, that is, the instruction from which the new thread previously called swtch.</blockquote><h2 id=调度-1>调度</h2><p>当调用函数<code>swtch</code>后，会切换到调度器的栈。调度器会继续在循环中查找可以切换的进程，并再次调用<code>swtch</code>进行切换。<blockquote><p>We just saw that xv6 holds p->lock across calls to swtch: the caller of swtch must already hold the lock, and control of the lock passes to the switched-to code.</blockquote><h2 id=mycpu和myproc>mycpu和myproc</h2><blockquote><p>Xv6 maintains a struct cpu for each CPU (kernel/proc.h:22), which records the process currently running on that CPU (if any), saved registers for the CPU’s scheduler thread, and the count of nested spinlocks needed to manage interrupt disabling.</blockquote><blockquote><p>RISC-V numbers its CPUs, giving each a hartid. Xv6 ensures that each CPU’s hartid is stored in that CPU’s tp register while in the kernel. This allows mycpu to use tp to index an array of cpu structures to find the right one.</blockquote><blockquote><p>It would be more convenient if xv6 could ask the RISC-V hardware for the current hartid whenever needed, but RISC-V allows that only in machine mode, not in supervisor mode.</blockquote><blockquote><p>The return value of myproc is safe to use even if interrupts are enabled: if a timer interrupt moves the calling process to a different CPU, its struct proc pointer will stay the same.</blockquote><h2 id=睡眠和唤醒>睡眠和唤醒</h2><blockquote><p>Sleep and wakeup are often called sequence coordination or conditional synchronization mechanisms.</blockquote><h2 id=管道>管道</h2><blockquote><p>A more complex example that uses sleep and wakeup to synchronize producers and consumers is xv6’s implementation of pipes. Each pipe is represented by a struct pipe, which contains a lock and a data buffer.</blockquote><blockquote><p>Let’s suppose that calls to piperead and pipewrite happen simultaneously on two different CPUs.</blockquote><h2 id=进程锁>进程锁</h2><blockquote><p>The lock associated with each process (p->lock) is the most complex lock in xv6. A simple way to think about p->lock is that it must be held while reading or writing any of the following struct proc fields: p->state, p->chan, p->killed, p->xstate, and p->pid.</blockquote><h2 id=练习-5>练习</h2><ol type=1><li></ol><h1 id=文件系统>文件系统</h1><h2 id=概述>概述</h2><blockquote><p>The xv6 file system implementation is organized in seven layers</blockquote><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>&lt;----------------></span><br><span class=line>File descriptor</span><br><span class=line>&lt;----------------></span><br><span class=line>Pathname</span><br><span class=line>&lt;----------------></span><br><span class=line>Directory</span><br><span class=line>&lt;----------------></span><br><span class=line>Inode</span><br><span class=line>&lt;----------------></span><br><span class=line>Logging</span><br><span class=line>&lt;----------------></span><br><span class=line>Buffer cache</span><br><span class=line>&lt;----------------></span><br><span class=line>Disk</span><br><span class=line>&lt;----------------></span><br></pre></table></figure><blockquote><p>Disk hardware traditionally presents the data on the disk as a numbered sequence of 512-byte blocks (also called sectors): sector 0 is the first 512 bytes, sector 1 is the next, and so on.</blockquote><blockquote><p>The file system does not use block 0 (it holds the boot sector). Block 1 is called the superblock; it contains metadata about the file system (the file system size in blocks, the number of data blocks, the number of inodes, and the number of blocks in the log). Blocks starting at 2 hold the log. After the log are the inodes, with multiple inodes per block. After those come bitmap blocks tracking which data blocks are in use. The remaining blocks are data blocks</blockquote><p>xv6文件系统结构<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>0       &lt;----------------></span><br><span class=line>        boot</span><br><span class=line>1       &lt;----------------></span><br><span class=line>        super</span><br><span class=line>2       &lt;----------------></span><br><span class=line>        log</span><br><span class=line></span><br><span class=line>        &lt;----------------></span><br><span class=line>        inodes</span><br><span class=line></span><br><span class=line></span><br><span class=line>        &lt;----------------></span><br><span class=line>        bit map</span><br><span class=line>        &lt;----------------></span><br><span class=line>        data</span><br><span class=line></span><br><span class=line>        ....</span><br><span class=line></span><br><span class=line>        data</span><br><span class=line>        &lt;----------------></span><br></pre></table></figure><h2 id=缓存层>缓存层</h2><p>代码在<code>bio.c</code>中，缓存层有两个任务<ul><li>同步访问硬盘块block。确保只有一个块的副本在内存中，且同一时间只有一个内核线程在使用它。<li>缓存热门数据块block。</ul><blockquote><p>The main interface exported by the buffer cache consists of bread and bwrite. A kernel thread must release a buffer by calling brelse when it is done with it.</blockquote><blockquote><p>bread (kernel/bio.c:93) calls bget to get a buffer for the given sector (kernel/bio.c:97).</blockquote><blockquote><p>When the caller is done with a buffer, it must call brelse to release it.</blockquote><h2 id=日志层>日志层</h2><blockquote><p>One of the most interesting problems in file system design is crash recovery.</blockquote><blockquote><p>Xv6 solves the problem of crashes during file-system operations with a simple form of logging.</blockquote><blockquote><p>Once the system call has logged all of its writes, it writes a special commit record to the disk indicating that the log contains a complete operation. At that point the system call copies the writes to the on-disk file system data structures. After those writes have completed, the system call erases the log on disk.</blockquote><h2 id=block块分配器>block块分配器</h2><blockquote><p>File and directory content is stored in disk blocks, which must be allocated from a free pool. Xv6’s block allocator maintains a free bitmap on disk, with one bit per block.</blockquote><h2 id=inode层>inode层</h2><blockquote><p>It might refer to the on-disk data structure containing a file’s size and list of data block numbers. Or “inode” might refer to an in-memory inode</blockquote><p>磁盘上数据展现形式<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>dinode</span><br><span class=line>|----------------|</span><br><span class=line>type</span><br><span class=line>|----------------|</span><br><span class=line>major</span><br><span class=line>|----------------|</span><br><span class=line>minor</span><br><span class=line>|----------------|</span><br><span class=line>nlink</span><br><span class=line>|----------------|</span><br><span class=line>size</span><br><span class=line>|----------------|</span><br><span class=line>address 1           -->     data0_1</span><br><span class=line>|----------------|</span><br><span class=line>...</span><br><span class=line>|----------------|</span><br><span class=line>address 12          -->     data0_12</span><br><span class=line>|----------------|</span><br><span class=line>indirect            -->     indirect block</span><br><span class=line>|----------------|          |----------------|</span><br><span class=line>                            address 1           -->     data1_1</span><br><span class=line>                            |----------------|</span><br><span class=line>                            ...</span><br><span class=line>                            |----------------|</span><br><span class=line>                            address 256         -->     data1_256</span><br><span class=line>                            |----------------|</span><br></pre></table></figure><h2 id=文件夹层>文件夹层</h2><blockquote><p>A directory is implemented internally much like a file.</blockquote><h2 id=目录名称>目录名称</h2><h2 id=文件描述符层>文件描述符层</h2><blockquote><p>All the open files in the system are kept in a global file table, the ftable.</blockquote><blockquote><p>The functions sys_link and sys_unlink edit directories, creating or removing references to inodes. They are another good example of the power of using transactions.</blockquote><h2 id=练习-6>练习</h2><h1 id=附录>附录</h1><h2 id=ch.1-unix-utilities实验代码>CH.1 Unix utilities实验代码</h2><h3 id=sleep-1>sleep</h3><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/types.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"user/user.h"</span></span></span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>int</span> argc, <span class=type>char</span> *argv[])</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>int</span> seconds;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (argc &lt;= <span class=number>1</span>)</span><br><span class=line>    {</span><br><span class=line>        <span class=built_in>fprintf</span>(<span class=number>2</span>, <span class=string>"sleep: need one arg\n"</span>);</span><br><span class=line>        <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// ticks = 1/10 seconds</span></span><br><span class=line>    seconds = <span class=number>10</span> * atoi(argv[<span class=number>1</span>]);</span><br><span class=line>    <span class=keyword>if</span> (seconds &lt; <span class=number>0</span>)</span><br><span class=line>    {</span><br><span class=line>        seconds = <span class=number>0</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    sleep(seconds);</span><br><span class=line>    <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h3 id=pingpong-1>pingpong</h3><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/types.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"user/user.h"</span></span></span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>int</span> argc, <span class=type>char</span> *argv[])</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>int</span> p1[<span class=number>2</span>]; <span class=comment>// parent->child</span></span><br><span class=line>    <span class=type>int</span> p2[<span class=number>2</span>]; <span class=comment>// child->parent</span></span><br><span class=line>    pipe(p1);</span><br><span class=line>    pipe(p2);</span><br><span class=line>    <span class=keyword>if</span> (fork() == <span class=number>0</span>)</span><br><span class=line>    {</span><br><span class=line>        <span class=type>char</span> buffer[<span class=number>5</span>];</span><br><span class=line>        close(p1[<span class=number>1</span>]);</span><br><span class=line>        close(p2[<span class=number>0</span>]);</span><br><span class=line>        read(p1[<span class=number>0</span>], buffer, <span class=keyword>sizeof</span>(buffer));</span><br><span class=line>        <span class=built_in>printf</span>(<span class=string>"%d: received %s\n"</span>, getpid(), buffer);</span><br><span class=line>        write(p2[<span class=number>1</span>], <span class=string>"pong"</span>, <span class=number>5</span>);</span><br><span class=line>        close(p1[<span class=number>0</span>]);</span><br><span class=line>        close(p2[<span class=number>1</span>]);</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>else</span></span><br><span class=line>    {</span><br><span class=line>        <span class=type>char</span> buffer[<span class=number>5</span>];</span><br><span class=line>        close(p1[<span class=number>0</span>]);</span><br><span class=line>        close(p2[<span class=number>1</span>]);</span><br><span class=line>        write(p1[<span class=number>1</span>], <span class=string>"ping"</span>, <span class=number>5</span>);</span><br><span class=line>        read(p2[<span class=number>0</span>], buffer, <span class=keyword>sizeof</span>(buffer));</span><br><span class=line>        <span class=built_in>printf</span>(<span class=string>"%d: received %s\n"</span>, getpid(), buffer);</span><br><span class=line>        close(p1[<span class=number>1</span>]);</span><br><span class=line>        close(p2[<span class=number>0</span>]);</span><br><span class=line>    }</span><br><span class=line>    <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h3 id=primes-1>primes</h3><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/types.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"user/user.h"</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>define</span> MAX_NUMBER 35</span></span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>()</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>int</span> p0[<span class=number>2</span>]; <span class=comment>// parent->child</span></span><br><span class=line>    <span class=type>int</span> n, prime;</span><br><span class=line>    pipe(p0);</span><br><span class=line></span><br><span class=line>    <span class=comment>// feeds the numbers 2 through 35</span></span><br><span class=line>    <span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>2</span>; i &lt;= MAX_NUMBER; ++i)</span><br><span class=line>        write(p0[<span class=number>1</span>], &i, <span class=keyword>sizeof</span>(i));</span><br><span class=line></span><br><span class=line>    <span class=keyword>while</span> (read(p0[<span class=number>0</span>], &n, <span class=keyword>sizeof</span>(n)))</span><br><span class=line>    {</span><br><span class=line>        <span class=built_in>printf</span>(<span class=string>"%d prime %d\n"</span>, getpid(), n);</span><br><span class=line>        prime = n;</span><br><span class=line>        <span class=type>int</span> p1[<span class=number>2</span>]; <span class=comment>// child -> grandchild</span></span><br><span class=line>        pipe(p1);</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (fork() == <span class=number>0</span>)</span><br><span class=line>        {</span><br><span class=line>            <span class=comment>// child</span></span><br><span class=line>            close(p0[<span class=number>0</span>]);</span><br><span class=line>            close(p0[<span class=number>1</span>]);</span><br><span class=line>            p0[<span class=number>0</span>] = p1[<span class=number>0</span>];</span><br><span class=line>            p0[<span class=number>1</span>] = p1[<span class=number>1</span>];</span><br><span class=line>            <span class=keyword>continue</span>;</span><br><span class=line>        }</span><br><span class=line>        <span class=keyword>else</span></span><br><span class=line>        {</span><br><span class=line>            <span class=comment>// parent</span></span><br><span class=line>            <span class=keyword>while</span> (n &lt; MAX_NUMBER && read(p0[<span class=number>0</span>], &n, <span class=keyword>sizeof</span>(n)))</span><br><span class=line>                <span class=keyword>if</span> (n % prime != <span class=number>0</span>)</span><br><span class=line>                    write(p1[<span class=number>1</span>], &n, <span class=keyword>sizeof</span>(n));</span><br><span class=line></span><br><span class=line>            <span class=comment>// close all resources</span></span><br><span class=line>            close(p0[<span class=number>0</span>]);</span><br><span class=line>            close(p0[<span class=number>1</span>]);</span><br><span class=line>            close(p1[<span class=number>0</span>]);</span><br><span class=line>            close(p1[<span class=number>1</span>]);</span><br><span class=line>            <span class=comment>// wait children</span></span><br><span class=line>            <span class=keyword>if</span> (n &lt; MAX_NUMBER)</span><br><span class=line>                wait(<span class=number>0</span>);</span><br><span class=line>            <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    wait(<span class=number>0</span>);</span><br><span class=line>    <span class=built_in>printf</span>(<span class=string>"%d exit\n"</span>, getpid());</span><br><span class=line>    <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h3 id=find-1>find</h3><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/types.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"user/user.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/fs.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/stat.h"</span></span></span><br><span class=line></span><br><span class=line><span class=type>void</span> <span class="title function_">cmp_file</span><span class=params>(<span class=type>char</span> *path, <span class=type>char</span> *name)</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>char</span> *str1, *str2;</span><br><span class=line>    <span class=keyword>for</span> (str1 = path + <span class=built_in>strlen</span>(path), str2 = name + <span class=built_in>strlen</span>(name); str1 >= path && str2 >= name && *str1 == *str2; --str1, --str2)</span><br><span class=line>        ; <span class=comment>// printf("%c %c\n", *str1, *str2);</span></span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> ((<span class=type>int</span>)(str2 - name) == <span class=number>-1</span>)</span><br><span class=line>        <span class=built_in>printf</span>(<span class=string>"%s\n"</span>, path);</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=type>void</span> <span class="title function_">find</span><span class=params>(<span class=type>char</span> *path, <span class=type>char</span> *patern)</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>int</span> fd;</span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>dirent</span> <span class=title>de</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>stat</span> <span class=title>st</span>;</span></span><br><span class=line>    <span class=type>char</span> buf[<span class=number>512</span>], *p;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> ((fd = open(path, <span class=number>0</span>)) &lt; <span class=number>0</span>)</span><br><span class=line>    {</span><br><span class=line>        <span class=built_in>fprintf</span>(<span class=number>2</span>, <span class=string>"find: connot open %s\n"</span>, path);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (fstat(fd, &st) &lt; <span class=number>0</span>)</span><br><span class=line>    {</span><br><span class=line>        <span class=built_in>fprintf</span>(<span class=number>2</span>, <span class=string>"find: connot stat %s\n"</span>, path);</span><br><span class=line>        close(fd);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>switch</span> (st.type)</span><br><span class=line>    {</span><br><span class=line>    <span class=keyword>case</span> T_DEVICE:</span><br><span class=line>    <span class=keyword>case</span> T_FILE:</span><br><span class=line>        cmp_file(path, patern);</span><br><span class=line>        <span class=keyword>break</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>case</span> T_DIR:</span><br><span class=line>        <span class=keyword>if</span> (<span class=built_in>strlen</span>(path) + <span class=number>1</span> + DIRSIZ + <span class=number>1</span> > <span class=keyword>sizeof</span>(buf))</span><br><span class=line>        {</span><br><span class=line>            <span class=built_in>printf</span>(<span class=string>"find: path too long\n"</span>);</span><br><span class=line>            <span class=keyword>break</span>;</span><br><span class=line>        }</span><br><span class=line></span><br><span class=line>        <span class=built_in>strcpy</span>(buf, path);</span><br><span class=line>        p = buf + <span class=built_in>strlen</span>(buf);</span><br><span class=line>        <span class=keyword>if</span> (*(p - <span class=number>1</span>) != <span class=string>'/'</span>)</span><br><span class=line>            *p++ = <span class=string>'/'</span>;</span><br><span class=line>        <span class=keyword>while</span> (read(fd, &de, <span class=keyword>sizeof</span>(de)) == <span class=keyword>sizeof</span>(de))</span><br><span class=line>        {</span><br><span class=line>            <span class=keyword>if</span> (de.inum == <span class=number>0</span> || <span class=built_in>strcmp</span>(<span class=string>"."</span>, de.name) == <span class=number>0</span> || <span class=built_in>strcmp</span>(<span class=string>".."</span>, de.name) == <span class=number>0</span>)</span><br><span class=line>                <span class=keyword>continue</span>;</span><br><span class=line>            memmove(p, de.name, DIRSIZ);</span><br><span class=line>            p[DIRSIZ] = <span class=number>0</span>;</span><br><span class=line>            find(buf, patern);</span><br><span class=line>        }</span><br><span class=line>        <span class=keyword>break</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    close(fd);</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>int</span> argc, <span class=type>char</span> *argv[])</span></span><br><span class=line>{</span><br><span class=line>    <span class=keyword>if</span> (argc &lt;= <span class=number>2</span>)</span><br><span class=line>    {</span><br><span class=line>        <span class=built_in>fprintf</span>(<span class=number>2</span>, <span class=string>"find: need more args\n"</span>);</span><br><span class=line>        <span class=built_in>exit</span>(<span class=number>-1</span>);</span><br><span class=line>    }</span><br><span class=line>    find(argv[<span class=number>1</span>], argv[<span class=number>2</span>]);</span><br><span class=line>    <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h3 id=xargs-1>xargs</h3><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/types.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"kernel/param.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"user/user.h"</span></span></span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>int</span> argc, <span class=type>char</span> *argv[])</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>char</span> buffer[<span class=number>512</span>];</span><br><span class=line>    <span class=type>char</span> *newarg[MAXARG];</span><br><span class=line>    <span class=type>int</span> i;</span><br><span class=line>    <span class=type>int</span> new_idx;</span><br><span class=line>    <span class=keyword>for</span> (i = <span class=number>1</span>, new_idx = <span class=number>0</span>; i &lt; argc; ++i)</span><br><span class=line>        <span class=keyword>if</span> (argv[i][<span class=number>0</span>] == <span class=string>'-'</span>)</span><br><span class=line>            i += <span class=number>1</span>;</span><br><span class=line>        <span class=keyword>else</span></span><br><span class=line>            newarg[new_idx++] = argv[i];</span><br><span class=line>    <span class=keyword>while</span> (*gets(buffer, <span class=keyword>sizeof</span>(buffer)) != <span class=string>'\0'</span>)</span><br><span class=line>    {</span><br><span class=line>        buffer[<span class=built_in>strlen</span>(buffer) - <span class=number>1</span>] = <span class=string>'\0'</span>;</span><br><span class=line>        newarg[new_idx] = buffer;</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (fork() == <span class=number>0</span>)</span><br><span class=line>        {</span><br><span class=line>            exec(newarg[<span class=number>0</span>], newarg);</span><br><span class=line>            <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>        }</span><br><span class=line>        wait(<span class=number>0</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=built_in>exit</span>(<span class=number>0</span>);</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h2 id=ch.2-system-calls实验代码>CH.2 system calls实验代码</h2></div><footer class=post-footer><div class=post-copyright><ul><li class=post-copyright-author><strong>本文作者： </strong>oz1010<li class=post-copyright-link><strong>本文链接：</strong> <a href=https://oz1010.github.com/2024/04/24/Xv6-RISC-V%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/ title=Xv6-RISC-V阅读笔记>https://oz1010.github.com/2024/04/24/Xv6-RISC-V阅读笔记/</a><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</ul></div><div class=post-nav><div class=post-nav-item><a href=/2024/04/24/GDB%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/ rel=prev title=GDB使用说明> <i class="fa fa-angle-left"></i> GDB使用说明 </a></div><div class=post-nav-item><a href=/2024/04/24/Linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/ rel=next title=Linux驱动开发笔记> Linux驱动开发笔记 <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2025</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>oz1010</span></div><div class=wordcount><span class=post-meta-item> <span class=post-meta-item-icon> <i class="fa fa-chart-line"></i> </span> <span title=站点总字数>71k</span> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="fa fa-coffee"></i> </span> <span title=站点阅读时长>4:19</span> </span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript>