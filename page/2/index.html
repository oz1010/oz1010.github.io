<!doctype html><html lang=zh-CN><meta charset=UTF-8><meta content="width=device-width" name=viewport><meta content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/icon-180.png rel=apple-touch-icon sizes=180x180><link href=/images/icon-32.png rel=icon sizes=32x32 type=image/png><link href=/images/icon-16.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/oz1010_logo.svg rel=mask-icon><style>:root{--body-bg-color:#f5f7f9;--content-bg-color:#fff;--card-bg-color:#f5f5f5;--text-color:#555;--selection-bg:#262a30;--selection-color:#eee;--blockquote-color:#666;--link-color:#555;--link-hover-color:#222;--brand-color:#fff;--brand-hover-color:#fff;--table-row-odd-bg-color:#f9f9f9;--table-row-hover-bg-color:#f5f5f5;--menu-item-bg-color:#f5f5f5;--theme-color:#222;--btn-default-bg:#fff;--btn-default-color:#555;--btn-default-border-color:#555;--btn-default-hover-bg:#222;--btn-default-hover-color:#fff;--btn-default-hover-border-color:#222;--highlight-background:#f6f6f6;--highlight-foreground:#2f3337;--highlight-gutter-background:#e2e2e2;--highlight-gutter-foreground:#42464a;color-scheme:light}html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{margin:.67em 0;font-size:2em}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace;font-size:1em}a{background:0 0}abbr[title]{border-bottom:none;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace;font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:100%;line-height:1.15}button,input{overflow:visible}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted buttontext}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;white-space:normal;max-width:100%;padding:0;display:table}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}details{display:block}summary{display:list-item}template,[hidden]{display:none}::selection{background:var(--selection-bg);color:var(--selection-color)}html,body{height:100%}body{background:var(--body-bg-color);box-sizing:border-box;color:var(--text-color);min-height:100%;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-size:1em;line-height:2;transition:padding .2s ease-in-out;position:relative}h1,h2,h3,h4,h5,h6{margin:30px 0 15px;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-weight:700;line-height:1.5}h1{font-size:1.5em}h2{font-size:1.375em}h3{font-size:1.25em}h4{font-size:1.125em}h5{font-size:1em}h6{font-size:.875em}a{color:var(--link-color);cursor:pointer;overflow-wrap:break-word;border-bottom:1px solid #999;outline:0;text-decoration:none}a:hover{border-bottom-color:var(--link-hover-color);color:var(--link-hover-color)}iframe,img,video,embed{max-width:100%;margin-left:auto;margin-right:auto;display:block}hr{background-image:repeating-linear-gradient(-45deg,#ddd,#ddd 4px,#0000 4px 8px);border:0;height:3px;margin:40px 0}blockquote{color:var(--blockquote-color);border-left:4px solid #ddd;margin:0;padding:0 15px}blockquote cite:before{content:"-";padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}.table-container{overflow:auto}table{border-collapse:collapse;border-spacing:0;width:100%;margin:0 0 20px;font-size:.875em}tbody tr:nth-of-type(odd){background:var(--table-row-odd-bg-color)}tbody tr:hover{background:var(--table-row-hover-bg-color)}caption,th,td{padding:8px}th,td{border:1px solid #ddd;border-bottom-width:3px}th{padding-bottom:10px;font-weight:700}td{border-bottom-width:1px}.btn{background:var(--btn-default-bg);border:2px solid var(--btn-default-border-color);color:var(--btn-default-color);border-radius:2px;padding:0 20px;font-size:.875em;line-height:2;transition:background-color .2s ease-in-out;display:inline-block}.btn:hover{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{text-align:left;width:1.28571em}.toggle{line-height:0}.toggle .toggle-line{background:#fff;width:100%;height:2px;transition:left .4s,opacity .4s,top .4s,transform .4s,width .4s;display:block;position:relative;top:0;left:0}.toggle .toggle-line:first-child{margin-top:1px}.toggle .toggle-line:not(:first-child){margin-top:4px}.toggle.toggle-arrow :first-child{width:50%;top:2px;left:50%;transform:rotate(45deg)}.toggle.toggle-arrow :last-child{width:50%;top:-2px;left:50%;transform:rotate(-45deg)}.toggle.toggle-close :nth-child(2){opacity:0}.toggle.toggle-close :first-child{top:6px;transform:rotate(45deg)}.toggle.toggle-close :last-child{top:-6px;transform:rotate(-45deg)}pre code.hljs{padding:1em;display:block;overflow-x:auto}code.hljs{padding:3px 5px}.hljs{color:#2f3337;background:#f6f6f6}.hljs-subst{color:#2f3337}.hljs-comment{color:#656e77}.hljs-keyword,.hljs-selector-tag,.hljs-meta .hljs-keyword,.hljs-doctag,.hljs-section,.hljs-attr{color:#015692}.hljs-attribute{color:#803378}.hljs-name,.hljs-type,.hljs-number,.hljs-selector-id,.hljs-quote,.hljs-template-tag{color:#b75501}.hljs-selector-class{color:#015692}.hljs-string,.hljs-regexp,.hljs-symbol,.hljs-variable,.hljs-template-variable,.hljs-link,.hljs-selector-attr{color:#54790d}.hljs-meta,.hljs-selector-pseudo{color:#015692}.hljs-built_in,.hljs-title,.hljs-literal{color:#b75501}.hljs-bullet,.hljs-code{color:#535a60}.hljs-meta .hljs-string{color:#54790d}.hljs-deletion{color:#c02d2e}.hljs-addition{color:#2f6f44}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.highlight:hover .copy-btn,.code-container:hover .copy-btn{opacity:1}.code-container{position:relative}.code-lang{opacity:.1;pointer-events:none;font-size:40px;line-height:1;position:absolute;right:5px}.copy-btn{color:#333;cursor:pointer;opacity:0;background:#fff;border:0;padding:2px 6px;font-size:.8125em;line-height:1.6;transition:opacity .2s ease-in-out;position:absolute;top:0;right:0}code,kbd,figure.highlight,pre{background:var(--highlight-background);color:var(--highlight-foreground)}figure.highlight,pre{margin:0 auto 20px;line-height:1.6}figure.highlight figcaption,pre .caption{background:var(--highlight-gutter-background);color:var(--highlight-foreground);padding:.5em;font-size:.875em;line-height:1.2;display:flow-root}figure.highlight figcaption a,pre .caption a{color:var(--highlight-foreground);float:right}figure.highlight figcaption a:hover,pre .caption a:hover{border-bottom-color:var(--highlight-foreground)}pre,code{font-family:consolas,Menlo,monospace,PingFang SC,Microsoft YaHei}code{overflow-wrap:break-word;border-radius:3px;padding:2px 4px;font-size:.875em}kbd{white-space:nowrap;border:2px solid #ccc;border-radius:.2em;padding:.1em .3em;font-family:inherit;box-shadow:.1em .1em .2em #0000001a}figure.highlight{position:relative;overflow:auto}figure.highlight pre{border:0;margin:0;padding:10px 0}figure.highlight table{border:0;width:auto;margin:0}figure.highlight td{border:0;padding:0}figure.highlight .gutter{-webkit-user-select:none;user-select:none}figure.highlight .gutter pre{background:var(--highlight-gutter-background);color:var(--highlight-gutter-foreground);text-align:right;padding-left:10px;padding-right:10px}figure.highlight .code pre{width:100%;padding-left:10px}figure.highlight .marked{background:#0000004d}pre .caption{margin-bottom:10px}.gist table{width:auto}.gist table td{border:0}pre{padding:10px;overflow:auto}pre code{text-shadow:none;background:0 0;padding:0}.blockquote-center{text-align:center;border-left:0;margin:40px 0;padding:0;position:relative}.blockquote-center:before,.blockquote-center:after{opacity:.6;width:100%;line-height:1;position:absolute;left:0}.blockquote-center:before{text-align:left;content:"";border-top:1px solid #ccc;font-family:"Font Awesome 6 Free";font-weight:900;top:-20px}.blockquote-center:after{text-align:right;content:"";border-bottom:1px solid #ccc;font-family:"Font Awesome 6 Free";font-weight:900;bottom:-20px}.blockquote-center p,.blockquote-center div{text-align:center}.group-picture{margin-bottom:20px}.group-picture .group-picture-row{gap:3px;margin-bottom:3px;display:flex}.group-picture .group-picture-column{flex:1}.group-picture .group-picture-column img{object-fit:cover;width:100%;height:100%;margin:0}.post-body .label{color:#555;padding:0 2px}.post-body .label.default{background:#f0f0f0}.post-body .label.primary{background:#efe6f7}.post-body .label.info{background:#e5f2f8}.post-body .label.success{background:#e7f4e9}.post-body .label.warning{background:#fcf6e1}.post-body .label.danger{background:#fae8eb}.post-body .link-grid{grid-gap:1.5rem;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;margin-bottom:20px;padding:1rem;display:grid}.post-body .link-grid .link-grid-container{border:solid #ddd;min-width:0;min-height:5rem;padding:.5rem;transition:background .3s;position:relative;box-shadow:1rem 1rem .5rem #00000080}.post-body .link-grid .link-grid-container:hover{background:var(--card-bg-color);animation:.5s next-shake}.post-body .link-grid .link-grid-container:active{transform:translate(.2rem,.2rem);box-shadow:.5rem .5rem .25rem #00000080}.post-body .link-grid .link-grid-container .link-grid-image{box-sizing:border-box;border:1px solid #ddd;border-radius:50%;width:5rem;height:5rem;padding:3px;position:absolute}.post-body .link-grid .link-grid-container p{margin:0 1rem 0 6rem}.post-body .link-grid .link-grid-container p:first-of-type{font-size:1.2em}.post-body .link-grid .link-grid-container p:last-of-type{opacity:.7;font-size:.8em;line-height:1.3rem}.post-body .link-grid .link-grid-container a{border:0;width:100%;height:100%;position:absolute;top:0;left:0}@keyframes next-shake{0%{transform:translate(1pt,1pt)rotate(0)}10%{transform:translate(-1pt,-2pt)rotate(-1deg)}20%{transform:translate(-3pt)rotate(1deg)}30%{transform:translate(3pt,2pt)rotate(0)}40%{transform:translate(1pt,-1pt)rotate(1deg)}50%{transform:translate(-1pt,2pt)rotate(-1deg)}60%{transform:translate(-3pt,1pt)rotate(0)}70%{transform:translate(3pt,1pt)rotate(-1deg)}80%{transform:translate(-1pt,-1pt)rotate(1deg)}90%{transform:translate(1pt,2pt)rotate(0)}to{transform:translate(1pt,-2pt)rotate(-1deg)}}.post-body .note{border:1px solid #eee;border-left-width:5px;border-radius:3px;margin-bottom:20px;padding:1em;position:relative}.post-body .note summary{cursor:pointer;outline:0}.post-body .note summary p{display:inline}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{border-bottom:initial;margin:0;padding-top:0}.post-body .note :first-child{margin-top:0}.post-body .note :last-child{margin-bottom:0}.post-body .note.default{border-left-color:#777}.post-body .note.default h2,.post-body .note.default h3,.post-body .note.default h4,.post-body .note.default h5,.post-body .note.default h6{color:#777}.post-body .note.primary{border-left-color:#6f42c1}.post-body .note.primary h2,.post-body .note.primary h3,.post-body .note.primary h4,.post-body .note.primary h5,.post-body .note.primary h6{color:#6f42c1}.post-body .note.info{border-left-color:#428bca}.post-body .note.info h2,.post-body .note.info h3,.post-body .note.info h4,.post-body .note.info h5,.post-body .note.info h6{color:#428bca}.post-body .note.success{border-left-color:#5cb85c}.post-body .note.success h2,.post-body .note.success h3,.post-body .note.success h4,.post-body .note.success h5,.post-body .note.success h6{color:#5cb85c}.post-body .note.warning{border-left-color:#f0ad4e}.post-body .note.warning h2,.post-body .note.warning h3,.post-body .note.warning h4,.post-body .note.warning h5,.post-body .note.warning h6{color:#f0ad4e}.post-body .note.danger{border-left-color:#d9534f}.post-body .note.danger h2,.post-body .note.danger h3,.post-body .note.danger h4,.post-body .note.danger h5,.post-body .note.danger h6{color:#d9534f}.post-body .tabs{margin-bottom:20px}.post-body .tabs,.tabs-comment{padding-top:10px}.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{background:var(--content-bg-color);z-index:5;flex-wrap:wrap;justify-content:center;margin:0;padding:0;display:flex;position:sticky;top:0}@media (width<=413px){.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{margin-bottom:5px;display:block}}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border:1px solid #0000;border-top-width:3px;border-bottom-color:#ddd;border-radius:0;flex-grow:1;list-style-type:none}@media (width<=413px){.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border:1px solid #0000;border-left-width:3px;border-radius:0}}.post-body .tabs ul.nav-tabs li.tab a,.tabs-comment ul.nav-tabs li.tab a{border-bottom:initial;text-align:center;padding:.25em .75em;line-height:1.8;transition:all .2s ease-out;display:block}.post-body .tabs ul.nav-tabs li.tab a i[class^=fa],.tabs-comment ul.nav-tabs li.tab a i[class^=fa]{width:1.28571em}.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#fc6423 #ddd #0000}@media (width<=413px){.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#ddd #ddd #ddd #fc6423}}.post-body .tabs ul.nav-tabs li.tab.active a,.tabs-comment ul.nav-tabs li.tab.active a{cursor:default}.post-body .tabs .tab-content,.tabs-comment .tab-content{border:1px solid #ddd;border-top-color:#0000;border-radius:0}@media (width<=413px){.post-body .tabs .tab-content,.tabs-comment .tab-content{border-top-color:#ddd;border-radius:0}}.post-body .tabs .tab-content .tab-pane,.tabs-comment .tab-content .tab-pane{padding:20px 20px 0}.post-body .tabs .tab-content .tab-pane:not(.active),.tabs-comment .tab-content .tab-pane:not(.active){display:none}.pagination .prev,.pagination .next,.pagination .page-number,.pagination .space{margin:-1px 10px 0;padding:0 10px;display:inline-block}@media (width<=767px){.pagination .prev,.pagination .next,.pagination .page-number,.pagination .space{margin:0 5px}}.pagination .page-number.current{color:var(--content-bg-color);background:#ccc;border-color:#ccc}.pagination{text-align:center;border-top:1px solid #eee;margin:120px 0 0}.pagination .prev,.pagination .next,.pagination .page-number{border-top:1px solid #eee;border-bottom:0;transition:border-color .2s ease-in-out}.pagination .prev:hover,.pagination .next:hover,.pagination .page-number:hover{border-top-color:var(--link-hover-color)}@media (width<=767px){.pagination{border-top:0}.pagination .prev,.pagination .next,.pagination .page-number{border-top:0;border-bottom:1px solid #eee}.pagination .prev:hover,.pagination .next:hover,.pagination .page-number:hover{border-bottom-color:var(--link-hover-color)}}.pagination .space{margin:0;padding:0}.comments{margin-top:60px;overflow:hidden}.comment-button-group{flex-wrap:wrap;justify-content:center;margin:1em 0;display:flex}.comment-button-group .comment-button{margin:.1em .2em}.comment-button-group .comment-button.active{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.comment-position{display:none}.comment-position.active{display:block}.tabs-comment{margin-top:4em;padding-top:0}.tabs-comment .comments{margin-top:0;padding-top:0}.headband{background:var(--theme-color);height:3px}@media (width<=991px){.headband{display:none}}.site-brand-container{flex-shrink:0;padding:0 10px;display:flex}.use-motion .column,.use-motion .site-brand-container .toggle{opacity:0}.site-meta{text-align:center;flex-grow:1}@media (width<=767px){.site-meta{text-align:center}}.custom-logo-image{margin-top:20px}@media (width<=991px){.custom-logo-image{display:none}}.brand{color:var(--brand-color);border-bottom:0;padding:0;display:inline-block}.brand:hover{color:var(--brand-hover-color)}.site-title{margin:0;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-size:1.375em;font-weight:400;line-height:1.5}.site-subtitle{color:#ddd;margin:10px 10px 0;font-size:.8125em}.use-motion .site-title,.use-motion .site-subtitle,.use-motion .custom-logo-image{opacity:0;position:relative;top:-10px}.site-nav-toggle,.site-nav-right{display:none}@media (width<=767px){.site-nav-toggle,.site-nav-right{flex-direction:column;justify-content:center;display:flex}}.site-nav-toggle .toggle,.site-nav-right .toggle{color:var(--text-color);width:22px;padding:10px}.site-nav-toggle .toggle .toggle-line,.site-nav-right .toggle .toggle-line{background:var(--text-color);border-radius:1px}@media (width<=767px){.site-nav{--scroll-height:0;visibility:hidden;height:0;transition:height .2s ease-in-out,visibility .2s ease-in-out;overflow:hidden}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height);visibility:unset}}.menu{text-align:center;margin:0;padding:1em 0}.menu-item{margin:0 10px;list-style:none;display:inline-block}@media (width<=767px){.menu-item{margin-top:10px;display:block}.menu-item.menu-item-search{display:none}}.menu-item a{border-bottom:0;font-size:.8125em;transition:border-color .2s ease-in-out;display:block}.menu-item a:hover,.menu-item a.menu-item-active{background:var(--menu-item-bg-color)}.menu-item i[class^=fa]{margin-right:8px}.menu-item .badge{color:var(--content-bg-color);text-shadow:1px 1px #0000001a;background:#ccc;border-radius:10px;margin-left:.35em;padding:2px 5px;font-weight:700;line-height:1}.use-motion .menu-item{visibility:hidden}@media (width<=991px){.sidebar{left:-320px}.sidebar-active .sidebar{left:0}.sidebar{z-index:20;background:#222;width:320px;max-height:100vh;transition:left .2s ease-out,right .2s ease-out;position:fixed;top:0;bottom:0;overflow-y:auto;box-shadow:inset 0 2px 6px #000}.sidebar a{color:#999;border-bottom-color:#555}.sidebar a:hover{color:#eee;border-bottom-color:#eee}.links-of-author:not(:first-child){margin-top:15px}.links-of-author a{vertical-align:middle;border-bottom-color:#555;margin-bottom:10px;margin-right:10px;display:inline-block}.links-of-author a:before{content:" ";background:#ff4213;border-radius:50%;width:4px;height:4px;margin-right:3px;display:inline-block;transform:translateY(-2px)}.links-of-blogroll-item{padding:0 5px}.popular-posts .popular-posts-item .popular-posts-link:hover{background:0 0}.sidebar-dimmer{opacity:0;visibility:hidden;z-index:10;background:#000;width:100%;height:100%;transition:visibility .4s,opacity .4s;position:fixed;top:0;left:0}.sidebar-active .sidebar-dimmer{opacity:.7;visibility:visible}}.sidebar-inner{color:#999;text-align:center;flex-direction:column;justify-content:center;padding:18px 10px;display:flex}.sidebar-toggle{cursor:pointer;opacity:.6;z-index:30;background:#222;width:16px;height:16px;padding:5px;position:fixed;bottom:61px;left:30px}@media (width<=991px){.sidebar-toggle{left:20px}}.sidebar-toggle:hover{opacity:.8}@media (width<=991px){.sidebar-toggle{opacity:.8}}.sidebar-toggle:hover .toggle-line{background:#fc6423}@media (any-hover:hover){body:not(.sidebar-active) .sidebar-toggle:hover :first-child{width:50%;top:2px;left:50%;transform:rotate(45deg)}body:not(.sidebar-active) .sidebar-toggle:hover :last-child{width:50%;top:-2px;left:50%;transform:rotate(-45deg)}}.sidebar-active .sidebar-toggle :nth-child(2){opacity:0}.sidebar-active .sidebar-toggle :first-child{top:6px;transform:rotate(45deg)}.sidebar-active .sidebar-toggle :last-child{top:-6px;transform:rotate(-45deg)}.sidebar-nav{pointer-events:none;visibility:hidden;height:0;margin:0;padding-left:0;font-size:.875em;transition:height .2s ease-in-out,visibility .2s ease-in-out;overflow:hidden}.sidebar-nav-active .sidebar-nav{pointer-events:unset;height:calc(2em + 1px);visibility:unset}.sidebar-nav li{color:var(--text-color);cursor:pointer;border-bottom:1px solid #0000;transition:border-bottom-color .2s ease-in-out,color .2s ease-in-out;display:inline-block}.sidebar-nav li.sidebar-nav-overview{margin-left:10px}.sidebar-nav li:hover{color:#fc6423}.sidebar-toc-active .sidebar-nav-toc,.sidebar-overview-active .sidebar-nav-overview{color:#fc6423;border-bottom-color:#fc6423;transition-delay:.2s}.sidebar-toc-active .sidebar-nav-toc:hover,.sidebar-overview-active .sidebar-nav-overview:hover{color:#fc6423}.sidebar-panel-container{flex:1;align-items:start;padding-top:0;transition:padding-top .2s ease-in-out;display:grid;overflow:hidden auto}.sidebar-nav-active .sidebar-panel-container{padding-top:20px}.sidebar-panel{opacity:0;pointer-events:none;visibility:hidden;grid-area:1/1;height:0;transition:opacity .2s ease-in-out,transform .2s ease-in-out,visibility .2s ease-in-out;animation:.2s ease-in-out deactivate-sidebar-panel;overflow:hidden;transform:translateY(0)}.sidebar-nav-active .sidebar-panel,.sidebar-overview-active .sidebar-panel.post-toc-wrap{transform:translateY(-20px)}.sidebar-overview-active:not(.sidebar-nav-active) .sidebar-panel.post-toc-wrap{transition-delay:0s,.2s,0s}.sidebar-overview-active .sidebar-panel.site-overview-wrap,.sidebar-toc-active .sidebar-panel.post-toc-wrap{opacity:1;pointer-events:unset;height:auto;visibility:unset;transition-delay:.2s,.2s,0s;animation-name:activate-sidebar-panel;transform:translateY(0)}.sidebar-panel.site-overview-wrap{flex-direction:column;justify-content:flex-start;gap:10px;display:flex}@keyframes deactivate-sidebar-panel{0%{height:var(--inactive-panel-height,0)}to{height:var(--active-panel-height,0)}}@keyframes activate-sidebar-panel{0%{height:var(--inactive-panel-height,auto)}to{height:var(--active-panel-height,auto)}}.post-toc{font-size:.875em}.post-toc ol{text-align:left;margin:0;padding:0 2px 0 10px;list-style:none}.post-toc ol>:last-child{margin-bottom:5px}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition:all .2s ease-in-out}.post-toc .nav-item{text-overflow:ellipsis;white-space:nowrap;line-height:1.8;overflow:hidden}.post-toc .nav .active>a{color:#fc6423;border-bottom-color:#fc6423}.post-toc .nav .active-current>a,.post-toc .nav .active-current>a:hover{color:#fc6423}.site-author-image{border:1px solid #eee;border-radius:50%;max-width:120px;padding:2px}.site-author-name{color:var(--text-color);margin:0;font-weight:600}.site-description{color:#999;margin-top:0;font-size:.8125em}.site-state{flex-wrap:wrap;justify-content:center;line-height:1.4;display:flex}.site-state-item{padding:0 15px}.site-state-item a{border-bottom:0;display:block}.site-state-item-count{font-size:1em;font-weight:600;display:block}.site-state-item-name{color:#999;font-size:.8125em}.sidebar .sidebar-button:not(:first-child){margin-top:15px}.sidebar .sidebar-button button{color:#fc6423;cursor:pointer;background:0 0;border:1px solid #fc6423;border-radius:4px;padding:0 15px;line-height:2}.sidebar .sidebar-button button:hover{color:#fff;background:#fc6423}.sidebar .sidebar-button button i[class^=fa]{margin-right:5px}.links-of-author a{font-size:.8125em}.links-of-author i[class^=fa]{margin-right:2px}.cc-license .cc-opacity{opacity:.7;border-bottom:0}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}.links-of-blogroll{font-size:.8125em}.links-of-blogroll-title{font-size:.875em;font-weight:600}.links-of-blogroll-list{flex-flow:column wrap;justify-content:center;gap:5px;margin:5px 0 0;padding:0;list-style:none;display:flex}.links-of-blogroll-item{max-width:100%}.links-of-blogroll-item a{box-sizing:border-box;text-overflow:ellipsis;white-space:nowrap;max-width:100%;display:inline-block;overflow:hidden}.footer{color:#999;padding:20px 0;font-size:.875em;transition:left .2s ease-in-out,right .2s ease-in-out}.footer.footer-fixed{position:absolute;bottom:0;left:0;right:0}.footer-inner{box-sizing:border-box;text-align:center;flex-direction:column;justify-content:center;width:calc(100% - 20px);margin:0 auto;display:flex}@media (width<=767px){.footer-inner{width:auto}}@media (width>=1200px){.footer-inner{width:1160px}}@media (width>=1600px){.footer-inner{width:73%}}.use-motion .footer{opacity:0}.languages{font-size:1.125em;display:inline-block;position:relative}.languages .lang-select-label span{margin:0 .5em}.languages .lang-select{opacity:0;width:100%;height:100%;position:absolute;top:0;left:0}.with-love{color:red;margin:0 5px;display:inline-block}@keyframes icon-animate{0%,to{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}.back-to-top{color:#fff;cursor:pointer;opacity:.6;z-index:30;background:#222;align-items:center;height:26px;font-size:12px;transition:bottom .2s ease-in-out;display:flex;position:fixed;bottom:-100px;left:30px}.back-to-top span{margin-right:8px}.back-to-top .fa{text-align:center;width:26px}@media (width<=991px){.back-to-top{left:20px}}.back-to-top:hover{opacity:.8}@media (width<=991px){.back-to-top{opacity:.8}}.back-to-top:hover{color:#fc6423}.back-to-top.back-to-top-on{bottom:30px}.rtl.post-body p,.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ul,.rtl.post-body ol{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.post-button{text-align:center;margin-top:40px}.use-motion .post-block,.use-motion .pagination,.use-motion .comments,.use-motion .post-header,.use-motion .post-body,.use-motion .collection-header{visibility:hidden}.posts-collapse .post-content{margin-bottom:35px;margin-left:35px;position:relative}@media (width<=767px){.posts-collapse .post-content{margin-left:0;margin-right:0}}.posts-collapse .post-content .collection-title{font-size:1.125em;position:relative}.posts-collapse .post-content .collection-title:before{content:" ";background:#999;border:1px solid #fff;border-radius:50%;width:10px;height:10px;margin-top:-4px;margin-left:-6px;position:absolute;top:50%}.posts-collapse .post-content .collection-year{margin:60px 0;font-size:1.5em;font-weight:700;position:relative}.posts-collapse .post-content .collection-year .collection-year-count{color:var(--content-bg-color);text-shadow:1px 1px #0000001a;background:#ccc;border-radius:10px;margin-left:.35em;padding:2px 5px;font-size:.75em;font-weight:700;line-height:1}.posts-collapse .post-content .collection-year:before{content:" ";background:#bbb;border-radius:50%;width:8px;height:8px;margin-top:-4px;margin-left:-4px;position:absolute;top:50%}.posts-collapse .post-content .collection-header{margin-left:20px;display:block}.posts-collapse .post-content .collection-header small{color:#bbb;margin-left:5px}.posts-collapse .post-content .post-header{border-bottom:1px dashed #ccc;margin:30px 2px 0;padding-left:15px;transition:border .2s ease-in-out;position:relative}.posts-collapse .post-content .post-header:before{content:" ";background:#bbb;border:1px solid #fff;border-radius:50%;width:6px;height:6px;transition:background .2s ease-in-out;position:absolute;top:.75em;left:-6px}.posts-collapse .post-content .post-header:hover{border-bottom-color:#666}.posts-collapse .post-content .post-header:hover:before{background:#222}.posts-collapse .post-content .post-meta-container{margin-right:10px;font-size:.75em;display:inline}.posts-collapse .post-content .post-title{display:inline}.posts-collapse .post-content .post-title a{color:var(--link-color);border-bottom:0}.posts-collapse .post-content .post-title .fa{margin-left:5px;font-size:.875em}.posts-collapse .post-content:before{content:" ";background:#f5f5f5;width:4px;height:100%;margin-left:-2px;position:absolute;top:1.25em}.post-body{overflow-wrap:break-word;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif}@media (width>=1200px){.post-body{font-size:1.125em}}@media (width>=992px){.post-body{text-align:justify}}@media (width<=991px){.post-body{text-align:justify}}.post-body h1 .header-anchor,.post-body h2 .header-anchor,.post-body h3 .header-anchor,.post-body h4 .header-anchor,.post-body h5 .header-anchor,.post-body h6 .header-anchor,.post-body h1 .headerlink,.post-body h2 .headerlink,.post-body h3 .headerlink,.post-body h4 .headerlink,.post-body h5 .headerlink,.post-body h6 .headerlink{color:inherit;float:right;opacity:0;border-bottom-style:none;margin-left:10px;font-size:.875em}.post-body h1 .header-anchor:before,.post-body h2 .header-anchor:before,.post-body h3 .header-anchor:before,.post-body h4 .header-anchor:before,.post-body h5 .header-anchor:before,.post-body h6 .header-anchor:before,.post-body h1 .headerlink:before,.post-body h2 .headerlink:before,.post-body h3 .headerlink:before,.post-body h4 .headerlink:before,.post-body h5 .headerlink:before,.post-body h6 .headerlink:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900}.post-body h1:hover .header-anchor,.post-body h2:hover .header-anchor,.post-body h3:hover .header-anchor,.post-body h4:hover .header-anchor,.post-body h5:hover .header-anchor,.post-body h6:hover .header-anchor,.post-body h1:hover .headerlink,.post-body h2:hover .headerlink,.post-body h3:hover .headerlink,.post-body h4:hover .headerlink,.post-body h5:hover .headerlink,.post-body h6:hover .headerlink{opacity:.5}.post-body h1:hover .header-anchor:hover,.post-body h2:hover .header-anchor:hover,.post-body h3:hover .header-anchor:hover,.post-body h4:hover .header-anchor:hover,.post-body h5:hover .header-anchor:hover,.post-body h6:hover .header-anchor:hover,.post-body h1:hover .headerlink:hover,.post-body h2:hover .headerlink:hover,.post-body h3:hover .headerlink:hover,.post-body h4:hover .headerlink:hover,.post-body h5:hover .headerlink:hover,.post-body h6:hover .headerlink:hover{opacity:1}.post-body .exturl .fa{margin-left:4px;font-size:.875em}.post-body figure:not(.highlight) figcaption{color:#999;text-align:center;margin:-15px auto 15px;font-size:.875em;font-weight:700;line-height:1}.post-body iframe,.post-body img,.post-body video,.post-body embed{margin-bottom:20px}.post-body .video-container{width:100%;height:0;margin-bottom:20px;padding-top:75%;position:relative;overflow:hidden}.post-body .video-container iframe,.post-body .video-container object,.post-body .video-container embed{width:100%;height:100%;margin:0;position:absolute;top:0;left:0}.post-gallery{min-height:200px;display:flex}.post-gallery .post-gallery-image{flex:1}.post-gallery .post-gallery-image:not(:first-child){clip-path:polygon(40px 0,100% 0,100% 100%,0 100%);margin-left:-20px}.post-gallery .post-gallery-image:not(:last-child){margin-right:-20px}.post-gallery .post-gallery-image img{object-fit:cover;opacity:1;width:100%;height:100%}.posts-expand .post-gallery{margin-bottom:60px}.posts-collapse .post-gallery{margin:15px 0}.posts-expand .post-header{text-align:center;margin-bottom:60px;font-size:1.125em}.posts-expand .post-title{margin:initial;overflow-wrap:break-word;font-size:1.5em;font-weight:400}.posts-expand .post-title-link{color:var(--link-color);border-bottom:0;max-width:100%;display:inline-block;position:relative}.posts-expand .post-title-link:before{background:var(--link-color);content:"";width:100%;height:2px;transition:transform .2s ease-in-out;position:absolute;bottom:0;left:0;transform:scaleX(0)}.posts-expand .post-title-link:hover:before{transform:scaleX(1)}.posts-expand .post-title-link .fa{margin-left:5px;font-size:.875em}.post-sticky-flag{margin-right:8px;display:inline-block;transform:rotate(30deg)}.posts-expand .post-meta-container{color:#999;margin-top:3px;font-family:Lato,PingFang SC,Microsoft YaHei,sans-serif;font-size:.75em}.posts-expand .post-meta-container .post-description{margin-top:2px;font-size:.875em}.posts-expand .post-meta-container time{border-bottom:1px dashed #999}.post-meta{flex-wrap:wrap;justify-content:center;display:flex}:not(.post-meta-break)+.post-meta-item:before{content:"|";margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (width<=991px){.post-meta-item-text{display:none}}.post-meta-break{flex-basis:100%;height:0}.post-nav{border-top:1px solid #eee;justify-content:space-between;gap:30px;margin-top:1em;padding:10px 5px 0;display:flex}.post-nav-item{flex:1}.post-nav-item a{border-bottom:0;font-size:.875em;line-height:1.6;display:block}.post-nav-item a:active{top:2px}.post-nav-item .fa{font-size:.75em}.post-nav-item:first-child .fa{margin-right:5px}.post-nav-item:last-child{text-align:right}.post-nav-item:last-child .fa{margin-left:5px}.post-footer{flex-direction:column;justify-content:center;display:flex}.post-eof{background:#ccc;width:8%;height:1px;margin:80px auto 60px}.post-block:last-of-type .post-eof{display:none}.post-copyright ul{background:var(--card-bg-color);border-left:3px solid #ff2a2a;margin:1em 0 0;padding:.5em 1em;list-style:none;position:relative;overflow:hidden}.post-copyright ul:after{content:"";opacity:.1;font-family:"Font Awesome 6 Brands";font-size:200px;position:absolute;top:-150px;right:-50px}.post-tags{text-align:center;margin-top:40px}.post-tags a{font-size:.8125em;display:inline-block}.post-tags a:not(:last-child){margin-right:10px}.social-like{border-top:1px solid #eee;flex-wrap:wrap;justify-content:center;margin-top:1em;padding-top:1em;font-size:.875em;display:flex}.social-like a{border-bottom:none}.reward-container{text-align:center;margin:1em 0 0;padding:1em 0}.reward-container button{color:#fc6423;cursor:pointer;vertical-align:text-top;background:0 0;border:2px solid #fc6423;border-radius:2px;outline:0;padding:0 15px;line-height:2}.reward-container button:hover{color:#fff;background:#fc6423}.post-reward{padding-top:20px;display:none}.post-reward.active{display:block}.post-reward div{display:inline-block}.post-reward div span{display:block}.post-reward img{width:180px;max-width:100%;margin:.8em 2em 0;display:inline-block}@keyframes next-roll{0%{transform:rotate(30deg)}to{transform:rotate(-30deg)}}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{margin:0;padding:0;list-style:none}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{color:var(--content-bg-color);text-shadow:1px 1px #0000001a;background:#ccc;border-radius:10px;margin-left:.35em;padding:2px 5px;font-size:.75em;font-weight:700;line-height:1}.category-all-page .category-list-child{padding-left:10px}.event-list hr{background:#222;margin:20px 0 45px}.event-list hr:after{color:#fff;content:"NOW";background:#222;padding:0 5px;font-weight:700;display:inline-block}.event-list .event{--event-background:#222;--event-foreground:#bbb;--event-title:#fff;background:var(--event-background);padding:15px}.event-list .event .event-summary{color:var(--event-title);border-bottom:0;margin:0;padding:0 0 0 35px;position:relative}.event-list .event .event-summary:before{background:var(--event-title);content:" ";border-radius:50%;width:12px;height:12px;margin-top:-6px;animation:1s ease-in-out infinite alternate dot-flash;position:absolute;top:50%;left:0}.event-list .event:nth-of-type(odd) .event-summary:before{animation-delay:.5s}.event-list .event:not(:last-child){margin-bottom:20px}.event-list .event .event-relative-time{color:var(--event-foreground);padding-left:12px;font-size:12px;font-weight:400;display:inline-block}.event-list .event .event-details{color:var(--event-foreground);padding:6px 0 6px 35px;line-height:18px;display:block}.event-list .event .event-details:before{color:var(--event-foreground);width:14px;margin-right:9px;font-family:"Font Awesome 6 Free";font-weight:900;display:inline-block}.event-list .event .event-details.event-location:before{content:""}.event-list .event .event-details.event-duration:before{content:""}.event-list .event .event-details.event-description:before{content:""}.event-list .event-past{--event-background:#f5f5f5;--event-foreground:#999;--event-title:#222}@keyframes dot-flash{0%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}ul.breadcrumb{text-align:center;margin:1em 0;padding:0 2em;font-size:.75em;list-style:none}ul.breadcrumb li{display:inline}ul.breadcrumb li:not(:first-child):before{content:"/ ";padding:.5em;font-weight:400}ul.breadcrumb li:last-child{font-weight:700}.tag-cloud{text-align:center}.tag-cloud a{margin:10px;display:inline-block}.tag-cloud-0{color:#aaa;border-bottom-color:#aaa}.tag-cloud-1{color:#9a9a9a;border-bottom-color:#9a9a9a}.tag-cloud-2{color:#8b8b8b;border-bottom-color:#8b8b8b}.tag-cloud-3{color:#7c7c7c;border-bottom-color:#7c7c7c}.tag-cloud-4{color:#6c6c6c;border-bottom-color:#6c6c6c}.tag-cloud-5{color:#5d5d5d;border-bottom-color:#5d5d5d}.tag-cloud-6{color:#4e4e4e;border-bottom-color:#4e4e4e}.tag-cloud-7{color:#3e3e3e;border-bottom-color:#3e3e3e}.tag-cloud-8{color:#2f2f2f;border-bottom-color:#2f2f2f}.tag-cloud-9{color:#202020;border-bottom-color:#202020}.tag-cloud-10{color:#111;border-bottom-color:#111}.search-active{margin-right:var(--dialog-scrollgutter,0);overflow:hidden}.search-pop-overlay{visibility:hidden;z-index:40;background:0 0;width:100%;height:100%;transition:visibility .4s,background .4s;display:flex;position:fixed;top:0;left:0}.search-active .search-pop-overlay{visibility:visible;background:#0000004d}.search-popup{background:var(--card-bg-color);border-radius:5px;width:700px;height:80%;margin:auto;transition:transform .4s;transform:scale(0)}.search-active .search-popup{transform:scale(1)}@media (width<=767px){.search-popup{border-radius:0;width:100%;height:100%}}.search-popup .search-icon,.search-popup .popup-btn-close{color:#999;padding:0 10px;font-size:18px}.search-popup .popup-btn-close{cursor:pointer}.search-popup .popup-btn-close:hover .fa{color:#222}.search-popup .search-header{background:#eee;border-top-left-radius:5px;border-top-right-radius:5px;padding:5px;display:flex}.search-popup input.search-input{background:0 0;border:0;outline:0;width:100%}.search-popup input.search-input::-webkit-search-cancel-button{display:none}.search-popup .search-result-container{flex-direction:column;height:calc(100% - 55px);padding:5px 25px;display:flex;overflow:auto}.search-popup .search-result-container hr{flex-shrink:0;margin:5px 0 10px}.search-popup .search-result-container hr:first-child{display:none}.search-popup .search-result-list{margin:0 5px;padding:0}.search-popup a.search-result-title{font-weight:700}.search-popup p.search-result{border-bottom:1px dashed #ccc;margin:0 0 10px;padding:5px 0}.search-popup .search-input-container{flex-grow:1;padding:2px}.search-popup .search-result-icon{color:#ccc;margin:auto}mark.search-keyword{color:#ff2a2a;background:0 0;border-bottom:1px dashed #ff2a2a;font-weight:700}.use-motion .animated{visibility:inherit;animation-fill-mode:none}.use-motion .sidebar .animated{animation-fill-mode:both}header.header{background:var(--content-bg-color);border-radius:initial;box-shadow:initial}@media (width<=991px){header.header{border-radius:initial}}.main{justify-content:space-between;align-items:stretch;width:calc(100% - 20px);margin:0 auto;display:flex}@media (width<=767px){.main{width:auto}}@media (width>=1200px){.main{width:1160px}}@media (width>=1600px){.main{width:73%}}@media (width<=991px){.main{width:auto;display:block}}.main-inner{border-radius:initial;box-sizing:border-box;width:calc(100% - 252px)}@media (width<=991px){.main-inner{border-radius:initial;width:100%}}.footer-inner{padding-left:252px}@media (width<=991px){.footer-inner{width:auto;padding-left:0;padding-right:0}}.column{width:240px}@media (width<=991px){.column{width:auto}}.site-brand-container{background:var(--theme-color)}@media (width<=991px){.site-nav-on .site-brand-container{box-shadow:0 0 16px #00000080}}.site-meta{padding:20px 0}@media (width>=768px) and (width<=991px){.site-nav-toggle,.site-nav-right{flex-direction:column;justify-content:center;display:flex}}.site-nav-toggle .toggle,.site-nav-right .toggle{color:#fff}.site-nav-toggle .toggle .toggle-line,.site-nav-right .toggle .toggle-line{background:#fff}@media (width>=768px) and (width<=991px){.site-nav{--scroll-height:0;visibility:hidden;height:0;transition:height .2s ease-in-out,visibility .2s ease-in-out;overflow:hidden}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height);visibility:unset}}.menu .menu-item{margin:0;display:block}.menu .menu-item a{align-items:center;padding:5px 20px;transition-property:background-color;display:flex;position:relative}.menu .menu-item a .badge{margin-left:auto}@media (width<=991px){.menu .menu-item.menu-item-search{display:none}}.sub-menu{margin:0;padding:6px 0}.sub-menu .menu-item{display:inline-block}.sub-menu .menu-item a{padding:initial;background:0 0;margin:5px 10px}.sub-menu .menu-item a:hover{color:#fc6423;background:0 0}.sub-menu .menu-item-active{color:#fc6423;border-bottom-color:#fc6423}.sub-menu .menu-item-active:hover{border-bottom-color:#fc6423}@media (width>=992px){.sidebar{position:sticky;top:12px}.sidebar-toggle{display:none}.sidebar-inner{background:var(--content-bg-color);border-radius:initial;box-shadow:initial;box-sizing:border-box;color:var(--text-color);visibility:hidden;max-height:calc(100vh - 24px);margin-top:12px}.site-state-item{padding:0 10px}.sidebar .sidebar-button{border-top:1px dotted #ccc;border-bottom:1px dotted #ccc}.sidebar .sidebar-button button{color:#fc6423;border:0;width:100%;display:block}.sidebar .sidebar-button button:hover{color:#e34603;background:0 0;border:0}.links-of-author{flex-wrap:wrap;justify-content:center;display:flex}.links-of-author-item{width:50%;margin:5px 0 0}.links-of-author-item a{box-sizing:border-box;text-overflow:ellipsis;white-space:nowrap;border-bottom:0;border-radius:4px;max-width:100%;padding:0 5px;display:inline-block;overflow:hidden}.links-of-author-item a:hover{background:var(--body-bg-color)}.links-of-blogroll-item a{padding:0 5px}}.main-inner{background:var(--content-bg-color);box-shadow:initial;padding:40px}@media (width<=991px){.main-inner{padding:20px}}.sub-menu{border-bottom:1px solid #ddd}.post-block:first-of-type{padding-top:40px}@media (width<=767px){.pagination{margin-bottom:10px}}</style><link integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css rel=stylesheet><link integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css rel=stylesheet><script integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin defer src=https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js></script><script class=next-config data-name=main type=application/json>{"hostname":"oz1010.github.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"stackoverflow-light","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"duration":100,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script defer src=/js/config.js></script><meta content=普通而有趣的技术员 name=description><meta content=website property=og:type><meta content="oz1010's blog" property=og:title><meta content=https://oz1010.github.com/page/2/index.html property=og:url><meta content="oz1010's blog" property=og:site_name><meta content=普通而有趣的技术员 property=og:description><meta content=zh_CN property=og:locale><meta content=oz1010 property=article:author><meta content=summary name=twitter:card><link href=https://oz1010.github.com/page/2/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script><script class=next-config data-name=calendar type=application/json>""</script><title>oz1010's blog</title><script integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin defer src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script defer src=/js/utils.js></script><script defer src=/js/motion.js></script><script defer src=/js/sidebar.js></script><script defer src=/js/next-boot.js></script><script integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin defer src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js></script><script defer src=/js/third-party/search/local-search.js></script><script defer src=/js/third-party/pace.js></script><noscript><link href=/css/noscript.css rel=stylesheet></noscript><link title="oz1010's blog" href=/atom.xml rel=alternate type=application/atom+xml><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <h1 class=site-title>oz1010's blog</h1> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>记录生活或技能</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>4</span></a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>14</span></a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>27</span></a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=oz1010 class=site-author-image itemprop=image src=/images/avatar.jpg><p class=site-author-name itemprop=name>oz1010<div class=site-description itemprop=description>普通而有趣的技术员</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>27</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>14</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>4</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author animated"><span class=links-of-author-item> <a rel="noopener me" title="GitHub → https://github.com/oz1010" href=https://github.com/oz1010 target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item> <a rel="noopener me" title="E-Mail → mailto:alfdxl@163.com" href=mailto:alfdxl@163.com target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span></div><div class="cc-license animated" itemprop=license><a class=cc-opacity href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><img alt="Creative Commons" src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg></a></div></div></div></div></aside></div><div class="main-inner index posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/04/08/Verilog-%E7%A1%AC%E4%BB%B6%E6%8F%8F%E8%BF%B0%E8%AF%AD%E8%A8%80%E4%BD%BF%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/04/08/Verilog-%E7%A1%AC%E4%BB%B6%E6%8F%8F%E8%BF%B0%E8%AF%AD%E8%A8%80%E4%BD%BF%E7%94%A8/ itemprop=url>Verilog-硬件描述语言使用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-08 11:34:41" datetime=2024-04-08T11:34:41+08:00>2024-04-08</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E7%A1%AC%E4%BB%B6/ itemprop=url rel=index><span itemprop=name>硬件</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>5k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>18 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=语言简介>语言简介</h1><p>Verilog在线学习<a href=https://hdlbits.01xz.net/wiki/Main_Page rel=noopener target=_blank>HDLBits主页</a><h2 id=基本语句>基本语句</h2><h3 id=常量>常量</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>3'b101 	// binary 101</span><br><span class=line>4'hf 	// binary 1111</span><br><span class=line>4'd10	// binary 1010</span><br></pre></table></figure><h3 id=线wire>线wire</h3><p>物理线路没有方向，但建模上需要指定方向。<p>创造一个模型，有三个输入和四个输出<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>a -> w</span><br><span class=line>b -> x</span><br><span class=line>b -> y</span><br><span class=line>c -> z</span><br></pre></table></figure><p><img src=https://hdlbits.01xz.net/mw/images/1/15/Wire4.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input a,b,c,</span><br><span class=line>    output w,x,y,z );</span><br><span class=line>    </span><br><span class=line>    assign w=a;</span><br><span class=line>    assign x=b;</span><br><span class=line>    assign y=b;</span><br><span class=line>    assign z=c;</span><br><span class=line></span><br><span class=line>	// If we're certain about the width of each signal, using </span><br><span class=line>	// the concatenation operator is equivalent and shorter:</span><br><span class=line>	// assign {w,x,y,z} = {a,b,b,c};</span><br><span class=line></span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=非门inverter>非门Inverter</h3><p>电路中产生一个非门<p><img src=https://hdlbits.01xz.net/mw/images/9/9e/Notgate.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>module top_module( input in, output out );</span><br><span class=line>	assign out = !in;</span><br><span class=line>	// similar</span><br><span class=line>	// 	assign out = ~in;</span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=与门and-gate>与门AND gate</h3><p>电路中产生一个与门<p><img src=https://hdlbits.01xz.net/mw/images/7/78/Andgate.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input a, </span><br><span class=line>    input b, </span><br><span class=line>    output out );</span><br><span class=line></span><br><span class=line>    assign out = a & b;</span><br><span class=line>    </span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=或非门nor-gate>或非门Nor gate</h3><p>电路中产生一个或非门<p><img src=https://hdlbits.01xz.net/mw/images/5/5b/Norgate.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input a, </span><br><span class=line>    input b, </span><br><span class=line>    output out );</span><br><span class=line></span><br><span class=line>    assign out = ~(a | b);</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=异或非门xnor-gate>异或非门XNOR gate</h3><p>电路中产生一个异或非门<p><img src=https://hdlbits.01xz.net/mw/images/6/6d/Xnorgate.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input a, </span><br><span class=line>    input b, </span><br><span class=line>    output out );</span><br><span class=line></span><br><span class=line>    assign out = ~(a ^ b);</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=声明线declaring-wires>声明线Declaring wires</h3><p><img src=https://hdlbits.01xz.net/mw/images/3/3a/Wiredecl2.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>`default_nettype none</span><br><span class=line>module top_module(</span><br><span class=line>    input a,</span><br><span class=line>    input b,</span><br><span class=line>    input c,</span><br><span class=line>    input d,</span><br><span class=line>    output out,</span><br><span class=line>    output out_n   ); </span><br><span class=line></span><br><span class=line>    wire w1, w2, w3;    </span><br><span class=line>    assign out = w3;</span><br><span class=line>    assign out_n = ~w3;</span><br><span class=line>  </span><br><span class=line>    assign w3 = w1 | w2;</span><br><span class=line>    assign w1 = a & b;</span><br><span class=line>    assign w2 = c & d;</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=芯片>7458芯片</h3><p><img src=https://hdlbits.01xz.net/mw/images/e/e1/7458.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>module top_module ( </span><br><span class=line>    input p1a, p1b, p1c, p1d, p1e, p1f,</span><br><span class=line>    output p1y,</span><br><span class=line>    input p2a, p2b, p2c, p2d,</span><br><span class=line>    output p2y );</span><br><span class=line></span><br><span class=line>	wire wp11,wp12;</span><br><span class=line>    assign p1y = wp11 | wp12;</span><br><span class=line>    assign wp11 = p1a & p1b & p1c;</span><br><span class=line>    assign wp12 = p1f & p1e & p1d;</span><br><span class=line>    </span><br><span class=line>    wire wp21,wp22;</span><br><span class=line>    assign p2y = wp21 | wp22;</span><br><span class=line>    assign wp21 = p2a & p2b;</span><br><span class=line>    assign wp22 = p2c & p2d;</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h2 id=向量vector>向量Vector</h2><h3 id=基本使用>基本使用</h3><p>声明语法：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>type [upper:lower] vector_name;</span><br></pre></table></figure><p>类型可以是wire, reg等等<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>wire [7:0] w;         // 8-bit wire</span><br><span class=line>reg  [4:1] x;         // 4-bit reg</span><br><span class=line>output reg [0:0] y;   // 1-bit reg that is also an output port (this is still a vector)</span><br><span class=line>input wire [3:-2] z;  // 6-bit wire input (negative ranges are allowed)</span><br><span class=line>output [3:0] a;       // 4-bit output wire. Type is 'wire' unless specified otherwise.</span><br><span class=line>wire [0:7] b;         // 8-bit wire where b[0] is the most-significant bit.</span><br></pre></table></figure><p>隐含声明可能导致意想不到的结果<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>wire [2:0] a, c;   // Two vectors</span><br><span class=line>assign a = 3'b101;  // a = 101</span><br><span class=line>assign b = a;       // b =   1  implicitly-created wire</span><br><span class=line>assign c = b;       // c = 001  &lt;-- bug</span><br><span class=line>my_module i1 (d,e); // d and e are implicitly one-bit wide if not declared.</span><br><span class=line>                    // This could be a bug if the port was intended to be a </span><br></pre></table></figure><p>unpacked数组维度跟在名称后，packed数组维度放在名称前<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>reg [7:0] mem [255:0];   // 256 unpacked elements, each of which is a 8-bit packed vector of reg.</span><br><span class=line>reg mem2 [28:0];         // 29 unpacked elements, each of which is a 1-bit reg.</span><br></pre></table></figure><p>描绘如下电路<p><img src=https://hdlbits.01xz.net/mw/images/a/ae/Vector0.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>module top_module ( </span><br><span class=line>    input wire [2:0] vec,</span><br><span class=line>    output wire [2:0] outv,</span><br><span class=line>    output wire o2,</span><br><span class=line>    output wire o1,</span><br><span class=line>    output wire o0  ); // Module body starts after module declaration</span><br><span class=line></span><br><span class=line>    assign {o2,o1,o0} = vec[2:0];</span><br><span class=line>    assign outv = vec;</span><br><span class=line>    </span><br><span class=line>    // This is ok too</span><br><span class=line>   	//assign o0 = vec[0];</span><br><span class=line>	//assign o1 = vec[1];</span><br><span class=line>	//assign o2 = vec[2];</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><p>将字数据（2字节）按高低位分离<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>`default_nettype none     // Disable implicit nets. Reduces some types of bugs.</span><br><span class=line>module top_module( </span><br><span class=line>    input wire [15:0] in,</span><br><span class=line>    output wire [7:0] out_hi,</span><br><span class=line>    output wire [7:0] out_lo );</span><br><span class=line></span><br><span class=line>    assign out_hi = in[15:8];</span><br><span class=line>    assign out_lo = in[7:0];</span><br><span class=line>    </span><br><span class=line>    // Concatenation operator also works: assign {out_hi, out_lo} = in;</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=向量门>向量门</h3><p>按位与<code>&</code>和逻辑与<code>&</code>对于N-bit位输入来说，会产生不同结果。前者会产生N-bit位输出，而后者只产生1-bit位输出（作为布尔值，非0值为true，0值为false）。<p>描绘如下电路，<code>out_not</code>高5-3位为<code>b</code>的非，其余为<code>a</code>的非。<p><img src=https://hdlbits.01xz.net/mw/images/1/1b/Vectorgates.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input [2:0] a,</span><br><span class=line>    input [2:0] b,</span><br><span class=line>    output [2:0] out_or_bitwise,</span><br><span class=line>    output out_or_logical,</span><br><span class=line>    output [5:0] out_not</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>    assign out_or_bitwise = a | b;</span><br><span class=line>    assign out_or_logical = a || b;</span><br><span class=line>    // ! is logical inverse</span><br><span class=line>    assign out_not = {~b, ~a};</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=颠倒8位>颠倒8位</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input [7:0] in,</span><br><span class=line>	output [7:0] out</span><br><span class=line>);</span><br><span class=line>	assign out = {in[0],in[1],in[2],in[3],in[4],in[5],in[6],in[7]};</span><br><span class=line>	//assign {out[0],out[1],out[2],out[3],out[4],out[5],out[6],out[7]} = in;</span><br><span class=line>	</span><br><span class=line>	/*</span><br><span class=line>	// I know you're dying to know how to use a loop to do this:</span><br><span class=line></span><br><span class=line>	// Create a combinational always block. This creates combinational logic that computes the same result</span><br><span class=line>	// as sequential code. for-loops describe circuit *behaviour*, not *structure*, so they can only be used </span><br><span class=line>	// inside procedural blocks (e.g., always block).</span><br><span class=line>	// The circuit created (wires and gates) does NOT do any iteration: It only produces the same result</span><br><span class=line>	// AS IF the iteration occurred. In reality, a logic synthesizer will do the iteration at compile time to</span><br><span class=line>	// figure out what circuit to produce. (In contrast, a Verilog simulator will execute the loop sequentially</span><br><span class=line>	// during simulation.)</span><br><span class=line>	always @(*) begin	</span><br><span class=line>		for (int i=0; i&lt;8; i++)	// int is a SystemVerilog type. Use integer for pure Verilog.</span><br><span class=line>			out[i] = in[8-i-1];</span><br><span class=line>	end</span><br><span class=line></span><br><span class=line></span><br><span class=line>	// It is also possible to do this with a generate-for loop. Generate loops look like procedural for loops,</span><br><span class=line>	// but are quite different in concept, and not easy to understand. Generate loops are used to make instantiations</span><br><span class=line>	// of "things" (Unlike procedural loops, it doesn't describe actions). These "things" are assign statements,</span><br><span class=line>	// module instantiations, net/variable declarations, and procedural blocks (things you can create when NOT inside </span><br><span class=line>	// a procedure). Generate loops (and genvars) are evaluated entirely at compile time. You can think of generate</span><br><span class=line>	// blocks as a form of preprocessing to generate more code, which is then run though the logic synthesizer.</span><br><span class=line>	// In the example below, the generate-for loop first creates 8 assign statements at compile time, which is then</span><br><span class=line>	// synthesized.</span><br><span class=line>	// Note that because of its intended usage (generating code at compile time), there are some restrictions</span><br><span class=line>	// on how you use them. Examples: 1. Quartus requires a generate-for loop to have a named begin-end block</span><br><span class=line>	// attached (in this example, named "my_block_name"). 2. Inside the loop body, genvars are read only.</span><br><span class=line>	generate</span><br><span class=line>		genvar i;</span><br><span class=line>		for (i=0; i&lt;8; i = i+1) begin: my_block_name</span><br><span class=line>			assign out[i] = in[8-i-1];</span><br><span class=line>		end</span><br><span class=line>	endgenerate</span><br><span class=line>	*/</span><br><span class=line>	</span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=重复操作>重复操作</h3><p>声明语法：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>{num{vector}}</span><br></pre></table></figure><p>示例<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>{5{1'b1}}           // 5'b11111 (or 5'd31 or 5'h1f)</span><br><span class=line>{2{a,b,c}}          // The same as {a,b,c,a,b,c}</span><br><span class=line>{3'd5, {2{3'd6}}}   // 9'b101_110_110. It's a concatenation of 101 with</span><br><span class=line>                    // the second vector, which is two copies of 3'b110.</span><br></pre></table></figure><p>将8位数据扩展为32位，高24位为符号位（bit[7]），余下8位为输入<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input [7:0] in,</span><br><span class=line>	output [31:0] out</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>	// Concatenate two things together:</span><br><span class=line>	// 1: {in[7]} repeated 24 times (24 bits)</span><br><span class=line>	// 2: in[7:0] (8 bits)</span><br><span class=line>	assign out = { {24{in[7]}}, in };</span><br><span class=line>	</span><br><span class=line>endmodule</span><br></pre></table></figure><p>描述电路<p><img src=https://hdlbits.01xz.net/mw/images/a/ac/Vector5.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input a, b, c, d, e,</span><br><span class=line>	output [24:0] out</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>	wire [24:0] top, bottom;</span><br><span class=line>	assign top    = { {5{a}}, {5{b}}, {5{c}}, {5{d}}, {5{e}} };</span><br><span class=line>	assign bottom = {5{a,b,c,d,e}};</span><br><span class=line>	assign out = ~top ^ bottom;	// Bitwise XNOR</span><br><span class=line></span><br><span class=line>	// This could be done on one line:</span><br><span class=line>	// assign out = ~{ {5{a}}, {5{b}}, {5{c}}, {5{d}}, {5{e}} } ^ {5{a,b,c,d,e}};</span><br><span class=line>	</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h2 id=模块module>模块Module</h2><h3 id=基本使用-1>基本使用</h3><p>基本语法<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>module mod_a ( input in1, input in2, output out );</span><br><span class=line>    // Module body</span><br><span class=line>endmodule</span><br></pre></table></figure><p>线与模块端口连接有两种方式：通过位置和通过名称<p>通过位置连接，模块实例<code>instance1</code>三个端口分别连接线<code>wa</code>, <code>wb</code>, <code>wc</code>：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mod_a instance1 ( wa, wb, wc );</span><br></pre></table></figure><p>通过名称连接，模块实例<code>instance2</code>三个端口名称与对应线连接：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mod_a instance2 ( .out(wc), .in1(wa), .in2(wb) );</span><br></pre></table></figure><p>描述电路，其中模块<code>mod_a</code>在其他地方描述<p><img src=https://hdlbits.01xz.net/mw/images/c/c0/Module.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input a,</span><br><span class=line>	input b,</span><br><span class=line>	output out</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>	// Create an instance of "mod_a" named "inst1", and connect ports by name:</span><br><span class=line>	mod_a inst1 ( </span><br><span class=line>		.in1(a), 	// Port"in1"connects to wire "a"</span><br><span class=line>		.in2(b),	// Port "in2" connects to wire "b"</span><br><span class=line>		.out(out)	// Port "out" connects to wire "out" </span><br><span class=line>				// (Note: mod_a's port "out" is not related to top_module's wire "out". </span><br><span class=line>				// It is simply coincidence that they have the same name)</span><br><span class=line>	);</span><br><span class=line></span><br><span class=line>/*</span><br><span class=line>	// Create an instance of "mod_a" named "inst2", and connect ports by position:</span><br><span class=line>	mod_a inst2 ( a, b, out );	// The three wires are connected to ports in1, in2, and out, respectively.</span><br><span class=line>*/</span><br><span class=line>	</span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=移位模块>移位模块</h3><p>给已经实现的D触发器（D flip-flop）模块<code>module my_dff ( input clk, input d, output q );</code>，按下图描述电路<p><img src=https://hdlbits.01xz.net/mw/images/6/60/Module_shift.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>module top_module ( input clk, input d, output q );</span><br><span class=line>    wire q1,q2;</span><br><span class=line>    </span><br><span class=line>    my_dff d1 (clk, d, q1);</span><br><span class=line>    my_dff d2 (clk, q1, q2);</span><br><span class=line>    my_dff d3 (clk, q2, q);</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=位移位器>8位移位器</h3><p>描绘电路<p><img src=https://hdlbits.01xz.net/mw/images/7/76/Module_shift8.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input clk,</span><br><span class=line>	input [7:0] d,</span><br><span class=line>	input [1:0] sel,</span><br><span class=line>	output reg [7:0] q</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>	wire [7:0] o1, o2, o3;		// output of each my_dff8</span><br><span class=line>	</span><br><span class=line>	// Instantiate three my_dff8s</span><br><span class=line>	my_dff8 d1 ( clk, d, o1 );</span><br><span class=line>	my_dff8 d2 ( clk, o1, o2 );</span><br><span class=line>	my_dff8 d3 ( clk, o2, o3 );</span><br><span class=line></span><br><span class=line>	// This is one way to make a 4-to-1 multiplexer</span><br><span class=line>	always @(*) begin		// Combinational always block</span><br><span class=line>		case(sel)</span><br><span class=line>			2'h0: q = d;</span><br><span class=line>			2'h1: q = o1;</span><br><span class=line>			2'h2: q = o2;</span><br><span class=line>			2'h3: q = o3;</span><br><span class=line>		endcase</span><br><span class=line>	end</span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=全加器>全加器</h3><p>add16全加器已经定义<code>module add16 ( input[15:0] **a**, input[15:0] **b**, input **cin**, output[15:0] **sum**, output **cout** );</code>，它包含16个add1全加器，描述电路<p><img src=https://hdlbits.01xz.net/mw/images/f/f3/Module_fadd.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>    input [31:0] a,</span><br><span class=line>    input [31:0] b,</span><br><span class=line>    output [31:0] sum</span><br><span class=line>);</span><br><span class=line>	wire o1,o2;</span><br><span class=line>    </span><br><span class=line>    add16 inst1(a[15:0],b[15:0],0,sum[15:0],o1);</span><br><span class=line>    add16 inst2(a[31:16],b[31:16],o1,sum[31:16],o2);</span><br><span class=line>endmodule</span><br><span class=line></span><br><span class=line>module add1 ( input a, input b, input cin,   output sum, output cout );</span><br><span class=line>// Full adder module here</span><br><span class=line>    assign sum = cin ? ~(a^b) : a^b;</span><br><span class=line>    assign cout = cin ? a|b : a&b;</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=加减器>加减器</h3><p>减法器由全加器变化而来，只需将对第二个操作数取补码即可（反码加一）。等效的电路可以有两种效果：<code>a+b+0</code>和<code>a+~b+1</code>。<p><img src=https://hdlbits.01xz.net/mw/images/a/ae/Module_addsub.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>module top_module(</span><br><span class=line>    input [31:0] a,</span><br><span class=line>    input [31:0] b,</span><br><span class=line>    input sub,</span><br><span class=line>    output [31:0] sum</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>    wire o1,o2;</span><br><span class=line>    wire [31:0] b1 = b^{32{sub}};</span><br><span class=line>    </span><br><span class=line>    add16 inst1(a[15:0],b1[15:0],sub,sum[15:0],o1);</span><br><span class=line>    add16 inst2(a[31:16],b1[31:16],o1,sum[31:16],o2);</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h2 id=过程procedure>过程Procedure</h2><p>对于综合硬件，有两种相关always块：<ul><li>组合型：<code>always @(*)</code><li>时序型：<code>always @(posedge clk)</code></ul><p>块语句需要使用<code>begin</code>和<code>end</code>标记出来，若语句只有“单句”时，块标记可以省略。<h3 id=always块>Always块</h3><p>对于简单的场景，组合型always块等价于assign语句。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>assign out1 = a & b | c ^ d;</span><br><span class=line>always @(*) out2 = a & b | c ^ d;</span><br></pre></table></figure><p>assign语句左边符号对应的类型是net（例如：wire），而过程赋值对应的类型是variable（例如：reg）。两者的差异不会对综合的电路产生任何影响，只是一种不成文的约定。<p>在VHDL中有三种赋值类型：<ul><li>持续赋值<code>assign x = y;</code><li>过程阻塞赋值，在过程中使用<code>x = y;</code><li>过程非阻塞赋值，在过程中使用<code>x &lt;= y;</code></ul><p>在组合alsways块中，使用阻塞赋值。在时序always块中，使用非阻塞赋值。<p>使用三种方式，用异或门构建电路。值得注意的是，第三种方式产生的结果会因为有触发器而产生延时。<p><img src=https://hdlbits.01xz.net/mw/images/4/40/Alwaysff.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module(</span><br><span class=line>    input clk,</span><br><span class=line>    input a,</span><br><span class=line>    input b,</span><br><span class=line>    output wire out_assign,</span><br><span class=line>    output reg out_always_comb,</span><br><span class=line>    output reg out_always_ff   );</span><br><span class=line></span><br><span class=line>    assign out_assign = a^b;</span><br><span class=line>    always @(*) out_always_comb = a^b;</span><br><span class=line>    always @(posedge clk) out_always_ff &lt;= a^b;</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=if语句>if语句</h3><p>描绘一个2-1选择器<p><img src=https://hdlbits.01xz.net/mw/images/9/9d/Always_if_mux.png><p>对应的值表<table><thead><tr class=header><th style="text-align: left;">sel_b1<th style="text-align: left;">sel_b2<th style="text-align: left;">out_assign out_always<tbody><tr class=odd><td style="text-align: left;">0<td style="text-align: left;">0<td style="text-align: left;">a<tr class=even><td style="text-align: left;">0<td style="text-align: left;">1<td style="text-align: left;">a<tr class=odd><td style="text-align: left;">1<td style="text-align: left;">0<td style="text-align: left;">a<tr class=even><td style="text-align: left;">1<td style="text-align: left;">1<td style="text-align: left;">b</table><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module(</span><br><span class=line>    input a,</span><br><span class=line>    input b,</span><br><span class=line>    input sel_b1,</span><br><span class=line>    input sel_b2,</span><br><span class=line>    output wire out_assign,</span><br><span class=line>    output reg out_always   ); </span><br><span class=line></span><br><span class=line>    assign out_assign = sel_b1&sel_b2 ? b : a;</span><br><span class=line>    </span><br><span class=line>    always @(*) begin</span><br><span class=line>        if (sel_b1&sel_b2) begin</span><br><span class=line>            out_always = b;</span><br><span class=line>        end</span><br><span class=line>        else begin</span><br><span class=line>            out_always = a;</span><br><span class=line>        end</span><br><span class=line>    end</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=if语句锁存>if语句锁存</h3><p>修复下图错误，当<code>cpu_overheated</code>时，产生关闭信号（<code>shut_off_computer</code>设置为1）。<p>修改前，错误的示意图<p><img src=https://hdlbits.01xz.net/mw/images/d/d1/Always_if2.png><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module (</span><br><span class=line>    input      cpu_overheated,</span><br><span class=line>    output reg shut_off_computer,</span><br><span class=line>    input      arrived,</span><br><span class=line>    input      gas_tank_empty,</span><br><span class=line>    output reg keep_driving  ); //</span><br><span class=line></span><br><span class=line>    always @(*) begin</span><br><span class=line>        if (cpu_overheated)</span><br><span class=line>           shut_off_computer = 1;</span><br><span class=line>    end</span><br><span class=line></span><br><span class=line>    always @(*) begin</span><br><span class=line>        if (~arrived)</span><br><span class=line>           keep_driving = ~gas_tank_empty;</span><br><span class=line>    end</span><br><span class=line></span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><p>修改后<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module (</span><br><span class=line>    input      cpu_overheated,</span><br><span class=line>    output reg shut_off_computer,</span><br><span class=line>    input      arrived,</span><br><span class=line>    input      gas_tank_empty,</span><br><span class=line>    output reg keep_driving  ); //</span><br><span class=line></span><br><span class=line>    always @(*) begin</span><br><span class=line>        if (cpu_overheated)</span><br><span class=line>           shut_off_computer = 1;</span><br><span class=line>        else</span><br><span class=line>           shut_off_computer = 0;</span><br><span class=line>    end</span><br><span class=line></span><br><span class=line>    always @(*) begin</span><br><span class=line>        if (~arrived)</span><br><span class=line>           keep_driving = ~gas_tank_empty;</span><br><span class=line>        else</span><br><span class=line>           keep_driving = 0;</span><br><span class=line>    end</span><br><span class=line></span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=case语句>case语句</h3><p>基本语法<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>case (cond)</span><br><span class=line>	2'h0: statments0;</span><br><span class=line>	2'h1: statments1;</span><br><span class=line>	...</span><br><span class=line>	default: statmentsx;</span><br><span class=line>endcase</span><br></pre></table></figure><p>建立一个6-1选择器，否则输出0<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module ( </span><br><span class=line>    input [2:0] sel, </span><br><span class=line>    input [3:0] data0,</span><br><span class=line>    input [3:0] data1,</span><br><span class=line>    input [3:0] data2,</span><br><span class=line>    input [3:0] data3,</span><br><span class=line>    input [3:0] data4,</span><br><span class=line>    input [3:0] data5,</span><br><span class=line>    output reg [3:0] out   );//</span><br><span class=line></span><br><span class=line>    always@(*) begin  // This is a combinational circuit</span><br><span class=line>        case(sel)</span><br><span class=line>            4'h0: out = data0;</span><br><span class=line>            4'h1: out = data1;</span><br><span class=line>            4'h2: out = data2;</span><br><span class=line>            4'h3: out = data3;</span><br><span class=line>            4'h4: out = data4;</span><br><span class=line>            4'h5: out = data5;</span><br><span class=line>            default: out = 0;</span><br><span class=line>        endcase</span><br><span class=line>    end</span><br><span class=line></span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><p>构建一个4bits的优先编码器，输出第一个1所在的比特位。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input [3:0] in,</span><br><span class=line>	output reg [1:0] pos</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>	always @(*) begin			// Combinational always block</span><br><span class=line>		case (in)</span><br><span class=line>			4'h0: pos = 2'h0;	// I like hexadecimal because it saves typing.</span><br><span class=line>			4'h1: pos = 2'h0;</span><br><span class=line>			4'h2: pos = 2'h1;</span><br><span class=line>			4'h3: pos = 2'h0;</span><br><span class=line>			4'h4: pos = 2'h2;</span><br><span class=line>			4'h5: pos = 2'h0;</span><br><span class=line>			4'h6: pos = 2'h1;</span><br><span class=line>			4'h7: pos = 2'h0;</span><br><span class=line>			4'h8: pos = 2'h3;</span><br><span class=line>			4'h9: pos = 2'h0;</span><br><span class=line>			4'ha: pos = 2'h1;</span><br><span class=line>			4'hb: pos = 2'h0;</span><br><span class=line>			4'hc: pos = 2'h2;</span><br><span class=line>			4'hd: pos = 2'h0;</span><br><span class=line>			4'he: pos = 2'h1;</span><br><span class=line>			4'hf: pos = 2'h0;</span><br><span class=line>			default: pos = 2'b0;	// Default case is not strictly necessary because all 16 combinations are covered.</span><br><span class=line>		endcase</span><br><span class=line>	end</span><br><span class=line>	</span><br><span class=line>	// There is an easier way to code this. See the next problem (always_casez).</span><br><span class=line>	</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=casez>casez</h3><p>当部分比特位不关心时，可以使用<code>casez</code>。符号<code>z</code>和<code>?</code>在一下场景都是等价的。与<code>casez</code>类似的是<code>casex</code>，后者使用符号<code>x</code>。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>always @(*) begin</span><br><span class=line>    casez (in[3:0])</span><br><span class=line>        4'bzzz1: out = 0;   // in[3:1] can be anything</span><br><span class=line>        4'bzz1z: out = 1;</span><br><span class=line>        4'b?1??: out = 2;</span><br><span class=line>        4'b1???: out = 3;</span><br><span class=line>        default: out = 0;</span><br><span class=line>    endcase</span><br><span class=line>end</span><br></pre></table></figure><p>构建8bits优先编码器<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module (</span><br><span class=line>    input [7:0] in,</span><br><span class=line>    output reg [2:0] pos );</span><br><span class=line>	</span><br><span class=line>    always @(*) begin</span><br><span class=line>        casez (in[7:0])</span><br><span class=line>            8'h0: pos = 0;</span><br><span class=line>            8'bzzzz_???1: pos = 0;</span><br><span class=line>            8'bzzzz_zz10: pos = 1;</span><br><span class=line>            8'bzzzz_z100: pos = 2;</span><br><span class=line>            8'bzzzz_1000: pos = 3;</span><br><span class=line>            8'bzzz1_0000: pos = 4;</span><br><span class=line>            8'bzz10_0000: pos = 5;</span><br><span class=line>            8'bz100_0000: pos = 6;</span><br><span class=line>            8'b1000_0000: pos = 7;</span><br><span class=line>            default: pos = 3'bzzz;</span><br><span class=line>        endcase</span><br><span class=line>    end</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=键盘扫描码>键盘扫描码</h3><p>处理如下四个按键<table><thead><tr class=header><th style="text-align: left;">Scancode [15:0]<th style="text-align: left;">Arrow key<tbody><tr class=odd><td style="text-align: left;"><code>16'he06b</code><td style="text-align: left;">left arrow<tr class=even><td style="text-align: left;"><code>16'he072</code><td style="text-align: left;">down arrow<tr class=odd><td style="text-align: left;"><code>16'he074</code><td style="text-align: left;">right arrow<tr class=even><td style="text-align: left;"><code>16'he075</code><td style="text-align: left;">up arrow<tr class=odd><td style="text-align: left;">Anything else<td style="text-align: left;">none</table><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>// synthesis verilog_input_version verilog_2001</span><br><span class=line>module top_module (</span><br><span class=line>    input [15:0] scancode,</span><br><span class=line>    output reg left,</span><br><span class=line>    output reg down,</span><br><span class=line>    output reg right,</span><br><span class=line>    output reg up  ); </span><br><span class=line></span><br><span class=line>    always @(*) begin</span><br><span class=line>        left = 0; down = 0; right = 0; up = 0;</span><br><span class=line>        case (scancode)</span><br><span class=line>            16'he06b: left = 1;</span><br><span class=line>            16'he072: down = 1;</span><br><span class=line>            16'he074: right = 1;</span><br><span class=line>            16'he075: up = 1;</span><br><span class=line>            default: ;</span><br><span class=line>        endcase</span><br><span class=line>    end</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h2 id=更多特性>更多特性</h2><h3 id=条件>条件</h3><p>三元条件操作符<code>?:</code><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>(condition ? if_true : if_false)</span><br></pre></table></figure><h3 id=逻辑操作简化>逻辑操作简化</h3><p>若需要对向量所有位进行门操作时，正常书写比较冗余，可以对与、或和异或操作简化<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>& a[3:0]     // AND: a[3]&a[2]&a[1]&a[0]. Equivalent to (a[3:0] == 4'hf)</span><br><span class=line>| b[3:0]     // OR:  b[3]|b[2]|b[1]|b[0]. Equivalent to (b[3:0] != 4'h0)</span><br><span class=line>^ c[2:0]     // XOR: c[2]^c[1]^c[0]</span><br></pre></table></figure><p>实现奇偶校验位算法<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>    input [7:0] in,</span><br><span class=line>    output parity); </span><br><span class=line></span><br><span class=line>    assign parity = ^in[7:0];</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=bits翻转>100bits翻转</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input [99:0] in,</span><br><span class=line>	output reg [99:0] out</span><br><span class=line>);</span><br><span class=line>	</span><br><span class=line>	always @(*) begin</span><br><span class=line>		for (int i=0;i&lt;$bits(out);i++)		// $bits() is a system function that returns the width of a signal.</span><br><span class=line>			out[i] = in[$bits(out)-i-1];	// $bits(out) is 100 because out is 100 bits wide.</span><br><span class=line>	end</span><br><span class=line>	</span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=比特1计数>比特1计数</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input [254:0] in,</span><br><span class=line>    output [7:0] out );</span><br><span class=line></span><br><span class=line>    always @(*) begin	// Combinational always block</span><br><span class=line>        out = 0;</span><br><span class=line>        for (int i=0; i&lt;$bits(in); i++)</span><br><span class=line>            out += in[i];</span><br><span class=line>    end</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h3 id=bits全加器>100bits全加器</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input [99:0] a, b,</span><br><span class=line>    input cin,</span><br><span class=line>    output [99:0] cout,</span><br><span class=line>    output [99:0] sum );</span><br><span class=line>    </span><br><span class=line>	genvar i;</span><br><span class=line>	generate</span><br><span class=line>	    for (i=0; i&lt;$bits(a); ++i) begin: adder_gen</span><br><span class=line>	        adder_1bit u_adder (</span><br><span class=line>	            .a(a[i]),</span><br><span class=line>	            .b(b[i]),</span><br><span class=line>	            .cin(i==0?cin:cout[i-1]),</span><br><span class=line>	            .sum(sum[i]),</span><br><span class=line>	            .cout(cout[i])</span><br><span class=line>	        );</span><br><span class=line>	    end</span><br><span class=line>	endgenerate</span><br><span class=line>    </span><br><span class=line>endmodule</span><br><span class=line></span><br><span class=line>module adder_1bit (</span><br><span class=line>    input a,b,</span><br><span class=line>    input cin,</span><br><span class=line>    output cout,</span><br><span class=line>    output sum</span><br><span class=line>);</span><br><span class=line>    assign {cout,sum} = a+b+cin;</span><br><span class=line>    // assign sum = cin ? ~(a^b) : a^b;</span><br><span class=line>    // assign cout = cin ? a|b : a&b;</span><br><span class=line>endmodule</span><br></pre></table></figure><h3 id=位bcd码全加器>100位BCD码全加器</h3><p>已经定义1位BCD码全加器<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>module bcd_fadd (</span><br><span class=line>    input [3:0] a,</span><br><span class=line>    input [3:0] b,</span><br><span class=line>    input     cin,</span><br><span class=line>    output   cout,</span><br><span class=line>    output [3:0] sum );</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input [399:0] a, b,</span><br><span class=line>    input cin,</span><br><span class=line>    output cout,</span><br><span class=line>    output [399:0] sum );</span><br><span class=line></span><br><span class=line>    wire [100:0] c;</span><br><span class=line>    assign cout = c[100];</span><br><span class=line>    assign c[0] = cin;</span><br><span class=line></span><br><span class=line>    genvar i;</span><br><span class=line>    generate</span><br><span class=line>        for(i=0; i&lt;100; ++i) begin: bcd_gen</span><br><span class=line>            bcd_fadd u_bcd (</span><br><span class=line>                .a( a[(4*i+3):(4*i)] ),</span><br><span class=line>                .b( b[(4*i+3):(4*i)] ),</span><br><span class=line>                .cin( c[i] ),</span><br><span class=line>                .cout( c[i+1] ),</span><br><span class=line>                .sum( sum[(4*i+3):(4*i)] )</span><br><span class=line>            );</span><br><span class=line>        end</span><br><span class=line>    endgenerate</span><br><span class=line>    </span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><h2 id=仿真>仿真</h2><h3 id=timescale>timescale</h3><p>定义仿真中时间单位的比例。它的作用是指定时序仿真中时间单位的大小，以便仿真器可以正确地模拟设计中的时序行为。<p>基本语法<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>`timescale unit / precision</span><br></pre></table></figure><p>其中，<code>unit</code>是时间单位，可以是<code>1ns</code>、<code>1ps</code>、<code>1us</code>等，表示一个时钟周期的时间长度；<code>precision</code>是时间精度，表示仿真的最小时间单位；<h3 id=num>#num</h3><p>等待num个时间单位后，执行后面的语句。<p>基本语法<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>#num statement</span><br></pre></table></figure><h3 id=task>task</h3><p>Verilog语言中具有类似C语言函数的结构有task和function，他们可以增加代码可读性和重复使用性。Function用来描述组合逻辑，只能有一个返回值，function的内部不能包含时序控制。Task类似procedure，执行一段verilog代码，task中可以有任意数量的输入和输出，task也可以包含时序控制。<p>基本语法<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>task TASK_NAME;</span><br><span class=line>endtask</span><br></pre></table></figure><h3 id=ps2键盘设备仿真>PS/2键盘设备仿真</h3><p>当用户按键或松开时，键盘以每帧11位的格式串行传送数据给主机，同时在PS2_CLK时钟信号上传输对应的时钟（一般为10.0–16.7kHz）。第一位是开始位（逻辑0），后面跟8位数据位（低位在前），一个奇偶校验位（奇校验）和一位停止位（逻辑1）。每位都在时钟的 <strong>下降沿</strong> 有效，下图显示了键盘传送一字节数据的时序。在下降沿有效的主要原因是下降沿正好在数据位的中间，因此可以让数据位从开始变化到接收采样时能有一段信号建立时间。<figure><img alt=键盘输出数据时序图 src=https://nju-projectn.github.io/dlco-lecture-note/_images/ps01.png><figcaption aria-hidden=true>键盘输出数据时序图</figcaption></figure><p>键盘通过PS2_DAT引脚发送的信息称为扫描码，每个扫描码可以由单个数据帧或连续多个数据帧构成。当按键被按下时送出的扫描码被称为 <code>通码（Make Code）</code> ，当按键被释放时送出的扫描码称为 <code>断码（Break Code）</code> 。以 <code>W</code> 键为例， <code>W</code> 键的通码是1Dh，如果 <code>W</code> 键被按下，则PS2_DAT引脚将输出一帧数据，其中的8位数据位为1Dh，如果 <code>W</code> 键一直没有释放，则不断输出扫描码1Dh 1Dh … 1Dh，直到有其他键按下或者 <code>W</code> 键被放开。某按键的断码是F0h加此按键的通码，如释放 <code>W</code> 键时输出的断码为F0h 1Dh，分两帧传输。<p>多个键被同时按下时，将逐个输出扫描码，如：先按左 <code>Shift</code> 键（扫描码为12h）、再按 <code>W</code> 键、放开 <code>W</code> 键、再放开左 <code>Shift</code> 键，则此过程送出的全部扫描码为：12h 1Dh F0h 1Dh F0h 12h。<p><strong>键盘扫描码</strong><p>每个键都有唯一的通码和断码。键盘所有键的扫描码组成的集合称为扫描码集。共有三套标准的扫描码集，所有现代的键盘默认使用第二套扫描码。下图显示了键盘各键的扫描码（以十六进制表示），如Caps键的扫描码是58h。 下图可以看出，键盘上各按键的扫描码是随机排列的，如果想迅速的将键盘扫描码转换为ASCII码，一个最简单的方法就是利用查找表 <a href=https://en.wikipedia.org/wiki/Lookup_table rel=noopener target=_blank>LookUp Table, LUT</a> ，扫描码到ASCII码的转换表格请读者自己生成。<figure><img alt=键盘扫描码 src=https://nju-projectn.github.io/dlco-lecture-note/_images/ps02.png><figcaption aria-hidden=true>键盘扫描码</figcaption></figure><figure><img alt=扩展键盘和数字键盘的扫描码 src=https://nju-projectn.github.io/dlco-lecture-note/_images/ps03.png><figcaption aria-hidden=true>扩展键盘和数字键盘的扫描码</figcaption></figure><p>键盘控制器<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br></pre><td class=code><pre><span class=line>module ps2_keyboard(clk,clrn,ps2_clk,ps2_data,data,</span><br><span class=line>                    ready,nextdata_n,overflow);</span><br><span class=line>    input clk,clrn,ps2_clk,ps2_data;</span><br><span class=line>    input nextdata_n;</span><br><span class=line>    output [7:0] data;</span><br><span class=line>    output reg ready;</span><br><span class=line>    output reg overflow;     // fifo overflow</span><br><span class=line>    // internal signal, for test</span><br><span class=line>    reg [9:0] buffer;        // ps2_data bits</span><br><span class=line>    reg [7:0] fifo[7:0];     // data fifo</span><br><span class=line>    reg [2:0] w_ptr,r_ptr;   // fifo write and read pointers</span><br><span class=line>    reg [3:0] count;  // count ps2_data bits</span><br><span class=line>    // detect falling edge of ps2_clk</span><br><span class=line>    reg [2:0] ps2_clk_sync;</span><br><span class=line></span><br><span class=line>    always @(posedge clk) begin</span><br><span class=line>        ps2_clk_sync &lt;=  {ps2_clk_sync[1:0],ps2_clk};</span><br><span class=line>    end</span><br><span class=line></span><br><span class=line>    wire sampling = ps2_clk_sync[2] & ~ps2_clk_sync[1];</span><br><span class=line></span><br><span class=line>    always @(posedge clk) begin</span><br><span class=line>        if (clrn == 0) begin // reset</span><br><span class=line>            count &lt;= 0; w_ptr &lt;= 0; r_ptr &lt;= 0; overflow &lt;= 0; ready&lt;= 0;</span><br><span class=line>        end</span><br><span class=line>        else begin</span><br><span class=line>            if ( ready ) begin // read to output next data</span><br><span class=line>                if(nextdata_n == 1'b0) //read next data</span><br><span class=line>                begin</span><br><span class=line>                    r_ptr &lt;= r_ptr + 3'b1;</span><br><span class=line>                    if(w_ptr==(r_ptr+1'b1)) //empty</span><br><span class=line>                        ready &lt;= 1'b0;</span><br><span class=line>                end</span><br><span class=line>            end</span><br><span class=line>            if (sampling) begin</span><br><span class=line>              if (count == 4'd10) begin</span><br><span class=line>                if ((buffer[0] == 0) &&  // start bit</span><br><span class=line>                    (ps2_data)       &&  // stop bit</span><br><span class=line>                    (^buffer[9:1])) begin      // odd  parity</span><br><span class=line>                    fifo[w_ptr] &lt;= buffer[8:1];  // kbd scan code</span><br><span class=line>                    w_ptr &lt;= w_ptr+3'b1;</span><br><span class=line>                    ready &lt;= 1'b1;</span><br><span class=line>                    overflow &lt;= overflow | (r_ptr == (w_ptr + 3'b1));</span><br><span class=line>                end</span><br><span class=line>                count &lt;= 0;     // for next</span><br><span class=line>              end else begin</span><br><span class=line>                buffer[count] &lt;= ps2_data;  // store ps2_data</span><br><span class=line>                count &lt;= count + 3'b1;</span><br><span class=line>              end</span><br><span class=line>            end</span><br><span class=line>        end</span><br><span class=line>    end</span><br><span class=line>    assign data = fifo[r_ptr]; //always set output data</span><br><span class=line></span><br><span class=line>endmodule</span><br></pre></table></figure><p>键盘仿真模型<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line>`timescale 1ns / 1ps</span><br><span class=line>module ps2_keyboard_model(</span><br><span class=line>    output reg ps2_clk,</span><br><span class=line>    output reg ps2_data</span><br><span class=line>    );</span><br><span class=line>parameter [31:0] kbd_clk_period = 60;</span><br><span class=line>initial ps2_clk = 1'b1;</span><br><span class=line></span><br><span class=line>task kbd_sendcode;</span><br><span class=line>    input [7:0] code; // key to be sent</span><br><span class=line>    integer i;</span><br><span class=line></span><br><span class=line>    reg[10:0] send_buffer;</span><br><span class=line>    begin</span><br><span class=line>        send_buffer[0]   = 1'b0;  // start bit</span><br><span class=line>        send_buffer[8:1] = code;  // code</span><br><span class=line>        send_buffer[9]   = ~(^code); // odd parity bit</span><br><span class=line>        send_buffer[10]  = 1'b1;  // stop bit</span><br><span class=line>        i = 0;</span><br><span class=line>        while( i &lt; 11) begin</span><br><span class=line>            // set kbd_data</span><br><span class=line>            ps2_data = send_buffer[i];</span><br><span class=line>            #(kbd_clk_period/2) ps2_clk = 1'b0;</span><br><span class=line>            #(kbd_clk_period/2) ps2_clk = 1'b1;</span><br><span class=line>            i = i + 1;</span><br><span class=line>        end</span><br><span class=line>    end</span><br><span class=line>endtask</span><br><span class=line></span><br><span class=line>endmodule</span><br></pre></table></figure><p>键盘测试代码<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line>`timescale 1ns / 1ps</span><br><span class=line>module keyboard_sim;</span><br><span class=line></span><br><span class=line>/* parameter */</span><br><span class=line>parameter [31:0] clock_period = 10;</span><br><span class=line></span><br><span class=line>/* ps2_keyboard interface signals */</span><br><span class=line>reg clk,clrn;</span><br><span class=line>wire [7:0] data;</span><br><span class=line>wire ready,overflow;</span><br><span class=line>wire kbd_clk, kbd_data;</span><br><span class=line>reg nextdata_n;</span><br><span class=line></span><br><span class=line>ps2_keyboard_model model(</span><br><span class=line>    .ps2_clk(kbd_clk),</span><br><span class=line>    .ps2_data(kbd_data)</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>ps2_keyboard inst(</span><br><span class=line>    .clk(clk),</span><br><span class=line>    .clrn(clrn),</span><br><span class=line>    .ps2_clk(kbd_clk),</span><br><span class=line>    .ps2_data(kbd_data),</span><br><span class=line>    .data(data),</span><br><span class=line>    .ready(ready),</span><br><span class=line>    .nextdata_n(nextdata_n),</span><br><span class=line>    .overflow(overflow)</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>initial begin /* clock driver */</span><br><span class=line>    clk = 0;</span><br><span class=line>    forever</span><br><span class=line>        #(clock_period/2) clk = ~clk;</span><br><span class=line>end</span><br><span class=line></span><br><span class=line>initial begin</span><br><span class=line>    clrn = 1'b0;  #20;</span><br><span class=line>    clrn = 1'b1;  #20;</span><br><span class=line>    model.kbd_sendcode(8'h1C); // press 'A'</span><br><span class=line>    #20 nextdata_n =1'b0; #20 nextdata_n =1'b1;//read data</span><br><span class=line>    model.kbd_sendcode(8'hF0); // break code</span><br><span class=line>    #20 nextdata_n =1'b0; #20 nextdata_n =1'b1; //read data</span><br><span class=line>    model.kbd_sendcode(8'h1C); // release 'A'</span><br><span class=line>    #20 nextdata_n =1'b0; #20 nextdata_n =1'b1; //read data</span><br><span class=line>    model.kbd_sendcode(8'h1B); // press 'S'</span><br><span class=line>    #20 model.kbd_sendcode(8'h1B); // keep pressing 'S'</span><br><span class=line>    #20 model.kbd_sendcode(8'h1B); // keep pressing 'S'</span><br><span class=line>    model.kbd_sendcode(8'hF0); // break code</span><br><span class=line>    model.kbd_sendcode(8'h1B); // release 'S'</span><br><span class=line>    #20;</span><br><span class=line>    $stop;</span><br><span class=line>end</span><br><span class=line></span><br><span class=line>endmodule</span><br></pre></table></figure><h1 id=电路>电路</h1><h2 id=组合逻辑>组合逻辑</h2><h3 id=基本门>基本门</h3><p>GND<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>assign out = 1'b0;</span><br></pre></table></figure><p>NOR<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>assign out = ~(in1|in2);</span><br></pre></table></figure><h3 id=多路选择器>多路选择器</h3><p>9路选择器<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>module top_module( </span><br><span class=line>    input [15:0] a, b, c, d, e, f, g, h, i,</span><br><span class=line>    input [3:0] sel,</span><br><span class=line>    output [15:0] out );</span><br><span class=line></span><br><span class=line>	// Case statements can only be used inside procedural blocks (always block)</span><br><span class=line>	// This is a combinational circuit, so use a combinational always @(*) block.</span><br><span class=line>	always @(*) begin</span><br><span class=line>		out = '1;		// '1 is a special literal syntax for a number with all bits set to 1.</span><br><span class=line>						// '0, 'x, and 'z are also valid.</span><br><span class=line>						// I prefer to assign a default value to 'out' instead of using a</span><br><span class=line>						// default case.</span><br><span class=line>		case (sel)</span><br><span class=line>			4'h0: out = a;</span><br><span class=line>			4'h1: out = b;</span><br><span class=line>			4'h2: out = c;</span><br><span class=line>			4'h3: out = d;</span><br><span class=line>			4'h4: out = e;</span><br><span class=line>			4'h5: out = f;</span><br><span class=line>			4'h6: out = g;</span><br><span class=line>			4'h7: out = h;</span><br><span class=line>			4'h8: out = i;</span><br><span class=line>		endcase</span><br><span class=line>	end</span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure><p>4位256路选择器<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>module top_module (</span><br><span class=line>	input [1023:0] in,</span><br><span class=line>	input [7:0] sel,</span><br><span class=line>	output [3:0] out</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>	// We can't part-select multiple bits without an error, but we can select one bit at a time,</span><br><span class=line>	// four times, then concatenate them together.</span><br><span class=line>	assign out = {in[sel*4+3], in[sel*4+2], in[sel*4+1], in[sel*4+0]};</span><br><span class=line></span><br><span class=line>	// Alternatively, "indexed vector part select" works better, but has an unfamiliar syntax:</span><br><span class=line>	// assign out = in[sel*4 +: 4];		// Select starting at index "sel*4", then select a total width of 4 bits with increasing (+:) index number.</span><br><span class=line>	// assign out = in[sel*4+3 -: 4];	// Select starting at index "sel*4+3", then select a total width of 4 bits with decreasing (-:) index number.</span><br><span class=line>	// Note: The width (4 in this case) must be constant.</span><br><span class=line></span><br><span class=line>endmodule</span><br><span class=line></span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/04/08/Verilator-%E7%94%B5%E8%B7%AFRTL%E4%BB%BF%E7%9C%9F%E5%99%A8%E4%BD%BF%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/04/08/Verilator-%E7%94%B5%E8%B7%AFRTL%E4%BB%BF%E7%9C%9F%E5%99%A8%E4%BD%BF%E7%94%A8/ itemprop=url>Verilator-电路RTL仿真器使用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-08 11:07:02" datetime=2024-04-08T11:07:02+08:00>2024-04-08</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E7%A1%AC%E4%BB%B6/ itemprop=url rel=index><span itemprop=name>硬件</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>361</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>1 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=使用示例>使用示例</h1><p>南京大学电路教学项目-<a href=https://github.com/NJU-ProjectN/nvboard.git rel=noopener target=_blank>NVboard</a>，可以图形化显示过程状态和数据，同时也支持verilator。<h2 id=双控开关>双控开关</h2><p>Makefile<figure class="highlight makefile"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line>VERILATOR_FLAGS := --build -j 0 -cc --exe -x-assign fast -Wall</span><br><span class=line></span><br><span class=line>C_SRC   :=      <span class=variable>$(<span class=built_in>shell</span> ls csrc/*.cpp)</span></span><br><span class=line>V_SRC   :=  <span class=variable>$(<span class=built_in>shell</span> ls vsrc/*.v)</span></span><br><span class=line>OBJ_DIR :=      obj_dir</span><br><span class=line>TARGET  :=  obj_dir/Vtop</span><br><span class=line><span class=comment>#TARGET_ARGS    := +trace</span></span><br><span class=line></span><br><span class=line><span class=meta><span class=keyword>.PHONY</span>: run clean</span></span><br><span class=line></span><br><span class=line><span class=keyword>ifdef</span> TRACE</span><br><span class=line>VERILATOR_FLAGS += --trace</span><br><span class=line><span class=keyword>endif</span></span><br><span class=line></span><br><span class=line><span class=section>all: ${TARGET}</span></span><br><span class=line></span><br><span class=line><span class=section>run: ${TARGET}</span></span><br><span class=line>        @rm -rf logs</span><br><span class=line>        @${TARGET} ${TARGET_ARGS}</span><br><span class=line></span><br><span class=line><span class=section>${TARGET}: ${V_SRC} ${C_SRC}</span></span><br><span class=line>        <span class=comment>#@verilator --build -j 0 -cc --exe -x-assign fast -Wall --trace $^</span></span><br><span class=line>        @verilator ${VERILATOR_FLAGS} <span class=variable>$^</span></span><br><span class=line></span><br><span class=line><span class=section>sim:</span></span><br><span class=line>        <span class=variable>$(<span class=built_in>call</span> git_commit, <span class=string>"sim RTL"</span>)</span> <span class=comment># DO NOT REMOVE THIS LINE!!!</span></span><br><span class=line>        @echo <span class=string>"Write this Makefile by your self."</span></span><br><span class=line></span><br><span class=line><span class=keyword>include</span> ../Makefile</span><br><span class=line></span><br><span class=line><span class=section>clean:</span></span><br><span class=line>        @rm -rf logs</span><br><span class=line>        @rm -rf ${OBJ_DIR}</span><br></pre></table></figure><p>verilog代码文件<code>top.v</code><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>module top</span><br><span class=line>  (</span><br><span class=line>  input a,</span><br><span class=line>  input b,</span><br><span class=line>  output f</span><br><span class=line>  );</span><br><span class=line></span><br><span class=line>  assign f = a ^ b;</span><br><span class=line></span><br><span class=line>  initial begin</span><br><span class=line>        $display("[%0t] Model running...\n", $time);</span><br><span class=line>  end</span><br><span class=line></span><br><span class=line>endmodule</span><br></pre></table></figure><p>主体仿真文件<code>sim_main.cpp</code><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;stdio.h></span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;stdlib.h></span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;assert.h></span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;stdint.h></span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;memory></span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"Vtop.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"verilated.h"</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>if</span> VM_TRACE_VCD</span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>"verilated_vcd_c.h"</span></span></span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>int</span> argc, <span class=type>char</span>** argv)</span></span><br><span class=line>{</span><br><span class=line>        <span class=type>const</span> <span class=built_in>std</span>::<span class=built_in>unique_ptr</span>&lt;VerilatedContext> contextp{new VerilatedContext};</span><br><span class=line>        contextp->debug(<span class=number>0</span>); <span class=comment>// Set debug level, 0 is off, 9 is highest</span></span><br><span class=line>        contextp->randReset(<span class=number>2</span>); <span class=comment>// Randomization reset policy</span></span><br><span class=line>        contextp->commandArgs(argc, argv); <span class=comment>// Pass arguments so Verilated code can see them</span></span><br><span class=line></span><br><span class=line>        <span class=comment>// "TOP" will be hierarchical name of the module.</span></span><br><span class=line>        <span class=type>const</span> <span class=built_in>std</span>::<span class=built_in>unique_ptr</span>&lt;Vtop> top{new Vtop{contextp.get(), <span class=string>"TOP"</span>}};</span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>if</span> VM_TRACE_VCD</span></span><br><span class=line>        Verilated::mkdir(<span class=string>"logs"</span>);</span><br><span class=line>        contextp->traceEverOn(<span class=literal>true</span>); <span class=comment>// Verilator must compute traced signals</span></span><br><span class=line>        <span class=type>const</span> <span class=built_in>std</span>::<span class=built_in>unique_ptr</span>&lt;VerilatedVcdC>tfp{new VerilatedVcdC};</span><br><span class=line>        top->trace(tfp.get(), <span class=number>99</span>); <span class=comment>// Trace 99 levels of hierarchy (or see below)</span></span><br><span class=line>        tfp->open(<span class=string>"logs/simu_top.vcd"</span>);</span><br><span class=line>        <span class=built_in>printf</span>(<span class=string>"Start trace ...\n"</span>);</span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line></span><br><span class=line>        <span class=type>uint64_t</span> sim_time = <span class=number>10000</span>;</span><br><span class=line>        <span class=keyword>while</span>(contextp->time()&lt;sim_time && !contextp->gotFinish())</span><br><span class=line>        {</span><br><span class=line>                contextp->timeInc(<span class=number>1</span>);</span><br><span class=line></span><br><span class=line>                <span class=type>int</span> a = rand() & <span class=number>1</span>;</span><br><span class=line>                <span class=type>int</span> b = rand() & <span class=number>1</span>;</span><br><span class=line>                top->a = a;</span><br><span class=line>                top->b = b;</span><br><span class=line>                top->eval();</span><br><span class=line>                <span class=comment>// printf("a = %d, b = %d, f = %d, time = %lu\n", a, b, top->f, contextp->time());</span></span><br><span class=line>                assert(top->f == (a ^ b));</span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>if</span> VM_TRACE_VCD</span></span><br><span class=line>                tfp->dump(contextp->time());</span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line>        }</span><br><span class=line></span><br><span class=line>        top->final();</span><br><span class=line></span><br><span class=line>        <span class=comment>// Coverage analysis</span></span><br><span class=line><span class=meta>#<span class=keyword>if</span> VM_COVERAGE</span></span><br><span class=line>        Verilated::mkdir(<span class=string>"logs"</span>);</span><br><span class=line>        contextp->converagep()->write(<span class=string>"logs/coverage.dat"</span>);</span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line></span><br><span class=line>        <span class=comment>// Final simulation summary</span></span><br><span class=line>        contextp->statsPrintSummary();</span><br><span class=line></span><br><span class=line>        <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>}</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/04/04/Linux%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E4%B8%8E%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99%E7%AE%80%E4%BB%8B/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/04/04/Linux%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E4%B8%8E%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99%E7%AE%80%E4%BB%8B/ itemprop=url>Linux命令使用与脚本编写简介</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-04 20:47:25" datetime=2024-04-04T20:47:25+08:00>2024-04-04</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Linux/ itemprop=url rel=index><span itemprop=name>Linux</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>1.8k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>7 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=linux命令>Linux命令</h1><h2 id=常用命令>常用命令</h2><h3 id=cd>cd</h3><h3 id=ls>ls</h3><h3 id=awk>awk</h3><h3 id=sed>sed</h3><h3 id=ps>ps</h3><h3 id=df>df</h3><h3 id=fdisk>fdisk</h3><h3 id=wc>wc</h3><h3 id=find>find</h3><h3 id=grepegrep>grep/egrep</h3><h3 id=top>top</h3><h3 id=vivim>vi/vim</h3><h3 id=diffvimdiff>diff/vimdiff</h3><h3 id=man>man</h3><p>查看内置帮助手册，不仅可以查看命令手册，还有系统调用、库函数、异常码、宏等等信息。<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment># 学习如何RTFM</span></span><br><span class=line>$ man man</span><br><span class=line><span class=comment># 学习如何使用库函数</span></span><br><span class=line>$ man 3 getopt</span><br><span class=line><span class=comment># 检索含有关键词xxx的命令</span></span><br><span class=line>$ man -k xxx</span><br><span class=line>$ man readline</span><br><span class=line>$ man bash</span><br></pre></table></figure><h3 id=xargs>xargs</h3><h3 id=strace>strace</h3><p>system call trace, 记录程序运行过程中的系统调用信息<h3 id=netstat>netstat</h3><h3 id=ip>ip</h3><h3 id=ifconfig>ifconfig</h3><h3 id=ssh>ssh</h3><h3 id=telnet>telnet</h3><h3 id=sort>sort</h3><h3 id=history>history</h3><p><code>!n</code>再次执行编号n命令<p><code>!xxx</code>再次执行以<code>xxx</code>开头的最近一条命令<h3 id=yes>yes</h3><p>不断重复输出<code>y</code><h3 id=watch>watch</h3><p>在前台定时执行命令<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>$ watch -t -n 1 <span class=string>"echo -n '第六期一生一芯 | 周六 15:00~17:00 | '; \</span></span><br><span class=line><span class=string>  date; echo '课程主页 https://ysyx.oscc.cc/docs/'"</span></span><br><span class=line>第六期一生一芯 | 周六 15:00~17:00 | Thu Apr  4 16:58:59 CST 2024</span><br><span class=line>课程主页 https://ysyx.oscc.cc/docs/</span><br><span class=line></span><br><span class=line></span><br></pre></table></figure><h3 id=crontab>crontab</h3><p>在后台定时执行命令，需要编写对应的配置文件<h3 id=timeout>timeout</h3><p>执行特定时间，返回超时或命令自身的返回值<ul><li>0：命令成功执行并完成。<li>124：命令因超时而终止。<li>其他：命令执行失败</ul><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>$ timeout 6 mkdir -p /mnt/dev0</span><br></pre></table></figure><h1 id=脚本编写>脚本编写</h1><p>细节介绍参考<code>man bash</code><h2 id=基本语法>基本语法</h2><h3 id=简介>简介</h3><p>脚本的本质就是将众多Linux小工具按照一定的逻辑顺序依次执行处理，脚本文件内容就是这些命令的集合。<p>程序运行时都会打开3个文件<ul><li>0号文件，标准输入<li>1号文件，标准输出<li>2号文件，标准错误输出</ul><p>可以通过<code>lsof -p &lt;PID></code>查看进程打开的文件。<p><code>></code>重定向标准输出，<code>>></code>追加方式重定向标准输出，<code>2>&1</code>将标准错误重定向到标准输出。<p>内置变量有<ul><li><code>$0 $1 ... $n</code>：脚本名称（有时会包含相对或绝对路径）、第1个参数……第n个参数<li><code>$?</code>：最后一条命令或函数的返回值<li><code>$@</code>：传递<code>$0</code>之外的所有参数，可以用数组保存其值：<code>ALL_ARGS=("$@")</code><li><code>$#</code>：传递给脚本或函数的参数个数</ul><h3 id=内置命令>内置命令</h3><h4 id=shift>shift</h4><p>基本格式：<code>shift [n]</code><p>将参数左移n位，默认值为1<h3 id=交互界面>交互界面</h3><p>基本操作<ul><li><code>Tab</code>键自动补全<li>上下方向键遍历历史命令</ul><p>任务管理<ul><li><code>Ctrl+Z</code>最小化，或运行时命令末尾添加&（但用户退出后后台任务也会退出，可以使用<code>nohup</code>命令避免）<li><code>jobs</code>任务栏<li><code>bg</code>后台执行任务，将指定任务2切换到后台执行<code>bg %2</code><li><code>fg</code>前台执行任务，将指定任务2切换到前台执行<code>fg %2</code></ul><p>shell可以通过快捷键操作光标快速移动，更多快捷键可以阅读<code>man readline</code>的<code>Commands for Moving</code>部分<ul><li><code>Ctrl+B</code>光标前移一个字符<li><code>Ctrl+F</code>光标后移一个字符<li><code>Ctrl+A</code>光标移到首字符处<li><code>Ctrl+E</code>光标移到首字符处</ul><h3 id=基本单元>基本单元</h3><p>shell都是基于文本进行处理，其中只有数字字符串在特定场景可以进行数学运算。<p>通配符<ul><li><code>*</code>任意长度的字符串<li><code>?</code>任意一个字符<li><code>[xxx]</code>集合中任意一个字符</ul><p>示例<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>$ <span class=built_in>echo</span> Hello-{a,bb,ccc}-{1,2}!</span><br><span class=line>Hello-a-1! Hello-a-2! Hello-bb-1! Hello-bb-2! Hello-ccc-1! Hello-ccc-2!</span><br></pre></table></figure><p>数组<p>示例<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line># 创建一个数组</span><br><span class=line>array=()</span><br><span class=line>declare -a array</span><br><span class=line></span><br><span class=line># 添加元素</span><br><span class=line>array+=("item0")</span><br><span class=line>array+=("item1")</span><br><span class=line>array+=("item2")</span><br><span class=line></span><br><span class=line># 遍历一个数组</span><br><span class=line>for item in $array; do echo item is $item; done</span><br><span class=line>for i in {1..${#array[@]}}; do item=${array[$i]}; echo item is $item; done</span><br><span class=line>for item in ${array[@]}; do echo item is $item; done</span><br><span class=line></span><br><span class=line># 删除指定元素</span><br><span class=line>unset 'array[1]' # 删除item0，但是索引依然保留</span><br><span class=line># 重新创建一个新数组，通过过滤方式</span><br><span class=line>new_array=()</span><br><span class=line>for item in ${array[@]}; do</span><br><span class=line>	if [ $item != "item0" ]; then</span><br><span class=line>		new_array+=("$item")</span><br><span class=line>	fi</span><br><span class=line>done</span><br><span class=line></span><br><span class=line># 删除整个数组</span><br><span class=line>unset array</span><br><span class=line>array=() # 清空整个数组</span><br></pre></table></figure><h3 id=判断逻辑>判断逻辑</h3><p>if<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>$ if mkdir -p /mnt/dev0; then echo ok; else echo error; fi</span><br></pre></table></figure><p>命令执行成功则打印ok，否则打印失败<p>case<h3 id=循环逻辑>循环逻辑</h3><p>while<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>$ <span class=keyword>while</span> [[ `<span class=built_in>seq</span> 1 10 | <span class=built_in>shuf</span> | <span class=built_in>head</span> -n 1` != <span class=string>"1"</span> ]]; <span class=keyword>do</span> <span class=built_in>echo</span> <span class=string>"retry"</span>; <span class=keyword>done</span></span><br><span class=line>retry</span><br><span class=line>retry</span><br></pre></table></figure><p>for<h3 id=捕获信号>捕获信号</h3><p><code>trap</code> 命令用于捕获和处理信号或错误。当特定信号发生时，<code>trap</code> 可以执行指定的命令。<code>trap</code> 可以捕获多种信号，包括系统信号和错误。<p>一些常见的信号量包括：<ul><li><code>SIGINT</code> (2): 中断信号，通常由 Ctrl+C 触发。<li><code>SIGTERM</code> (15): 终止信号，通常由 <code>kill</code> 命令发送，用于请求进程终止。<li><code>SIGKILL</code> (9): 强制终止信号，无法被捕获或忽略，通常用于强制停止进程。<li><code>SIGQUIT</code> (3): 退出信号，通常由 Ctrl+ 触发，用于生成 core dump。<li><code>SIGSTOP</code> (19): 停止信号，无法被捕获或忽略，通常用于挂起进程。<li><code>SIGCONT</code> (18): 恢复信号，用于恢复一个被 <code>SIGSTOP</code> 停止的进程。<li><code>SIGHUP</code> (1): 挂起信号，通常是终端关闭时发送的。<li><code>SIGUSR1</code> 和 <code>SIGUSR2</code>: 用户自定义信号，可以用来传递特定信息。<li><code>SIGSEGV</code> (11): 段错误信号，通常在程序访问非法内存时触发。<li><code>SIGPIPE</code> (13): 管道破裂信号，通常当向一个没有读取者的管道写数据时触发。</ul><p>常见的错误有：<ul><li><code>EXIT</code>：捕获脚本或命令退出时的状态（返回码）。例如，你可以捕获脚本退出时的状态码，或者通过 <code>trap</code> 在脚本退出时执行清理工作。<li><code>ERR</code>：捕获任何命令的非零退出状态（发生错误时触发）。通过 <code>trap 'command' ERR</code>，你可以在发生错误时执行指定的命令。</ul><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>#!/bin/bash</span><br><span class=line></span><br><span class=line>exit_handler() {</span><br><span class=line># 具体处理逻辑</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>trap exit_handler SIGINT SIGTERM EXIT ERR</span><br><span class=line></span><br></pre></table></figure><h3 id=输入输出>输入输出</h3><h2 id=经典示例>经典示例</h2><h3 id=输入参数解析>输入参数解析</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>输入的参数可以包含以下几种情况的任意组合，&lt;xxx>表示参数后必须跟对应的值：</span><br><span class=line>-n &lt;num></span><br><span class=line>--number &lt;num> </span><br><span class=line>-v</span><br><span class=line>--version</span><br><span class=line>-h</span><br></pre></table></figure><h4 id=case手动解析>case手动解析</h4><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>#!/bin/bash</span><br><span class=line></span><br><span class=line># 手动解析参数</span><br><span class=line>while [ $# -gt 0 ]; do</span><br><span class=line>    case "$1" in</span><br><span class=line>        -n|--number)</span><br><span class=line>            # 确保后面有值</span><br><span class=line>            if [ -n "$2" ] && [[ "$2" != -* ]]; then</span><br><span class=line>                number="$2"</span><br><span class=line>                shift 2</span><br><span class=line>            else</span><br><span class=line>                echo "错误: -n 或 --number 需要一个参数"</span><br><span class=line>                exit 1</span><br><span class=line>            fi</span><br><span class=line>            ;;</span><br><span class=line>        -v|--version) show_version=true; shift; ;;</span><br><span class=line>        -h|--help) show_help=true; shift; ;;</span><br><span class=line>        *)</span><br><span class=line>            echo "忽略非选项参数: $1"</span><br><span class=line>            shift</span><br><span class=line>            ;;</span><br><span class=line>    esac</span><br><span class=line>done</span><br></pre></table></figure><h3 id=自制cpu主频监视器>自制CPU主频监视器</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>$ watch -n 1 <span class=string>"cat /proc/cpuinfo | grep MHz | awk '{print \$1 NR \$3 \$4 \$2}'"</span></span><br></pre></table></figure><h3 id=打包特定文件并上传到远端>打包特定文件并上传到远端</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>$ find . -name <span class=string>"*.pdf"</span> | xargs tar cj | ssh yzh@192.168.1.1 <span class=string>'cd ysyx; > pdf.tar.bz2'</span></span><br></pre></table></figure><h3 id=统计工具类型分布>统计工具类型分布</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>$ <span class=built_in>echo</span> <span class=variable>$PATH</span> | <span class=built_in>tr</span> -t : <span class=string>'\n'</span> | xargs -I{} find {} -maxdepth 1 -<span class=built_in>type</span> f -executable | \</span><br><span class=line>  xargs file -b -e elf | <span class=built_in>sort</span> | <span class=built_in>uniq</span> -c | <span class=built_in>sort</span> -nr</span><br><span class=line></span><br><span class=line>    835 ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV)</span><br><span class=line>    129 Perl script text executable</span><br><span class=line>    113 POSIX shell script, ASCII text executable</span><br><span class=line>     34 Python script, ASCII text executable</span><br><span class=line>     24 ELF 64-bit LSB pie executable, x86-64, version 1 (GNU/Linux)</span><br><span class=line>     20 Bourne-Again shell script, ASCII text executable</span><br><span class=line>     15 setuid ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV)</span><br><span class=line>     12 setgid ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV)</span><br><span class=line>     10 ELF 64-bit LSB executable, x86-64, version 1 (SYSV)</span><br><span class=line>      9 POSIX shell script, Unicode text, UTF-8 text executable</span><br><span class=line>      3 ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux)</span><br><span class=line>      2 Python script, Unicode text, UTF-8 text executable</span><br><span class=line>      2 PHP script, ASCII text executable</span><br><span class=line>      1 setuid, setgid ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV)</span><br><span class=line>      1 Python script, ISO-8859 text executable</span><br><span class=line>      1 POSIX shell script, ASCII text executable, with very long lines (459)</span><br><span class=line>      1 PHP phar archive with SHA1 signature</span><br><span class=line>      1 Paul Falstad<span class=string>'s zsh script, ASCII text executable</span></span><br><span class=line><span class=string>      1 JavaScript source, ASCII text</span></span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/04/04/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-C/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/04/04/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-C/ itemprop=url>编程语言-C++</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-04 15:59:30" datetime=2024-04-04T15:59:30+08:00>2024-04-04</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>505</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>2 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h2 id=告警>告警</h2><h3 id=变量初始化顺序>变量初始化顺序</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>[build] /root/project/tcl3/aadl2c/include/AADL2C/AIT/CtxUtility.h: In constructor ‘AADL2C::AIT::CtxComponent::CtxComponent(AADL2C::AIT::NodeArchitecture&, AADL2C::AIT::ASTBasePtr, AADL2C::AIT::NodeComponent&)’:</span><br><span class=line>[build] /root/project/tcl3/aadl2c/include/AADL2C/AIT/CtxUtility.h:137:33: warning: ‘AADL2C::AIT::CtxComponent::mpnewInstance’ will be initialized after [-Wreorder]</span><br><span class=line>[build]      AADL2C::AIT::NodeComponent* mpnewInstance;</span><br><span class=line>[build]                                  ^~~~~~~~~~~~~</span><br><span class=line>[build] /root/project/tcl3/aadl2c/include/AADL2C/AIT/CtxUtility.h:136:33: warning:   ‘AADL2C::AIT::NodeComponent* AADL2C::AIT::CtxComponent::mpexistingInstance’ [-Wreorder]</span><br><span class=line>[build]      AADL2C::AIT::NodeComponent* mpexistingInstance;</span><br><span class=line>[build]                                  ^~~~~~~~~~~~~~~~~~</span><br><span class=line>[build] /root/project/tcl3/aadl2c/src/AIT/CtxUtility.cpp:49:1: warning:   when initialized here [-Wreorder]</span><br><span class=line>[build]  CtxComponent::CtxComponent(AADL2C::AIT::NodeArchitecture& instanceRoot, ASTBasePtr component,</span><br><span class=line>[build]  ^~~~~~~~~~~~</span><br><span class=line>[build] In file included from /root/project/tcl3/aadl2c/src/AIT/CtxUtility.cpp:3:0:</span><br></pre></table></figure><p>这几句告警说的是变量顺序问题，英文大意为：<blockquote><p>成员变量<code>mpnewInstance</code>将会在<code>mpexistingInstance</code>之后初始化，当调用类构造函数<code>CtxComponent::CtxComponent</code>进行初始化时。</blockquote><p><strong>解决方案</strong>：调整相关变量初始化顺序<h2 id=成员变量>成员变量</h2><p>可见性：<ul><li>private<li>protect<li>public</ul><p>静态成员变量 static<p>成员常量 const<p>volitle?<p>register?<p>auto?<h2 id=成员函数>成员函数</h2><p>构造函数 析构函数 拷贝构造函数<p>移动构造函数 移动赋值运算符<p>运算符（= & + - * / ++ – += -= [] () &lt;&lt; >> …）<p>静态成员函数 static<p>只读成员函数 const<p>虚函数 纯虚函数 virtual =0<p>不可调用函数 =delete<p>默认类函数 =default<p>覆写函数 防止覆写函数 override final<p>单参数构造函数显示转换 explict<p>友元函数 friend<h2 id=枚举>枚举</h2><h3 id=字符串化>字符串化</h3><p>C语言宏定义可以有一些特殊用法：<ul><li>#: 预处理阶段，将宏参数转化为字符串<li>##: 预处理阶段，将两个标识符拼接成一个标识符</ul><p>具体步骤：<ol type=1><li>将需要的枚举名放到固定的地方统一管理，使用特别的宏函数<code>ENUM_OR_STRING</code>封装，例如枚举文件<code>signal_list.gen</code></ol><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment>// signal_list.gen</span></span><br><span class=line>ENUM_OR_STRING(LED_OPEN),                   \</span><br><span class=line>ENUM_OR_STRING(LED_CLOSE),                  \</span><br><span class=line>ENUM_OR_STRING(MSG_TEST),                   \</span><br><span class=line>ENUM_OR_STRING(MSG_BUTT)                    \</span><br></pre></table></figure><ol start=2 type=1><li>定义宏函数<code>ENUM_OR_STRING</code>，使用枚举文件声明枚举</ol><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=comment>// signal_id.h</span></span><br><span class=line><span class=comment>/* 消息ID转枚举 */</span></span><br><span class=line><span class=meta>#<span class=keyword>ifdef</span> ENUM_OR_STRING</span></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> ENUM_OR_STRING</span></span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> ENUM_OR_STRING(x) x</span></span><br><span class=line></span><br><span class=line><span class=keyword>typedef</span> <span class=class><span class=keyword>enum</span></span></span><br><span class=line><span class=class>{</span></span><br><span class=line>    <span class=meta>#<span class=keyword>include</span> <span class=string>"signal_list.gen"</span></span></span><br><span class=line>} E_MSG_ID;</span><br></pre></table></figure><ol start=3 type=1><li>定义宏函数<code>ENUM_OR_STRING</code>，实现获取枚举字符串方法</ol><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>ifdef</span> ENUM_OR_STRING</span></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> ENUM_OR_STRING</span></span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> ENUM_OR_STRING(x) #x</span></span><br><span class=line></span><br><span class=line><span class=type>const</span> <span class=type>int</span> MAX_LENGTH_MSG = <span class=number>50</span>;</span><br><span class=line><span class=type>const</span> <span class=type>char</span> msgIdString[][MAX_LENGTH_MSG] = {</span><br><span class=line>    <span class=meta>#<span class=keyword>include</span> <span class=string>"signal_list.gen"</span></span></span><br><span class=line>};</span><br><span class=line></span><br><span class=line><span class=type>const</span> <span class=type>char</span> *<span class="title function_">GetMsgName</span><span class=params>(<span class=type>int</span> msgID)</span></span><br><span class=line>{</span><br><span class=line>    <span class=keyword>return</span> msgIdString[msgID];</span><br><span class=line>}</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/04/02/Makefile%E4%BD%BF%E7%94%A8%E7%AE%80%E4%BB%8B/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/04/02/Makefile%E4%BD%BF%E7%94%A8%E7%AE%80%E4%BB%8B/ itemprop=url>Makefile使用简介</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-02 16:32:46" datetime=2024-04-02T16:32:46+08:00>2024-04-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/ itemprop=url rel=index><span itemprop=name>构建工具</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>1.9k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>7 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=基本语法>基本语法</h1><h2 id=缩进>缩进</h2><p><code>&lt;TAB></code>缩进符用于构建目标时需要执行的指令的前导符<p><code>&lt;SPACE></code>空格符可以用于函数或判断排版，但不能用于构建目标的前导符<h2 id=内置函数>内置函数</h2><h3 id=wildcard>wildcard</h3><p>遍历符合条件的文件，支持通配符。查找<code>NPC_HOME</code>目录下所有<code>cpp</code>后缀的文件，并返回其列表<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>wildcard $(NPC_HOME)/**/*.cpp</span><br></pre></table></figure><h3 id=error>error</h3><p>错误打印，并退出构建<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>$(error NPC_HOME=$(NPC_HOME) is not a NPC repo)</span><br></pre></table></figure><h3 id=patsubst>patsubst</h3><p>字符串处理函数，字符串替换。将目标字符串的替换，替换为目标格式的字符串。<p>基本格式：<code>$(patsubst &lt;模式>, &lt;替换>, &lt;文本>)</code><ul><li><code>&lt;模式></code>：指定需要匹配的字符串模式，可以包含通配符 <code>%</code>，表示零个或多个字符。<li><code>&lt;替换></code>：指定用来替换匹配到的内容的模式，通配符 <code>%</code> 在替换中保留原始匹配内容。<li><code>&lt;文本></code>：要进行匹配和替换的目标文本列表。</ul><p>将<code>riscv32</code>替换为<code>'riscv64'</code><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line># CONFIG_ISA="riscv32"</span><br><span class=line>$(patsubst "%32",'%64',$(CONFIG_ISA))</span><br></pre></table></figure><h3 id=option>option</h3><p>直接使用<code>for option</code>将会循环遍历所有参数，配合<code>case</code>完成解析。示例参考nginx项目<code>nginx-1.22.1/auto/options</code>如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line>for option; do</span><br><span class=line>    opt="$opt `echo $option | sed -e \"s/\(--[^=]*=\)\(.* .*\)/\1'\2'/\"`"</span><br><span class=line></span><br><span class=line>    case "$option" in</span><br><span class=line>        -*=*) value=`echo "$option" | sed -e 's/[-_a-zA-Z0-9]*=//'` ;;</span><br><span class=line>           *) value="" ;;</span><br><span class=line>    esac</span><br><span class=line></span><br><span class=line>    case "$option" in</span><br><span class=line>        --help)                          help=yes                   ;;</span><br><span class=line></span><br><span class=line>        --prefix=)                       NGX_PREFIX="!"             ;;</span><br><span class=line>        --prefix=*)                      NGX_PREFIX="$value"        ;;</span><br><span class=line>        --sbin-path=*)                   NGX_SBIN_PATH="$value"     ;;</span><br><span class=line># ...</span><br><span class=line>        --test-build-devpoll)            NGX_TEST_BUILD_DEVPOLL=YES ;;</span><br><span class=line>        --test-build-eventport)          NGX_TEST_BUILD_EVENTPORT=YES ;;</span><br><span class=line>        --test-build-epoll)              NGX_TEST_BUILD_EPOLL=YES   ;;</span><br><span class=line></span><br><span class=line>        *)</span><br><span class=line>            echo "$0: error: invalid option \"$option\""</span><br><span class=line>            exit 1</span><br><span class=line>        ;;</span><br><span class=line>    esac</span><br><span class=line>done</span><br></pre></table></figure><h3 id=case>case</h3><p>直接使用循环，配合<code>$1</code>和<code>shift</code>逐一进行解析。<h2 id=函数>函数</h2><p>声明自定义函数<ul><li>使用变量进行声明<li>使用<code>define</code>关键字定义</ul><p>调用自定义函数：使用 <code>$(call 函数名, 参数1, 参数2, ...)</code>。<ul><li>自定义函数的参数用 <code>$1</code>, <code>$2</code>, <code>$3</code>, … 表示。<li><code>$(call ...)</code> 是用于调用自定义函数的 Makefile 内置函数。</ul><p>示例1：使用变量将内置函数定义为自定义函数<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>CONFIG_ISA="riscv32"</span><br><span class=line># 变量自定义函数</span><br><span class=line>remove_quote = $(patsubst "%32",%64,$(1))</span><br><span class=line># 调用自定义函数</span><br><span class=line>GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))</span><br></pre></table></figure><p>示例2：使用<code>define</code>定义多参数处理<p><strong>注意</strong>：函数定义中需要使用空格符缩进<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>define add_prefix_suffix</span><br><span class=line>    $(addprefix $1, $(addsuffix $2, $3))</span><br><span class=line>endef</span><br><span class=line></span><br><span class=line>FILES = main utils lib</span><br><span class=line>RESULT = $(call add_prefix_suffix, src/, .c, $(FILES))</span><br><span class=line></span><br><span class=line>all:</span><br><span class=line>	echo $(RESULT)</span><br></pre></table></figure><h1 id=项目实例>项目实例</h1><h2 id=嵌入式处理器r5>嵌入式处理器r5</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br></pre><td class=code><pre><span class=line>ifneq ($(V),1)</span><br><span class=line>Q := @</span><br><span class=line>else</span><br><span class=line>Q :=</span><br><span class=line>endif</span><br><span class=line></span><br><span class=line>################################以下项目需用户根据需要更改##########################</span><br><span class=line>TARGET := rtos</span><br><span class=line></span><br><span class=line># 定义路径</span><br><span class=line>TOP_DIR      = .</span><br><span class=line>BUILD_DIR   := out</span><br><span class=line>OBJ_DIR 	:= $(TOP_DIR)/$(BUILD_DIR)/OBJ</span><br><span class=line>OUT_DIR 	:= $(TOP_DIR)/$(BUILD_DIR)</span><br><span class=line>BUILD     	:= ./out</span><br><span class=line></span><br><span class=line>#链接文件名称和所在路径</span><br><span class=line>LDSCRIPT := ./cortex_r5.ld</span><br><span class=line>LDSCRIPT += -Wl,-Map,$(BUILD)/$(TARGET).map</span><br><span class=line></span><br><span class=line># libraries</span><br><span class=line>LIBS +=</span><br><span class=line>LIBDIR +=  $(TOP_DIR)/lib</span><br><span class=line></span><br><span class=line>#启动文件名称和所在路径</span><br><span class=line>START_FILE_SOURCES  += $(TOP_DIR)/boot/FreeRTOS_asm.S</span><br><span class=line>START_FILE_SOURCES  += $(TOP_DIR)/boot/boot.S</span><br><span class=line>START_FILE_SOURCES  += $(TOP_DIR)/os/freertos/portable/portASM.S</span><br><span class=line></span><br><span class=line># 头文件路径</span><br><span class=line>C_INCLUDES     += -D SAFETY_GMAC</span><br><span class=line>C_INCLUDES     += -I $(TOP_DIR)/include</span><br><span class=line>C_INCLUDES     += -I $(TOP_DIR)/os/freertos/include</span><br><span class=line>C_INCLUDES     += -I $(TOP_DIR)/os/freertos/portable</span><br><span class=line></span><br><span class=line># APP源文件路径</span><br><span class=line>C_SOURCES		:= </span><br><span class=line># C_SOURCES		+= $(subst ./,,$(shell find ./ -type f -iname "*.c"))</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/entry/main.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/gic_basic_api.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Uart_PBcfg.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/isr_cfg.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Uart.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/FreeRTOS_tick_config.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Os_Cfg.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/libc_syscall.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Port_Port_Ci.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Port_Cfg.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Port.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Port_PBcfg.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/Mcu.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/utility_lite.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/app/base/BswInit.c</span><br><span class=line></span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/portable/portable_port.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/portable/MemMang/heap_4.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/queue.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/stream_buffer.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/timers.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/croutine.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/tasks.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/event_groups.c</span><br><span class=line>C_SOURCES     	+= $(TOP_DIR)/os/freertos/src/list.c</span><br><span class=line></span><br><span class=line># 定义编译标志</span><br><span class=line>GCCFLAGS += -D__SINGLE_DISPLAY_DC__=2</span><br><span class=line>GCCFLAGS += -D__DPTX_CONNECTOR__</span><br><span class=line>GCCFLAGS += -mcpu=cortex-r5 -marm -mfloat-abi=hard -mfpu=vfpv3-d16 -O1 -fmessage-length=0 -fsigned-char -ffunction-sections -fdata-sections -g3</span><br><span class=line>ASFLAGS	= $(GCCFLAGS) -x assembler-with-cpp</span><br><span class=line>CCFLAGS = $(GCCFLAGS) $(C_INCLUDES)</span><br><span class=line>LDFLAGS	= $(GCCFLAGS) -T$(LDSCRIPT) -L$(LIBDIR) $(LIBS) -nostartfiles -Xlinker --gc-sections --specs=nano.specs -u _printf_float --specs=nosys.specs</span><br><span class=line></span><br><span class=line># 支持双系统编译，故需选当前系统，0为linux，1为windows</span><br><span class=line>SYS    := 1</span><br><span class=line></span><br><span class=line># 若指定了windows系统，则需确认编译器的路径，若安装时以默认路径安装，则正确</span><br><span class=line>ifeq ($(SYS), 1)</span><br><span class=line>GCC_PATH = "C:/eclipse/Arm_Embedded_Toolchain/arm-none-eabi/bin"</span><br><span class=line>JLINK_PATH = "C:/Program Files (x86)/SEGGER/JLink"</span><br><span class=line>endif</span><br><span class=line></span><br><span class=line>###################################用户修改结束###################################</span><br><span class=line># 编译器定义</span><br><span class=line>PREFIX = arm-none-eabi-</span><br><span class=line>ifdef GCC_PATH</span><br><span class=line>SUFFIX = .exe</span><br><span class=line>GDB			:= arm-none-eabi-gdb</span><br><span class=line>SZ			:= arm-none-eabi-size</span><br><span class=line>CC          := arm-none-eabi-gcc</span><br><span class=line>AS          := arm-none-eabi-as</span><br><span class=line>LD          := arm-none-eabi-ld</span><br><span class=line>AR          := arm-none-eabi-ar</span><br><span class=line>OBJCOPY     := arm-none-eabi-objcopy</span><br><span class=line>else</span><br><span class=line>CC      := $(PREFIX)gcc</span><br><span class=line>SZ      := $(PREFIX)size</span><br><span class=line>OBJCOPY := $(PREFIX)objcopy</span><br><span class=line>GDB     := $(PREFIX)gdb</span><br><span class=line>endif</span><br><span class=line>BIN     := $(OBJCOPY) -O binary -S</span><br><span class=line>HEX     := $(OBJCOPY) -O ihex</span><br><span class=line></span><br><span class=line># Jlink定义，用于支持一键下载和gdb仿真</span><br><span class=line>ifdef JLINK_PATH</span><br><span class=line>SUFFIX = .exe</span><br><span class=line>JLINKEXE       := $(JLINK_PATH)/JLink$(SUFFIX)</span><br><span class=line>JLINKGDBSERVER := $(JLINK_PATH)/JLinkGDBServer$(SUFFIX)</span><br><span class=line>else</span><br><span class=line>JLINKEXE       := JLinkExe</span><br><span class=line>JLINKGDBSERVER := JLinkGDBServer</span><br><span class=line>endif</span><br><span class=line></span><br><span class=line>#################### CFLAGS config Start ##########################</span><br><span class=line>#搜索所有的h文件,并输出携带-I的.h文件路径</span><br><span class=line>#C_INCLUDES := $(addprefix -I,$(subst ./,,$(sort $(dir $(shell find ./ -type f -iname "*.h")))))</span><br><span class=line></span><br><span class=line>#################### CFLAGS config End ##########################</span><br><span class=line>#链接指令集-specs=nosys.specs</span><br><span class=line>#是否开启优化掉未使用的函数和符号</span><br><span class=line></span><br><span class=line>#制作启动文件依赖Obj,输出去掉路径的.o文件,可兼容.s和.S</span><br><span class=line>START_FILE_OBJ     = $(addsuffix .o, $(basename $(notdir $(START_FILE_SOURCES))))</span><br><span class=line>OBJECTS            = $(addprefix $(BUILD)/obj/, $(START_FILE_OBJ))</span><br><span class=line>#搜索所有的c文件，制作所有的.c文件依赖Obj</span><br><span class=line>#C_SOURCES          = $(subst ./,,$(shell find ./ -type f -iname "*.c"))</span><br><span class=line></span><br><span class=line>OBJECTS	+= $(addprefix $(BUILD)/obj/, $(notdir $(C_SOURCES:%.c=%.o)))</span><br><span class=line>#PS:去掉终极目标的原始路径前缀并添加输出文件夹路径前缀(改变了依赖文件的路径前缀，需要重新指定搜索路径)</span><br><span class=line>#指定makefile搜索文件的路径(假如终极目标的依赖文件不携带.c文件所在的路径，</span><br><span class=line>#且不指定搜索路径，makefile会报错没有规则制定目标)</span><br><span class=line>vpath %.c $(sort $(dir $(C_SOURCES)))  #取出路径并去重和排序(以首字母为单位)</span><br><span class=line>vpath %.s $(dir $(START_FILE_SOURCES))</span><br><span class=line>vpath %.S $(dir $(START_FILE_SOURCES))</span><br><span class=line></span><br><span class=line>#指定为伪目标跳过隐含规则搜索，提升makefile的性能，并防止make时携带的参数与实际文件重名的问题</span><br><span class=line>.PHONY:all clean printf JLinkGDBServer debug download reset commit</span><br><span class=line>all : $(BUILD)/$(TARGET).elf $(BUILD)/$(TARGET).bin $(BUILD)/$(TARGET).hex</span><br><span class=line></span><br><span class=line>#编译启动文件  备用参数：#-x assembler-with-cpp</span><br><span class=line>$(BUILD)/obj/%.o : %.S Makefile | $(BUILD)/obj</span><br><span class=line>	$(Q)echo "$(CC) $(ASFLAGS) -c $&lt; -o $@"</span><br><span class=line>	$(Q)$(CC) $(ASFLAGS) -c $&lt; -o $@</span><br><span class=line></span><br><span class=line>#编译工程</span><br><span class=line>$(BUILD)/obj/%.o : %.c Makefile | $(BUILD)/obj</span><br><span class=line>	$(Q)echo "$(CC) -c $(CCFLAGS) $(BUILD)/obj/$(notdir $(&lt;:.c=.lst)) -c $&lt; -o $@"</span><br><span class=line>	$(Q)$(CC) -c $(CCFLAGS) -Wa,-a,-ad,-alms=$(BUILD)/obj/$(notdir $(&lt;:.c=.lst)) -c $&lt; -o $@</span><br><span class=line></span><br><span class=line>#链接所有的.o生成.elf文件</span><br><span class=line>$(BUILD)/$(TARGET).elf : $(OBJECTS) Makefile | $(BUILD)</span><br><span class=line>	$(Q)echo "$(CC) $(OBJECTS) $(LDFLAGS)  -o $@"</span><br><span class=line>	$(Q)$(CC) $(OBJECTS) $(LDFLAGS) -o $@</span><br><span class=line>	$(Q)echo "make $@: "</span><br><span class=line>	$(Q)$(SZ) $@</span><br><span class=line></span><br><span class=line>$(BUILD)/%.hex: $(BUILD)/%.elf | $(BUILD)</span><br><span class=line>	$(HEX) $&lt; $@</span><br><span class=line></span><br><span class=line>$(BUILD)/%.bin: $(BUILD)/%.elf | $(BUILD)</span><br><span class=line>	$(BIN) $&lt; $@</span><br><span class=line>	# arm-none-eabi-objdump -D -S $(BUILD)/${TARGET}.elf > $(BUILD)/${TARGET}.dump</span><br><span class=line></span><br><span class=line>$(BUILD)/obj:</span><br><span class=line>	$(Q)mkdir -p $@</span><br><span class=line>	$(Q)echo "mkdir $@"</span><br><span class=line></span><br><span class=line>#用于检查链接脚本和启动文件是否存在，不存在则报错误</span><br><span class=line>$(START_FILE_SOURCES):</span><br><span class=line>	$(Q)echo ERROR: The startup file does not exist or has the wrong path !;\</span><br><span class=line>	exit 1</span><br><span class=line>$(LDSCRIPT):</span><br><span class=line>	$(Q)echo ERROR: The link file does not exist or has the wrong path !;\</span><br><span class=line>	exit 2</span><br><span class=line></span><br><span class=line>clean:</span><br><span class=line>	$(RM) -rf $(BUILD)</span><br><span class=line></span><br><span class=line>-include $(wildcard $(BUILD)/obj/*.d)</span><br><span class=line></span><br></pre></table></figure><h2 id=支持nfs启动的qemu>支持NFS启动的qemu</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br></pre><td class=code><pre><span class=line># QEMU		:= qemu-system-aarch64</span><br><span class=line>QEMU		:= QEMU_AUDIO_DRV=none qemu-system-arm</span><br><span class=line>Machine		:= -M vexpress-a9</span><br><span class=line># CPU			:= -cpu cortex-a9</span><br><span class=line>CPU			:= -smp 1</span><br><span class=line>Memory		:= -m 512M</span><br><span class=line>Kernel		:= -kernel linux-6.1.73/arch/arm/boot/zImage</span><br><span class=line>Dtb			:= -dtb linux-6.1.73/arch/arm/boot/dts/vexpress-v2p-ca9.dtb</span><br><span class=line>SDCard		:= -sd images/sd_rootfs.ext4</span><br><span class=line># Network		:= -net nic -net user</span><br><span class=line>Network		:= -nic user</span><br><span class=line></span><br><span class=line># try to generate a unique GDB port</span><br><span class=line>GDBPORT = $(shell expr `id -u` % 5000 + 25000)</span><br><span class=line># QEMU's gdb stub command line changed in 0.11</span><br><span class=line>QEMUGDB = $(shell if $(QEMU) -help | grep -q '^-gdb'; \</span><br><span class=line>	then echo "-gdb tcp::$(GDBPORT)"; \</span><br><span class=line>	else echo "-s -p $(GDBPORT)"; fi)</span><br><span class=line></span><br><span class=line>all:</span><br><span class=line>	@echo "all done"</span><br><span class=line></span><br><span class=line>qemu-gdb:</span><br><span class=line>	@echo "*** Now run 'gdb' in another window." 1>&2</span><br><span class=line>	${QEMU} \</span><br><span class=line>		${Machine} \</span><br><span class=line>		${CPU} \</span><br><span class=line>        ${Memory} \</span><br><span class=line>        ${Kernel} \</span><br><span class=line>        ${Dtb} \</span><br><span class=line>	    ${SDCard} \</span><br><span class=line>		${Network} \</span><br><span class=line>		-nographic \</span><br><span class=line>		-append "root=/dev/mmcblk0 rw console=ttyAMA0" -S -s</span><br><span class=line></span><br><span class=line>run:</span><br><span class=line>	@echo "host 10.0.2.2"</span><br><span class=line>	@echo "guest 10.0.2.15"</span><br><span class=line>	${QEMU} \</span><br><span class=line>		${Machine} \</span><br><span class=line>		${CPU} \</span><br><span class=line>        ${Memory} \</span><br><span class=line>        ${Kernel} \</span><br><span class=line>        ${Dtb} \</span><br><span class=line>	    ${SDCard} \</span><br><span class=line>		${Network} \</span><br><span class=line>		-nographic \</span><br><span class=line>		-append "root=/dev/mmcblk0 rw console=ttyAMA0"</span><br><span class=line></span><br><span class=line>run-nfs:</span><br><span class=line>	@echo "host 10.0.2.2"</span><br><span class=line>	@echo "guest 10.0.2.15"</span><br><span class=line>	${QEMU} \</span><br><span class=line>		${Machine} \</span><br><span class=line>		${CPU} \</span><br><span class=line>        ${Memory} \</span><br><span class=line>        ${Kernel} \</span><br><span class=line>        ${Dtb} \</span><br><span class=line>		${Network} \</span><br><span class=line>		-nographic \</span><br><span class=line>		-append "console=ttyAMA0,115200 noinitrd init=/linuxrc loglevel=8 nfsroot=10.0.2.2:/home/johnny/big-proj/os-dev/arm_rootfs/rootfs_v6.x,v3,nolock rw ip=10.0.2.15:10.0.2.2:10.0.2.1:255.255.255.0::eth0:off rootwait"</span><br><span class=line></span><br><span class=line>gui:</span><br><span class=line>	@echo "host 10.0.2.2"</span><br><span class=line>	@echo "guest 10.0.2.15"</span><br><span class=line>	${QEMU} \</span><br><span class=line>		${Machine} \</span><br><span class=line>		${CPU} \</span><br><span class=line>        ${Memory} \</span><br><span class=line>        ${Kernel} \</span><br><span class=line>        ${Dtb} \</span><br><span class=line>	    ${SDCard} \</span><br><span class=line>		${Network} \</span><br><span class=line>		-display sdl -serial mon:stdio -append "root=/dev/mmcblk0 rw console=tty0"</span><br><span class=line></span><br><span class=line># -net nic -net user </span><br><span class=line># -netdev user,id=network0 -device e1000,netdev=network0,mac=52:54:00:12:34:56</span><br><span class=line># qemu-system-arm -M vexpress-a9 \</span><br><span class=line>	-cpu cortex-a9 -m 256 -kernel ~/share/linux-4.4.157/object/arch/arm/boot/zImage -dtb ~/share/linux-4.4.157/object/arch/arm/boot/dts/vexpress-v2p-ca9.dtb -append "root=/dev/mmcblk0 rw console=tty0" -sd rootfs.ext3</span><br><span class=line></span><br></pre></table></figure><h1 id=附录>附录</h1><h2 id=参考文章>参考文章</h2><p><a href=https://seisman.github.io/how-to-write-makefile/overview.html rel=noopener target=_blank>跟我一起写Makefile</a></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/04/01/CMakeLists%E4%BD%BF%E7%94%A8%E7%AE%80%E4%BB%8B/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/04/01/CMakeLists%E4%BD%BF%E7%94%A8%E7%AE%80%E4%BB%8B/ itemprop=url>CMakeLists使用简介</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-04-01 14:11:27" datetime=2024-04-01T14:11:27+08:00>2024-04-01</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/ itemprop=url rel=index><span itemprop=name>构建工具</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>2.5k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>9 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=常用技巧>常用技巧</h1><h2 id=常用关键词>常用关键词</h2><h3 id=cmake_minimum_required>cmake_minimum_required</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cmake_minimum_required(VERSION 3.15)</span><br></pre></table></figure><p>指定最小CMake版本不能低于3.15<h3 id=project>project</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>project(emodem C ASM)</span><br></pre></table></figure><p>指定工程名称，并指定所有源文件可能使用的语言为C或ASM（汇编）。<h3 id=message>message</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>message(STATUS "cross compile cortex-r5")</span><br></pre></table></figure><p>输出消息。<ul><li><code>STATUS</code>为普通状态消息<li><code>FATAL_ERROR</code>为致命异常消息，输出消息后配置会立即终止</ul><h3 id=if>if</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>if(NOT FREERTOS_CONFIG_FILE_DIRECTORY)</span><br><span class=line>    message(FATAL_ERROR "xxx")</span><br><span class=line>elseif(NOT EXISTS xxx.h)</span><br><span class=line>    message(FATAL_ERROR "xxx.h")</span><br><span class=line>else</span><br><span class=line>	message(status "x")</span><br><span class=line>endif()</span><br></pre></table></figure><p>判断条件是否满足，并进行相关逻辑处理。<h3 id=set>set</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>set(CMAKE_ASM_FLAGS "${COMMON_FLAGS} -x assembler-with-cpp")</span><br></pre></table></figure><p>指定CMake宏对应的值，子工程会继承父工程的CMake宏。<h3 id=add_subdirectory>add_subdirectory</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>add_subdirectory(FreeRTOS/FreeRTOS-Kernel)</span><br></pre></table></figure><p>增加子工程。<h3 id=file>file</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>file(GLOB_RECURSE APP_SRC   "app/**/*.c")</span><br></pre></table></figure><p>文件处理，<code>GLOB_RECURSE</code>用于递归查找文件，并将结果保存到CMake宏<code>APP_SRC</code>中。<h3 id=add_executable>add_executable</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>add_executable(${MAIN_TARGET}</span><br><span class=line>    ${APP_SRC}</span><br><span class=line>)</span><br></pre></table></figure><p>指定可执行文件目标，并指定编译源码<code>${APP_SRC}</code>。<h3 id=add_library>add_library</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>add_library(freertos_kernel STATIC</span><br><span class=line>    croutine.c</span><br><span class=line>    $&lt;IF:$&lt;BOOL:$&lt;FILTER:${FREERTOS_HEAP},EXCLUDE,^[1-5]$>>,${FREERTOS_HEAP},portable/MemMang/heap_${FREERTOS_HEAP}.c></span><br><span class=line>)</span><br></pre></table></figure><p>指定静态库目标，并指定编译源码<code>croutine.c</code> <code>portable/MemMang/heap_xxx.c</code><h3 id=include>include</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>include(${CMAKE_TOOLCHAIN_FILE})</span><br></pre></table></figure><p>包含头文件<code>${CMAKE_TOOLCHAIN_FILE}</code><h3 id=include_directories>include_directories</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>include_directories(${MAIN_TARGET}</span><br><span class=line>    include</span><br><span class=line>    FreeRTOS/FreeRTOS-Kernel/include</span><br><span class=line>    FreeRTOS/FreeRTOS-Kernel/portable/GCC/ARM_COTEXT_R5</span><br><span class=line>)</span><br></pre></table></figure><p>目标增加include文件搜索路径<code>include</code> <code>FreeRTOS/FreeRTOS-Kernel/include</code> <code>FreeRTOS/FreeRTOS-Kernel/portable/GCC/ARM_COTEXT_R5</code><h3 id=target_include_directories>target_include_directories</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>target_include_directories(freertos_kernel</span><br><span class=line>    PUBLIC</span><br><span class=line>        include</span><br><span class=line>        portable/GCC/ARM_COTEXT_R5</span><br><span class=line>        ${FREERTOS_CONFIG_FILE_DIRECTORY}</span><br><span class=line>)</span><br></pre></table></figure><p>目标增加include文件搜索路径<code>include</code> <code>FreeRTOS/FreeRTOS-Kernel/portable/GCC/ARM_COTEXT_R5</code> <code>${FREERTOS_CONFIG_FILE_DIRECTORY}</code><h3 id=add_definitions>add_definitions</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>add_definitions(-DDEBUG -DUSE_LOG)</span><br></pre></table></figure><p>增加编译宏<code>DEBUG</code>和<code>USE_LOG</code><h3 id=target_link_directories>target_link_directories</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>target_link_directories(${MAIN_TARGET} PRIVATE</span><br><span class=line>    ${PROJECT_BINARY_DIR}/lib</span><br><span class=line>)</span><br></pre></table></figure><p>目标增加链接库搜索路径<code>${PROJECT_BINARY_DIR}/lib</code><h3 id=target_link_libraries>target_link_libraries</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>target_link_libraries(${MAIN_TARGET} PRIVATE</span><br><span class=line>    freertos_kernel_port</span><br><span class=line>    freertos_kernel</span><br><span class=line>)</span><br></pre></table></figure><p>目标增加链接库<code>freertos_kernel_port</code> <code>freertos_kernel</code><h2 id=常用cmake宏>常用CMake宏</h2><p>指定CMake宏使用set关键词进行设置。<table><colgroup><col style="width: 31%"><col style="width: 68%"></colgroup><thead><tr class=header><th>名称<th>说明<tbody><tr class=odd><td>PROJECT_NAME<td>工程名称<tr class=even><td>PROJECT_BINARY_DIR<td>工程二进制主路径，即build构建主路径<tr class=odd><td>PROJECT_SOURCE_DIR<td>工程源文件主路径，即主CMakeList.txt文件所在路径<tr class=even><td>CMAKE_C_COMPILER<td>C语言编译器路径<tr class=odd><td>CMAKE_CXX_COMPILER<td>C++编译器路径<tr class=even><td>CMAKE_ASM_COMPILER<td>汇编编译器路径<tr class=odd><td>CMAKE_C_FLAGS<td>C语言编译参数<tr class=even><td>CMAKE_ASM_FLAGS<td>汇编编译参数<tr class=odd><td>CMAKE_EXE_LINKER_FLAGS<td>可执行文件链接参数<tr class=even><td>LIBRARY_OUTPUT_PATH<td>库输出路径<tr class=odd><td>EXECUTABLE_OUTPUT_PATH<td>可执行文件输出路径</table><h1 id=项目实例>项目实例</h1><h2 id=嵌入式处理器r5>嵌入式处理器r5</h2><p>工程中有三个文件构成，主CMakeLists负责产生elf文件和生成bin文件。FreeRTOS代码在<code>os/freertos</code>中，CMakeLists用于生成内核静态库<code>libfreertos_kernel.a</code>。<code>os/freertos/portable</code>下，CMakeLists用于生成处理器相关静态库<code>libfreertos_kernel_port.a</code>。<p>原版CMakeLists内容比较多，这里固定选择<code>GCC_ARM_COTEXT_R5</code>，已将冗余项裁剪，具体可以参考<code>FreeRTOSv202210.01-LTS</code>对应文件。<h3 id=主cmakelists>主CMakeLists</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br></pre><td class=code><pre><span class=line>cmake_minimum_required(VERSION 3.15)</span><br><span class=line></span><br><span class=line>project(emodem C ASM)</span><br><span class=line></span><br><span class=line>message(STATUS "cross compile cortex-r5")</span><br><span class=line></span><br><span class=line>set(TOOLCHAIN_PATH /usr/local/gcc-arm-none-eabi-8-2018-q4-major)</span><br><span class=line>set(CMAKE_C_COMPILER ${TOOLCHAIN_PATH}/bin/arm-none-eabi-gcc)</span><br><span class=line>set(CMAKE_CXX_COMPILER ${TOOLCHAIN_PATH}/bin/arm-none-eabi-gcc)</span><br><span class=line>set(CMAKE_ASM_COMPILER ${TOOLCHAIN_PATH}/bin/arm-none-eabi-gcc)</span><br><span class=line>set(COMMON_FLAGS "-mcpu=cortex-r5 -marm -mfloat-abi=hard -mfpu=vfpv3-d16 -O1 -fmessage-length=0 -fsigned-char -ffunction-sections -fdata-sections -g3")</span><br><span class=line>set(CMAKE_C_FLAGS "-D__SINGLE_DISPLAY_DC__=2  -D__DPTX_CONNECTOR__ ${COMMON_FLAGS} -D SAFETY_GMAC")</span><br><span class=line>set(CMAKE_ASM_FLAGS "-D__SINGLE_DISPLAY_DC__=2  -D__DPTX_CONNECTOR__ ${COMMON_FLAGS} -x assembler-with-cpp")</span><br><span class=line>set(CMAKE_EXE_LINKER_FLAGS "-T ${PROJECT_SOURCE_DIR}/cortex_r5.ld -Wl,-Map,${PROJECT_NAME}.map -nostartfiles -Xlinker --gc-sections --specs=nano.specs -u _printf_float --specs=nosys.specs")</span><br><span class=line></span><br><span class=line>set(LIBRARY_OUTPUT_PATH ${PROJECT_BINARY_DIR}/lib)</span><br><span class=line>set(EXECUTABLE_OUTPUT_PATH ${PROJECT_BINARY_DIR}/bin)</span><br><span class=line># option(MYDEBUG "enable debug compilation" OFF)</span><br><span class=line># if (MYDEBUG)</span><br><span class=line>#     add_definitions(-DMYDEBUG)</span><br><span class=line>#     message(STATUS "Currently is in debug mode")</span><br><span class=line># else()</span><br><span class=line>#     message(STATUS "Currently is not in debug mode")</span><br><span class=line># endif()</span><br><span class=line></span><br><span class=line>set(FREERTOS_CONFIG_FILE_DIRECTORY ${PROJECT_SOURCE_DIR}/include CACHE STRING "Absolute path to the directory with FreeRTOSConfig.h")</span><br><span class=line>add_subdirectory(os/freertos)</span><br><span class=line></span><br><span class=line>file(GLOB_RECURSE APP_SRC   "app/**/*.c")</span><br><span class=line>file(GLOB_RECURSE BOOT_SRC  "boot/*.S")</span><br><span class=line></span><br><span class=line># find_library(FREERTOS_LIB testFunc HINTS ${PROJECT_SOURCE_DIR}/testFunc/lib)</span><br><span class=line></span><br><span class=line>set(MAIN_TARGET ${PROJECT_NAME}_freertos.elf)</span><br><span class=line>add_executable(${MAIN_TARGET}</span><br><span class=line>    ${BOOT_SRC}</span><br><span class=line>    ${APP_SRC}</span><br><span class=line>)</span><br><span class=line>include_directories(${MAIN_TARGET}</span><br><span class=line>    include</span><br><span class=line>    os/freertos/include</span><br><span class=line>    os/freertos/portable</span><br><span class=line>)</span><br><span class=line>target_link_directories(${MAIN_TARGET} PRIVATE</span><br><span class=line>    ${PROJECT_BINARY_DIR}/lib</span><br><span class=line>    ${PROJECT_SOURCE_DIR}/lib</span><br><span class=line>)</span><br><span class=line>target_link_libraries(${MAIN_TARGET} PRIVATE</span><br><span class=line>    freertos_kernel_port</span><br><span class=line>    freertos_kernel</span><br><span class=line>    # mcal</span><br><span class=line>)</span><br><span class=line>set(MAIN_BIN_TARGET ${PROJECT_NAME}_freertos.bin)</span><br><span class=line>add_custom_command(TARGET ${MAIN_TARGET} POST_BUILD</span><br><span class=line>    COMMAND ${TOOLCHAIN_PATH}/bin/arm-none-eabi-objcopy -O binary -S ${EXECUTABLE_OUTPUT_PATH}/${MAIN_TARGET} ${EXECUTABLE_OUTPUT_PATH}/${MAIN_BIN_TARGET}</span><br><span class=line>    COMMENT "Generate ${EXECUTABLE_OUTPUT_PATH}/${MAIN_BIN_TARGET}"</span><br><span class=line>)</span><br><span class=line></span><br><span class=line></span><br><span class=line># target_link_options(${MAIN_TARGET} PRIVATE</span><br><span class=line>#     -T${PROJECT_SOURCE_DIR}/cortex_r5.ld</span><br><span class=line># )</span><br><span class=line></span><br><span class=line># # indicate lib path </span><br><span class=line># target_link_directories(${MAIN_TARGET}</span><br><span class=line># PRIVATE</span><br><span class=line># ${OUT_PATH}/lib</span><br><span class=line># )</span><br><span class=line></span><br><span class=line></span><br><span class=line></span><br><span class=line># # on the basic of  debug  to set  CFLAGS</span><br><span class=line># if (debug STREQUAL "yes")</span><br><span class=line>#     set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -O0 -ggdb3")</span><br><span class=line># else()</span><br><span class=line>#     set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -O2")</span><br><span class=line># endif()</span><br><span class=line></span><br><span class=line># # on the basic of  r5_LITTLE_FLASH to set  CFLAGS</span><br><span class=line># if (r5_LITTLE_FLASH STREQUAL "TRUE")</span><br><span class=line>#     # set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -DSAMPLE_620U_NAND")</span><br><span class=line># endif()</span><br><span class=line></span><br></pre></table></figure><h3 id=osfreertos的makelists>os/freertos的MakeLists</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br></pre><td class=code><pre><span class=line>cmake_minimum_required(VERSION 3.15)</span><br><span class=line></span><br><span class=line># User is responsible to set two mandatory options:</span><br><span class=line># FREERTOS_CONFIG_FILE_DIRECTORY</span><br><span class=line># FREERTOS_PORT</span><br><span class=line>#</span><br><span class=line># User can choose which heap implementation to use (either the implementations</span><br><span class=line># included with FreeRTOS [1..5] or a custom implementation ) by providing the</span><br><span class=line># option FREERTOS_HEAP. If the option is not set, the cmake will default to</span><br><span class=line># using heap_4.c.</span><br><span class=line></span><br><span class=line># Absolute path to FreeRTOS config file directory</span><br><span class=line># set(FREERTOS_CONFIG_FILE_DIRECTORY ${FREERTOS_CONFIG_FILE_PATH} CACHE STRING "Absolute path to the directory with FreeRTOSConfig.h")</span><br><span class=line></span><br><span class=line>if(NOT FREERTOS_CONFIG_FILE_DIRECTORY)</span><br><span class=line>    message(FATAL_ERROR " FreeRTOSConfig.h file directory not specified. Please specify absolute path to it from top-level CMake file:\n"</span><br><span class=line>        "  set(FREERTOS_CONFIG_FILE_DIRECTORY &lt;absolute path to FreeRTOSConfig.h directory> CACHE STRING \"\")\n"</span><br><span class=line>        " or from CMake command line option:\n"</span><br><span class=line>        "  -DFREERTOS_CONFIG_FILE_DIRECTORY='/absolute_path/to/FreeRTOSConfig.h/directory'")</span><br><span class=line>elseif(NOT EXISTS ${FREERTOS_CONFIG_FILE_DIRECTORY}/FreeRTOSConfig.h)</span><br><span class=line>    message(FATAL_ERROR " FreeRTOSConfig.h file not found in the directory specified (${FREERTOS_CONFIG_FILE_DIRECTORY})\n"</span><br><span class=line>        " Please specify absolute path to it from top-level CMake file:\n"</span><br><span class=line>        "  set(FREERTOS_CONFIG_FILE_DIRECTORY &lt;absolute path to FreeRTOSConfig.h directory> CACHE STRING \"\")\n"</span><br><span class=line>        " or from CMake command line option:\n"</span><br><span class=line>        "  -DFREERTOS_CONFIG_FILE_DIRECTORY='/absolute_path/to/FreeRTOSConfig.h/directory'")</span><br><span class=line>endif()</span><br><span class=line></span><br><span class=line># Heap number or absolute path to custom heap implementation provided by user</span><br><span class=line>set(FREERTOS_HEAP "4" CACHE STRING "FreeRTOS heap model number. 1 .. 5. Or absolute path to custom heap source file")</span><br><span class=line></span><br><span class=line># FreeRTOS port option</span><br><span class=line>set(FREERTOS_PORT "GCC_ARM_COTEXT_R5" CACHE STRING "FreeRTOS port name")</span><br><span class=line></span><br><span class=line>if(NOT FREERTOS_PORT)</span><br><span class=line>    message(FATAL_ERROR " FREERTOS_PORT is not set. Please specify it from top-level CMake file (example):\n"</span><br><span class=line>        "  set(FREERTOS_PORT GCC_ARM_CM4F CACHE STRING \"\")\n"</span><br><span class=line>        " or from CMake command line option:\n"</span><br><span class=line>        "  -DFREERTOS_PORT=GCC_ARM_CM4F\n"</span><br><span class=line>        " \n"</span><br><span class=line>        " Available port options:\n"</span><br><span class=line>        " GCC_ARM_COTEXT_R5                - Compiller: GCC           Target: ARM Cortex-R5")</span><br><span class=line>endif()</span><br><span class=line></span><br><span class=line>add_subdirectory(portable)</span><br><span class=line></span><br><span class=line>add_library(freertos_kernel STATIC</span><br><span class=line>    src/croutine.c</span><br><span class=line>    src/event_groups.c</span><br><span class=line>    src/list.c</span><br><span class=line>    src/queue.c</span><br><span class=line>    src/stream_buffer.c</span><br><span class=line>    src/tasks.c</span><br><span class=line>    src/timers.c</span><br><span class=line></span><br><span class=line>    # If FREERTOS_HEAP is digit between 1 .. 5 - it is heap number, otherwise - it is path to custom heap source file</span><br><span class=line>    $&lt;IF:$&lt;BOOL:$&lt;FILTER:${FREERTOS_HEAP},EXCLUDE,^[1-5]$>>,${FREERTOS_HEAP},portable/MemMang/heap_${FREERTOS_HEAP}.c></span><br><span class=line>)</span><br><span class=line></span><br><span class=line>target_include_directories(freertos_kernel</span><br><span class=line>    PUBLIC</span><br><span class=line>        include</span><br><span class=line>        portable/GCC/ARM_COTEXT_R5</span><br><span class=line>        ${FREERTOS_CONFIG_FILE_DIRECTORY}</span><br><span class=line>)</span><br><span class=line></span><br><span class=line>target_link_libraries(freertos_kernel freertos_kernel_port)</span><br><span class=line></span><br></pre></table></figure><h3 id=osfreertosportable的cmakelists>os/freertos/portable的CMakeLists</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br></pre><td class=code><pre><span class=line># FreeRTOS internal cmake file. Do not use it in user top-level project</span><br><span class=line></span><br><span class=line>add_library(freertos_kernel_port STATIC</span><br><span class=line>    # ARM-Cortext-R5 port for GCC</span><br><span class=line>    $&lt;$&lt;STREQUAL:${FREERTOS_PORT},GCC_ARM_COTEXT_R5>:</span><br><span class=line>        portable_port.c</span><br><span class=line>        portASM.S></span><br><span class=line></span><br><span class=line>    # 16-Bit DOS ports for BCC</span><br><span class=line>    $&lt;$&lt;STREQUAL:${FREERTOS_PORT},BCC_16BIT_DOS_FLSH186>:</span><br><span class=line>        BCC/16BitDOS/common/portcomn.c</span><br><span class=line>        BCC/16BitDOS/Flsh186/port.c></span><br><span class=line>)</span><br><span class=line></span><br><span class=line>if( FREERTOS_PORT MATCHES "GCC_ARM_CM(3|4)_MPU" OR</span><br><span class=line>    FREERTOS_PORT STREQUAL "IAR_ARM_CM4F_MPU" OR</span><br><span class=line>    FREERTOS_PORT STREQUAL "RVDS_ARM_CM4_MPU" OR</span><br><span class=line>    FREERTOS_PORT MATCHES "GCC_ARM_CM(23|33|55|85)_NTZ_NONSECURE" OR</span><br><span class=line>    FREERTOS_PORT MATCHES "GCC_ARM_CM(23|33|55|85)_NONSECURE" OR</span><br><span class=line>    FREERTOS_PORT MATCHES "GCC_ARM_CM(33|55|85)_TFM" OR</span><br><span class=line>    FREERTOS_PORT MATCHES "IAR_ARM_CM(23|33|55|85)_NTZ_NONSECURE" OR</span><br><span class=line>    FREERTOS_PORT MATCHES "IAR_ARM_CM(23|33|55|85)_NONSECURE"</span><br><span class=line>)</span><br><span class=line>    target_sources(freertos_kernel_port PRIVATE Common/mpu_wrappers.c)</span><br><span class=line>endif()</span><br><span class=line></span><br><span class=line>target_include_directories(freertos_kernel_port PUBLIC</span><br><span class=line>    # ARM-Cortext-R5 port for GCC</span><br><span class=line>    $&lt;$&lt;STREQUAL:${FREERTOS_PORT},GCC_ARM_COTEXT_R5>:${CMAKE_CURRENT_LIST_DIR}></span><br><span class=line></span><br><span class=line>    # 16-Bit DOS ports for BCC</span><br><span class=line>    $&lt;$&lt;STREQUAL:${FREERTOS_PORT},BCC_16BIT_DOS_FLSH186>:</span><br><span class=line>        ${CMAKE_CURRENT_LIST_DIR}/BCC/16BitDOS/common</span><br><span class=line>        ${CMAKE_CURRENT_LIST_DIR}/BCC/16BitDOS/Flsh186></span><br><span class=line></span><br><span class=line>    $&lt;$&lt;STREQUAL:${FREERTOS_PORT},BCC_16BIT_DOS_PC>:</span><br><span class=line>        ${CMAKE_CURRENT_LIST_DIR}/BCC/16BitDOS/common</span><br><span class=line>        ${CMAKE_CURRENT_LIST_DIR}/BCC/16BitDOS/PC></span><br><span class=line>)</span><br><span class=line></span><br><span class=line>target_link_libraries(freertos_kernel_port</span><br><span class=line>    PUBLIC</span><br><span class=line>        $&lt;$&lt;STREQUAL:${FREERTOS_PORT},GCC_RP2040>:pico_base_headers></span><br><span class=line>        $&lt;$&lt;STREQUAL:${FREERTOS_PORT},GCC_XTENSA_ESP32>:idf::esp32></span><br><span class=line>    PRIVATE</span><br><span class=line>        freertos_kernel</span><br><span class=line>        "$&lt;$&lt;STREQUAL:${FREERTOS_PORT},GCC_RP2040>:hardware_clocks;hardware_exception>"</span><br><span class=line>        $&lt;$&lt;STREQUAL:${FREERTOS_PORT},MSVC_MINGW>:winmm> # Windows library which implements timers</span><br><span class=line>)</span><br><span class=line></span><br></pre></table></figure><h1 id=其他说明>其他说明</h1><h2 id=基本结构>基本结构</h2><p>工程文件<code>CMakeLists.txt</code><figure class="highlight cmake"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br></pre><td class=code><pre><span class=line><span class=comment># 指定CMake工具的最小版本号</span></span><br><span class=line><span class=keyword>cmake_minimum_required</span>(VERSION <span class=number>3.10</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 指定C++标准版本</span></span><br><span class=line><span class=keyword>set</span>(CMAKE_CXX_STANDARD <span class=number>17</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 指定工程名称</span></span><br><span class=line><span class=comment># CXX可以不指定</span></span><br><span class=line><span class=keyword>project</span>(<span class=keyword>TEST</span> CXX)</span><br><span class=line></span><br><span class=line><span class=comment># 判断主机平台，增加编译宏</span></span><br><span class=line><span class=keyword>if</span> (CMAKE_HOST_SYSTEM_NAME <span class=keyword>MATCHES</span> <span class=string>"Linux"</span>)</span><br><span class=line>	<span class=keyword>message</span>(<span class=string>"-- Detecting system: Linux"</span>)</span><br><span class=line>	<span class=keyword>add_definitions</span>(-DBUILD_IN_LINUX)</span><br><span class=line><span class=keyword>else</span>()</span><br><span class=line>	<span class=keyword>message</span>(<span class=string>"-- Detecting system: Windows"</span>)</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line><span class=comment># 判断平台</span></span><br><span class=line><span class=keyword>if</span>(WIN32)</span><br><span class=line>	<span class=keyword>message</span>(STATUS <span class=string>"This is windows"</span>)</span><br><span class=line><span class=keyword>elseif</span>(UNIX)</span><br><span class=line>	<span class=keyword>message</span>(STATUS <span class=string>"This is linux"</span>)</span><br><span class=line><span class=keyword>else</span>()</span><br><span class=line>	<span class=keyword>message</span>(STATUS <span class=string>"This is mac"</span>)</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line></span><br><span class=line><span class=comment># 判断编译模式</span></span><br><span class=line><span class=keyword>if</span>(CMAKE_BUILD_TYPE <span class=keyword>AND</span> (CMAKE_BUILD_TYPE <span class=keyword>STREQUAL</span> <span class=string>"Debug"</span>))</span><br><span class=line>	<span class=keyword>set</span>(CMAKE_CXX_FLAGS_DEBUG <span class=string>"${CMAKE_CXX_FLAGS_DEBUG} -Wall -O0"</span>)</span><br><span class=line>	<span class=keyword>message</span>(STATUS <span class=string>"Build mode: ${CMAKE_BUILD_TYPE} ${CMAKE_CXX_FLAGS_DEBUG}"</span>)</span><br><span class=line><span class=keyword>else</span>()</span><br><span class=line>	<span class=keyword>set</span>(CMAKE_CXX_FLAGS_RELEASE <span class=string>"${CMAKE_CXX_FLAGS_RELEASE} -Wall"</span>)</span><br><span class=line>	<span class=keyword>message</span>(STATUS <span class=string>"Build mode: ${CMAKE_BUILD_TYPE} ${CMAKE_CXX_FLAGS_RELEASE}"</span>)</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line></span><br><span class=line><span class=comment># 查找curl包，CMake自带包管理</span></span><br><span class=line><span class=comment># 根据依赖添加</span></span><br><span class=line><span class=keyword>find_package</span>(CURL)</span><br><span class=line><span class=keyword>if</span>(CURL_FOUND)</span><br><span class=line>    <span class=keyword>include_directories</span>(<span class=variable>${CURL_INCLUDE_DIR}</span>)</span><br><span class=line><span class=keyword>else</span>()</span><br><span class=line>    <span class=keyword>message</span>(FATAL_ERROR <span class=string>"CURL library not found"</span>)</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line><span class=comment># 自定义LARCH包，REQUIRED必须具备此包</span></span><br><span class=line><span class=comment># 根据依赖添加</span></span><br><span class=line><span class=keyword>set</span>(CMAKE_MODULE_PATH <span class=variable>${CMAKE_CURRENT_BINARY_DIR}</span>/../cmod)</span><br><span class=line><span class=keyword>find_package</span>(LARCH REQUIRED)</span><br><span class=line><span class=keyword>if</span>(LARCH_FOUND)</span><br><span class=line>    <span class=keyword>message</span>(STATUS <span class=string>"LARCH library found"</span>)</span><br><span class=line>    <span class=keyword>include_directories</span>(<span class=variable>${LARCH_INCLUDE_DIR}</span>)</span><br><span class=line><span class=keyword>else</span>()</span><br><span class=line>    <span class=keyword>message</span>(FATAL_ERROR <span class=string>"LARCH library not found"</span>)</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line></span><br><span class=line><span class=comment># 配置各子组件，目录中需要包含CMakeLists.txt文件</span></span><br><span class=line><span class=keyword>add_subdirectory</span>(show)</span><br><span class=line><span class=keyword>add_subdirectory</span>(lib)</span><br><span class=line></span><br><span class=line><span class=comment># 配置工程各类组件输出路径</span></span><br><span class=line><span class=keyword>set</span>(EXECUTABLE_OUTPUT_PATH <span class=variable>${PROJECT_BINARY_DIR}</span>/bin)</span><br><span class=line><span class=keyword>set</span>(LIBRARY_OUTPUT_DIRECTORY <span class=variable>${PROJECT_BINARY_DIR}</span>/lib)</span><br><span class=line><span class=keyword>set</span>(ARCHIVE_OUTPUT_DIRECTORY <span class=variable>${PROJECT_BINARY_DIR}</span>/liba)</span><br><span class=line></span><br><span class=line><span class=comment># 设置环境变量方式</span></span><br><span class=line><span class=keyword>set</span>(ENV{ENV_PRO_PATH} <span class=variable>${PROJECT_BINARY_DIR}</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 递归(GLOB_RECURSE)查找src/AST目录中cpp文件</span></span><br><span class=line><span class=keyword>file</span>(GLOB_RECURSE AST_SOURCE <span class=string>"src/AST/*.cpp"</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 增加可执行文件编译目标</span></span><br><span class=line><span class=keyword>add_executable</span>(testc  <span class=string>"src/tools/Generator.cpp"</span></span><br><span class=line>						<span class=variable>${AST_SOURCE}</span></span><br><span class=line>)</span><br><span class=line></span><br><span class=line><span class=comment># 增加可执行文件编译的头文件目录</span></span><br><span class=line><span class=keyword>target_include_directories</span>(testc PUBLIC	<span class=keyword>include</span>	<span class=comment># include</span></span><br><span class=line>)</span><br><span class=line></span><br><span class=line><span class=comment># 处理过程执行命令</span></span><br><span class=line><span class=comment># 增加命令执行，并将结果输出到变量中，由message打印出来</span></span><br><span class=line><span class=keyword>exec_program</span>(ls <span class=variable>${PROJECT_BINARY_DIR}</span> </span><br><span class=line>                OUTPUT_VARIABLE o1</span><br><span class=line>                ARGS -l -h</span><br><span class=line>                RETURN_VALUE r1</span><br><span class=line>                )</span><br><span class=line><span class=keyword>message</span>(<span class=string>"ls output:\n${o1} \n ls return: ${r1}"</span>)</span><br></pre></table></figure><h2 id=message-1>message</h2><p>基本格式<p><code>message( [STATUS|WARNING|AUTHOR_WARNING|SEND_ERROR|FATAL_ERROR]  "Message to display" ...)</code><h3 id=status>STATUS</h3><p>状态消息，自动在消息前增加<code>--</code>以示区别<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>message(STATUS "Detecting system: Linux")</span><br><span class=line></span><br><span class=line>[cmake] -- Detecting system: Linux</span><br></pre></table></figure><h3 id=warfatal_errorning>WARFATAL_ERRORNING</h3><p>告警消息，消息单独显示一行，CMake会继续执行<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>message(WARNING "Detecting system: Linux")</span><br><span class=line></span><br><span class=line>[cmake] CMake Warning at CMakeLists.txt:8 (message):</span><br><span class=line>[cmake]   Detecting system: Linux</span><br><span class=line>[cmake] </span><br><span class=line>[cmake] </span><br><span class=line>[cmake] Not searching for unused variables given on the command line.</span><br></pre></table></figure><h3 id=author_warning>AUTHOR_WARNING</h3><p>开发者告警消息，消息单独显示一行，CMake会继续执行<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>message(AUTHOR_WARNING "Detecting system: Linux")</span><br><span class=line></span><br><span class=line>[cmake] CMake Warning (dev) at CMakeLists.txt:8 (message):</span><br><span class=line>[cmake]   Detecting system: Linux</span><br><span class=line>[cmake] This warning is for project developers.  Use -Wno-dev to suppress it.</span><br><span class=line>[cmake] </span><br><span class=line>[cmake] Not searching for unused variables given on the command line.</span><br></pre></table></figure><h3 id=send_error>SEND_ERROR</h3><p>错误消息，消息单独显示一行，CMake会继续执行但会跳过生成步骤<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>message(SEND_ERROR "Detecting system: Linux")</span><br><span class=line></span><br><span class=line>[cmake] CMake Error at CMakeLists.txt:8 (message):</span><br><span class=line>[cmake]   Detecting system: Linux</span><br><span class=line>[cmake] </span><br><span class=line>[cmake] </span><br><span class=line>[cmake] Not searching for unused variables given on the command line.</span><br><span class=line>[cmake] -- Configuring incomplete, errors occurred!</span><br><span class=line>[cmake] See also "/root/workspace/tcl3/build/CMakeFiles/CMakeOutput.log".</span><br></pre></table></figure><h3 id=fatal_error>FATAL_ERROR</h3><p>错误消息，消息单独显示一行，CMake会终止所有处理<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>message(FATAL_ERROR "Detecting system: Linux")</span><br><span class=line></span><br><span class=line>[cmake] CMake Error at CMakeLists.txt:8 (message):</span><br><span class=line>[cmake]   Detecting system: Linux</span><br><span class=line>[cmake] </span><br><span class=line>[cmake] </span><br><span class=line>[cmake] Not searching for unused variables given on the command line.</span><br><span class=line>[cmake] -- Configuring incomplete, errors occurred!</span><br><span class=line>[cmake] See also "/root/workspace/tcl3/build/CMakeFiles/CMakeOutput.log".</span><br></pre></table></figure><h2 id=自定义包>自定义包</h2><p>自定义<code>LARCH</code>包<p>创建文件<code>cmod/FindLARCH.cmake</code>，文件内容<figure class="highlight cmake"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=comment># set(CMAKE_FIND_LIBRARY_PREFIXES lib)</span></span><br><span class=line><span class=comment># set(CMAKE_FIND_LIBRARY_SUFFIXES .so)</span></span><br><span class=line></span><br><span class=line><span class=keyword>find_path</span>(LARCH_INCLUDE_DIR larch.h /tmp/<span class=keyword>test</span>/p1/<span class=keyword>include</span>)</span><br><span class=line><span class=keyword>find_path</span>(LARCH_LIBRARY liblarch.so /tmp/<span class=keyword>test</span>/p1/lib)</span><br><span class=line><span class=comment># find_library(LARCH_LIBRARY NAMES larch PATH /tmp/test/p1/lib)</span></span><br><span class=line></span><br><span class=line><span class=keyword>if</span>(LARCH_INCLUDE_DIR <span class=keyword>AND</span> LARCH_LIBRARY)</span><br><span class=line>    <span class=keyword>set</span>(LARCH_FOUND <span class=keyword>TRUE</span>)</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line></span><br><span class=line><span class=keyword>if</span>(LARCH_FOUND)</span><br><span class=line>    <span class=keyword>if</span>(<span class=keyword>NOT</span> LARCH_FIND_QUIETLY)</span><br><span class=line>        <span class=keyword>message</span>(STATUS <span class=string>"Found LARCH: ${LARCH_LIBRARY}"</span>)</span><br><span class=line>    <span class=keyword>endif</span>()</span><br><span class=line><span class=keyword>else</span>()</span><br><span class=line>    <span class=keyword>if</span>(LARCH_FIND_REQUIRED)</span><br><span class=line>        <span class=keyword>message</span>(FATAL_ERROR <span class=string>"LARCH library not found"</span>)</span><br><span class=line>    <span class=keyword>endif</span>()</span><br><span class=line><span class=keyword>endif</span>()</span><br><span class=line></span><br></pre></table></figure><h2 id=子组件>子组件</h2><h3 id=库文件>库文件</h3><figure class="highlight cmake"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=keyword>cmake_minimum_required</span>(VERSION <span class=number>3.10</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 配置库源文件</span></span><br><span class=line><span class=keyword>set</span>(LIB_SRC larch.c)</span><br><span class=line></span><br><span class=line><span class=comment># 配置版本号</span></span><br><span class=line><span class=keyword>set</span>(API_VERSION <span class=number>1.2</span>)</span><br><span class=line><span class=keyword>set</span>(CUR_VERSION <span class=number>1.2</span>.<span class=number>1</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 编译动态库；VERSION为当前版本；SOVERSION为API版本，它会链接到当前版本，不带版本库也会链接到API版本；</span></span><br><span class=line><span class=keyword>add_library</span>(larch SHARED <span class=variable>${LIB_SRC}</span>)</span><br><span class=line><span class=keyword>set_target_properties</span>(larch PROPERTIES VERSION <span class=variable>${CUR_VERSION}</span> SOVERSION <span class=variable>${API_VERSION}</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 编译静态库，目标不能同名，静态库需要用属性来修改</span></span><br><span class=line><span class=keyword>add_library</span>(larch_static STATIC <span class=variable>${LIB_SRC}</span>)</span><br><span class=line><span class=keyword>set_target_properties</span>(larch_static PROPERTIES OUTPUT_NAME <span class=string>"larch"</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 获取目标属性</span></span><br><span class=line><span class=keyword>get_target_property</span>(OV larch_static OUTPUT_NAME)</span><br><span class=line><span class=comment># message(STATUS "This is larch_static name:"${OV})</span></span><br><span class=line></span><br><span class=line><span class=comment># 配置共享库和头文件安装路径</span></span><br><span class=line><span class=keyword>install</span>(TARGETS larch larch_static</span><br><span class=line>        RUNTIME DESTINATION /<span class=variable>${PROJECT_NAME}</span>/bin        <span class=comment># 执行程序</span></span><br><span class=line>        LIBRARY DESTINATION /<span class=variable>${PROJECT_NAME}</span>/lib        <span class=comment># 动态库</span></span><br><span class=line>        ARCHIVE DESTINATION /<span class=variable>${PROJECT_NAME}</span>/libstatic  <span class=comment># 静态库</span></span><br><span class=line>        <span class=comment># PERMISSIONS OWNER_EXECUTE OWNER_READ OWNER_WRITE GROUP_READ WORLD_READ  # 配置权限</span></span><br><span class=line>)</span><br><span class=line><span class=keyword>install</span>(FILES larch.h DESTINATION /<span class=variable>${PROJECT_NAME}</span>/<span class=keyword>include</span>)</span><br></pre></table></figure><h3 id=可执行文件>可执行文件</h3><figure class="highlight cmake"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br></pre><td class=code><pre><span class=line><span class=keyword>cmake_minimum_required</span>(VERSION <span class=number>3.10</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 配置源码和输出路径</span></span><br><span class=line><span class=comment># set(DESTDIR /usr/local)</span></span><br><span class=line><span class=comment># CMAKE_INSTALL_PREFIX:=/usr/local</span></span><br><span class=line><span class=comment># set(SRC_LIST main.c)</span></span><br><span class=line><span class=keyword>aux_source_directory</span>(. SRC_LIST)</span><br><span class=line></span><br><span class=line><span class=comment># 配置cmake构建打印</span></span><br><span class=line><span class=keyword>message</span>(STATUS <span class=string>"Start build tr"</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 配置编译执行程序</span></span><br><span class=line><span class=keyword>add_executable</span>(tr <span class=variable>${SRC_LIST}</span>)</span><br><span class=line></span><br><span class=line><span class=comment># 配置头文件搜索路径</span></span><br><span class=line><span class=comment># 这里应该改为工程包含路径${LARCH_INCLUDE_DIR}，见自定义LARCH包</span></span><br><span class=line><span class=keyword>find_path</span>(header_path NAMES larch.h PATHS ../lib)</span><br><span class=line><span class=keyword>if</span>(header_path)</span><br><span class=line>        <span class=keyword>include_directories</span>(<span class=variable>${header_path}</span>)</span><br><span class=line>        <span class=keyword>message</span>(STATUS <span class=string>"find header path: "</span> <span class=variable>${header_path}</span>)</span><br><span class=line><span class=keyword>endif</span>(header_path)</span><br><span class=line></span><br><span class=line><span class=comment># 配置动态库或静态库（liblarch.a）</span></span><br><span class=line><span class=keyword>target_link_libraries</span>(tr larch)</span><br><span class=line><span class=keyword>add_dependencies</span>(tr larch)</span><br><span class=line></span><br><span class=line><span class=comment># 配置程序和库安装路径</span></span><br><span class=line><span class=keyword>install</span>(TARGETS tr</span><br><span class=line>        RUNTIME DESTINATION /<span class=variable>${PROJECT_NAME}</span>/bin        <span class=comment># 执行程序</span></span><br><span class=line>        LIBRARY DESTINATION /<span class=variable>${PROJECT_NAME}</span>/lib        <span class=comment># 动态库</span></span><br><span class=line>        ARCHIVE DESTINATION /<span class=variable>${PROJECT_NAME}</span>/libstatic  <span class=comment># 静态库</span></span><br><span class=line>        <span class=comment># PERMISSIONS OWNER_EXECUTE OWNER_READ OWNER_WRITE GROUP_READ WORLD_READ  # 配置权限</span></span><br><span class=line>)</span><br><span class=line></span><br><span class=line><span class=comment># 配置文档或目录安装路径</span></span><br><span class=line><span class=keyword>install</span>(PROGRAMS ReadMe.md DESTINATION /<span class=variable>${PROJECT_NAME}</span>/docs</span><br><span class=line>        PERMISSIONS OWNER_READ OWNER_WRITE GROUP_READ WORLD_READ    <span class=comment># 配置权限</span></span><br><span class=line>)</span><br><span class=line><span class=keyword>install</span>(DIRECTORY scripts/ DESTINATION /<span class=variable>${PROJECT_NAME}</span>/scripts</span><br><span class=line>        PATTERN <span class=string>"scripts/*.sh"</span></span><br><span class=line>        PATTERN <span class=string>"scripts/*.conf"</span> EXCLUDE</span><br><span class=line>)</span><br><span class=line></span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/03/27/X-Y-Zmodem%E5%8D%8F%E8%AE%AE%E8%AF%B4%E6%98%8E/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/03/27/X-Y-Zmodem%E5%8D%8F%E8%AE%AE%E8%AF%B4%E6%98%8E/ itemprop=url>X/Y/Zmodem协议说明</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-03-27 12:33:50" datetime=2024-03-27T12:33:50+08:00>2024-03-27</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/ itemprop=url rel=index><span itemprop=name>传输协议</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>2.6k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>9 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h2 id=xmodem>Xmodem</h2><p>参考<a href=https://zhuanlan.zhihu.com/p/349921713 rel=noopener target=_blank>Xmodem 协议介绍及应用（基于 ESP-IDF）</a><p>数据长度有两种：128字节和1K字节。以下主要以windterm版本进行说明，可能在不同版本中有些许差异。<h3 id=协议控制符>协议控制符</h3><table><thead><tr class=header><th>缩写<th>数值<th>说明<tbody><tr class=odd><td>SOH<td>0x01<td>modem 128字节头标识<tr class=even><td>STX<td>0x02<td>modem 1024字节头标识<tr class=odd><td>EOT<td>0x04<td>结束文件传输<tr class=even><td>ACK<td>0x06<td>正常响应<tr class=odd><td>NAK<td>0x15<td>非正常响应<tr class=even><td>ETB<td>0x17<td>传输块结束<tr class=odd><td>CAN<td>0x18<td>取消文件传输<tr class=even><td>CRC16<td>0x43<td>使用CRC16校验标志</table><h3 id=xmodem-1k协议帧格式>Xmodem-1K协议帧格式</h3><p>windterm版本发送Frame基本格式：<table><thead><tr class=header><th>Byte 0<th>Byte 1<th>Byte 2<th>Byte 3~1026<th>Byte 1027<tbody><tr class=odd><td>头标识<td>序号<td>序号反码<td>数据区<td>数据总长度</table><p>各字段说明：<ul><li>头标识可以为：SOH和STX<li>序号范围0~255；<li>数据区不足部分需要使用0x1a补齐；</ul><h3 id=xmodem-1k交互流程>Xmodem-1K交互流程</h3><table><thead><tr class=header><th>Sender<th>Flow<th>Receiver<tbody><tr class=odd><td><td>&lt;==<td>NAK<tr class=even><td><td><td>Timeout after 0.5 seconds<tr class=odd><td><td>&lt;==<td>NAK<tr class=even><td>Frame-01<td>==><td>Frame OK<tr class=odd><td><td>&lt;==<td>ACK<tr class=even><td>Frame-02<td>==><td>Frame Error<tr class=odd><td><td>&lt;==<td>NAK<tr class=even><td>Frame-02<td>==><td>Frame OK<tr class=odd><td><td>&lt;==<td>ACK<tr class=even><td>EOT<td>==><td>OK<tr class=odd><td><td>&lt;==<td>ACK</table><p>接收方 - 开启xmodem模式，每0.5s发送一次0x15； - 当接收到帧数据时，正确回复ACK响应，异常回复NAK响应； - 当接收到EOT时，传输结束；<p>发送方 - 开启xmodem模式，等待接收NAK； - 发送帧数据，等待接收响应； - 当所有数据发送完毕时，主动发送EOT，传输结束；<h3 id=交互示例>交互示例</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br></pre><td class=code><pre><span class=line>send COM21 (1)</span><br><span class=line>str:</span><br><span class=line> d</span><br><span class=line></span><br><span class=line>recv COM21 (51)</span><br><span class=line>str:</span><br><span class=line></span><br><span class=line>download safety code</span><br><span class=line>start xModem Receive-></span><br><span class=line> d a d d a 64 6f 77 6e 6c 6f 61 64 20 73 61 66 65 74 79 20 63 6f 64 65 d d a 73 74 61 72 74 20 78 4d 6f 64 65 6d 20 52 65 63 65 69 76 65 2d 3e 15</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>send COM21 (12)</span><br><span class=line>str: rx data.log</span><br><span class=line> 72 78 20 64 61 74 61 2e 6c 6f 67 d</span><br><span class=line></span><br><span class=line>recv COM21 (12)</span><br><span class=line>str:</span><br><span class=line> 15 15 15 15 15 15 15 15 15 15 15 15</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>send COM21 (1024)</span><br><span class=line>str: ?123456789␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦</span><br><span class=line> 2 1 fffffffe 30 31 32 33 34 35 36 37 38 39 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a</span><br><span class=line></span><br><span class=line>send COM21 (4)</span><br><span class=line>str: ␦␦␦</span><br><span class=line> 1a 1a 1a 9</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 15</span><br><span class=line></span><br><span class=line>send COM21 (1024)</span><br><span class=line>str: ?123456789␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦␦</span><br><span class=line> 2 1 fffffffe 30 31 32 33 34 35 36 37 38 39 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a 1a</span><br><span class=line></span><br><span class=line>send COM21 (4)</span><br><span class=line>str: ␦␦␦</span><br><span class=line> 1a 1a 1a 9</span><br><span class=line></span><br><span class=line>recv COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 6</span><br><span class=line></span><br><span class=line>send COM21 (1)</span><br><span class=line>str:</span><br><span class=line> 4</span><br><span class=line></span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2024/02/26/CentOS7-%E5%9B%BD%E5%86%85%E7%8E%AF%E5%A2%83Kubernetes%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/02/26/CentOS7-%E5%9B%BD%E5%86%85%E7%8E%AF%E5%A2%83Kubernetes%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E/ itemprop=url>CentOS7-国内环境Kubernetes安装说明</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-02-26 16:39:52" datetime=2024-02-26T16:39:52+08:00>2024-02-26</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Kubernetes/ itemprop=url rel=index><span itemprop=name>Kubernetes</span></a> </span> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>7.5k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>27 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=docker容器安装>Docker容器安装</h1><h2 id=镜像源切换>镜像源切换</h2><h3 id=centos7主机>CentOS7主机</h3><p>软件源切换<a href="https://developer.aliyun.com/mirror/centos?spm=a2c6h.13651102.0.0.57831b11vaqctA" rel=noopener target=_blank>阿里开源镜像站</a><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>源备份</span></span><br><span class=line>mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/bk.CentOS-Base.repo</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>下载镜像源</span></span><br><span class=line>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>升级系统相关组件</span></span><br><span class=line>yum update</span><br><span class=line>yum upgrade</span><br></pre></table></figure><h2 id=容器本体安装>容器本体安装</h2><h3 id=centos7主机-1>CentOS7主机</h3><p>参考：<a href=https://www.runoob.com/docker/centos-docker-install.html rel=noopener target=_blank>菜鸟教程-CentOS Docker安装</a><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=comment># 安装容器基本依赖</span></span><br><span class=line><span class=built_in>sudo</span> yum install -y yum-utils \</span><br><span class=line>  device-mapper-persistent-data \</span><br><span class=line>  lvm2</span><br><span class=line><span class=built_in>sudo</span> yum-config-manager \</span><br><span class=line>    --add-repo \</span><br><span class=line>    https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class=line></span><br><span class=line><span class=comment># 安装特定版本容器，19.03.15</span></span><br><span class=line>yum list docker-ce --showduplicates | <span class=built_in>sort</span> -r</span><br><span class=line>VERSION_STRING=19.03.15; <span class=built_in>sudo</span> yum install -y docker-ce-<span class=variable>${VERSION_STRING}</span> docker-ce-cli-<span class=variable>${VERSION_STRING}</span> containerd.io</span><br><span class=line></span><br><span class=line><span class=comment># 启动服务</span></span><br><span class=line>systemctl start docker && systemctl <span class=built_in>enable</span> docker</span><br></pre></table></figure><h2 id=容器配置>容器配置</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>/home/imsdata/docker是Docker基本路径，镜像和容器都会占用此空间，根据需要改动</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>https://hub-mirror.c.163.com</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>https://reg-mirror.qiniu.com</span></span><br><span class=line>mkdir -p /etc/docker && mkdir -p /mnt/data_20/docker-root && cat > /etc/docker/daemon.json &lt;&lt;-EOF</span><br><span class=line>{</span><br><span class=line>    "registry-mirrors": [</span><br><span class=line>        "http://docker.mirrors.ustc.edu.cn",</span><br><span class=line>        "http://registry.docker-cn.com",</span><br><span class=line>        "http://hub-mirror.c.163.com"</span><br><span class=line>    ],</span><br><span class=line>    "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class=line>    "log-driver": "json-file",</span><br><span class=line>    "log-opts": {</span><br><span class=line>        "max-size": "100m",</span><br><span class=line>        "max-file": "3"</span><br><span class=line>    },</span><br><span class=line>    "data-root": "$_"</span><br><span class=line>}</span><br><span class=line>EOF</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>老版本为graph</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>重启容器生效</span></span><br><span class=line>systemctl daemon-reload && systemctl restart docker</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>容器命令验证，Docker Root Dir: 得到配置的路径</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>Cgroup Driver: systemd</span></span><br><span class=line>docker info | grep -E "Docker Root Dir:|Cgroup Driver:"</span><br></pre></table></figure><h1 id=安装前准备>安装前准备</h1><h2 id=设置主机名>设置主机名</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>设置主机名</span></span><br><span class=line>hostnamectl set-hostname &lt;HOSTNAME></span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>将所有主机名加入hosts中，修改/etc/hosts</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash><span class=built_in>echo</span> -ne <span class=string>"192.168.11.251 node1\n192.168.11.252 node2\n192.168.11.253 node3\n"</span> >> /etc/hosts</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash><span class=built_in>echo</span> -ne <span class=string>"n1 192.168.58.12\nn2 192.168.58.14\n"</span> >> /etc/hosts</span></span><br><span class=line>echo &lt;IP> &lt;HOSTNAME> >> /etc/hosts</span><br></pre></table></figure><h2 id=禁用防火墙和缓存>禁用防火墙和缓存</h2><h3 id=centos主机>CentOS主机</h3><p>以下步骤二选一，若跳过禁用防火墙，需要增加端口规则：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>禁用防火墙</span></span><br><span class=line>systemctl stop firewalld && systemctl disable firewalld</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>开启防火墙后，需要打开NAT转发</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>否则k8s正常启动后，dns解析失败</span></span><br><span class=line>firewall-cmd --permanent --add-masquerade</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>开放端口规则</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>必须开放k8s使用的6443 10250</span></span><br><span class=line>firewall-cmd --permanent --zone=public --add-port=6443/tcp</span><br><span class=line>firewall-cmd --permanent --zone=public --add-port=10250/tcp</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>删除端口规则</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>firewall-cmd --permanent --zone=public --remove-port=6443/tcp</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>开放指定范围端口规则</span></span><br><span class=line>firewall-cmd --permanent --zone=public --add-port=31080-31090/tcp</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>开发虚拟网卡</span></span><br><span class=line>firewall-cmd --permanent --zone=public --add-interface=cni0</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>让规则生效</span></span><br><span class=line>firewall-cmd --reload</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>查看所有规则</span></span><br><span class=line>firewall-cmd --list-all</span><br></pre></table></figure><p>禁用缓存：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>禁用swap</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>注释/etc/fstab中swap行</span></span><br><span class=line>swapoff -a</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>注释swap相关行 /mnt/swap swap swap defaults 0 0 这一行或者注释掉这一行</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>虚拟机中运行</span> </span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>sed -i <span class=string>'s%^/dev/mapper/centos-swap.%# swap %g'</span> /etc/fstab</span></span><br><span class=line>sed -i 's/\(^[^#|.]*swap.*swap.*\)/#\1/g' /etc/fstab</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>修改启动等待时间为1s</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>vim /boot/grub2/grub.cfg，修改第一个<span class=built_in>timeout</span>值为0，跳过开机等待</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>sed -i <span class=string>'s/^  set timeout=.*/  set timeout=0/'</span> /boot/grub2/grub.cfg</span></span><br><span class=line>sed -i 's/\(^\s*set timeout=\).*/\13/' /boot/grub2/grub.cfg</span><br></pre></table></figure><h2 id=关闭selinux>关闭SELinux</h2><h3 id=centos主机-1>CentOS主机</h3><p><strong>永久方法 – 需要重启服务器</strong><p>修改 <code>/etc/selinux/config</code> 文件中设置 SELINUX=disabled ，然后重启服务器，命令<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">#</span><span class=language-bash>sed -i <span class=string>'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span></span><br><span class=line>sed -i 's/\(^SELINUX=\).*/\1disabled/g' /etc/selinux/config</span><br><span class=line>setenforce 0</span><br></pre></table></figure><h2 id=打开iptables的支持>打开iptables的支持</h2><p>Debian10通过命令<code>sysctl -a</code>查看，默认已经打开iptabels支持。<h3 id=centos主机-2>CentOS主机</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>配置内核参数（虚拟机方式）</span></span><br><span class=line>echo -ne "net.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\n" >> /etc/sysctl.conf</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>内核配置生效</span></span><br><span class=line>sysctl -p</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>显示内核参数，回显1为打开，0为关闭</span></span><br><span class=line>sysctl -a | egrep "bridge-nf-call-iptables|bridge-nf-call-ip6tables|ip_forward"</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>另一种查看方法</span></span><br><span class=line>cat /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class=line>cat /proc/sys/net/bridge/bridge-nf-call-ip6tables</span><br><span class=line>cat /proc/sys/net/ipv4/ip_forward</span><br><span class=line></span><br></pre></table></figure><h2 id=配置国内源>配置国内源</h2><p>若有vpn可以跳过，参考：<a href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11M95pHS" rel=noopener target=_blank>阿里开源-Kubernetes镜像</a><h3 id=centos主机-3>CentOS主机</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>配置国内源</span></span><br><span class=line>cat &lt;&lt;EOF > /etc/yum.repos.d/kubernetes.repo</span><br><span class=line>[kubernetes]</span><br><span class=line>name=Kubernetes</span><br><span class=line>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class=line>enabled=1</span><br><span class=line>gpgcheck=1</span><br><span class=line>repo_gpgcheck=1</span><br><span class=line>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=line>EOF</span><br><span class=line>sudo yum update</span><br></pre></table></figure><p>若出现签名验证不过<code>signature could not be verified for kubernetes</code>，可以强行跳过签名验证：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>配置国内源</span></span><br><span class=line>cat &lt;&lt;EOF > /etc/yum.repos.d/kubernetes.repo</span><br><span class=line>[kubernetes]</span><br><span class=line>name=Kubernetes</span><br><span class=line>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class=line>enabled=1</span><br><span class=line>gpgcheck=0</span><br><span class=line>repo_gpgcheck=0</span><br><span class=line>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=line>EOF</span><br><span class=line>sudo yum update</span><br></pre></table></figure><h2 id=安装辅助工具>安装辅助工具</h2><p>安装特定版本辅助工具，例如：1.21.14<h3 id=centos主机-4>CentOS主机</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>安装特定版本的工具</span></span><br><span class=line>yum list kubelet --showduplicates | sort -r</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>KUBE_VERSION=1.21.11; yum install -y kubelet-<span class=variable>${KUBE_VERSION}</span> kubeadm-<span class=variable>${KUBE_VERSION}</span> kubectl-<span class=variable>${KUBE_VERSION}</span></span></span><br><span class=line>KUBE_VERSION=1.21.14; yum install -y kubelet-${KUBE_VERSION} kubeadm-${KUBE_VERSION} kubectl-${KUBE_VERSION}</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动kubelet</span></span><br><span class=line>systemctl enable kubelet && systemctl start kubelet</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>此时因k8s配置文件不存在，kubelet启动失败</span></span><br><span class=line>systemctl status kubelet</span><br></pre></table></figure><h1 id=安装k8s>安装K8s</h1><h2 id=拉取镜像>拉取镜像</h2><p>从国内源在线拉取<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>列出所有需要的版本镜像</span></span><br><span class=line>kubeadm config images list --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>拉取所有需要的版本镜像</span></span><br><span class=line>kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>测试域名 docker pull busybox:1.28.4</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>网络控制器 docker pull quay.io/coreos/flannel:v0.14.0</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>ingress类控制器 docker pull quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.29.0</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>集群管理 docker pull swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3</span></span><br></pre></table></figure><p>若已下载镜像执行<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>ls k8s-images-1.21.9/*.image | while read file; do docker image load -i $file; done</span><br><span class=line>ls flannel-images/*.image | while read file; do docker image load -i $file; done</span><br></pre></table></figure><h2 id=离线安装批量镜像处理非必须>【离线安装】批量镜像处理——非必须</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>批量保存镜像</span></span><br><span class=line>docker image ls | grep "registry.cn-hangzhou.aliyuncs.com" | awk '{print $1 ":" $2}' | while read image; do file=${image//\//_}.image; file=${file//:/_}; docker image save $image -o $file; done</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>批量加载镜像</span></span><br><span class=line>ls *.image | while read file; do docker image load -i $file; done</span><br></pre></table></figure><h2 id=初始化k8s>初始化K8s</h2><p>从节点无需初始化<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>指定镜像源初始化</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>需要特定网络，需要在此步骤中指定</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>使用flannel网络需要指定--pod-network-cidr参数</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>--pod-network-cidr 指定pod网络地址范围</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>--apiserver-advertise-address 指定集群API server绑定地址</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>--service-dns-domain 指定各服务顶级dns域名</span></span><br><span class=line>kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=172.20.1.25 --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers --service-dns-domain=ice | tee ./kubeadm-init.log</span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.8.101 --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers --service-dns-domain=viid</span></span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>出现Your Kubernetes control-plane has initialized successfully!表明初始化正常</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>服务状态正常，但因未配置网络/etc/cni/net.d，后台上报异常</span></span><br><span class=line>systemctl status kubelet</span><br></pre></table></figure><p>若有cgroup改systemd告警，处理<a href=https://kubernetes.io/docs/setup/production-environment/container-runtimes/ rel=noopener target=_blank>参考</a><h2 id=安装命令补全工具>安装命令补全工具</h2><p>参考后面K8s配置章节<h2 id=启动集群>启动集群</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动集群</span></span><br><span class=line>mkdir -p $HOME/.kube</span><br><span class=line>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class=line>sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>若是root用户，需要执行</span></span><br><span class=line>export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>允许Master参与调度，单节点必须将Master置为可调度状态</span></span><br><span class=line>kubectl get nodes</span><br><span class=line>kubectl taint node localhost.localdomain node-role.kubernetes.io/master-  #将 Master 也当作 Node 使用</span><br><span class=line>kubectl taint node localhost.localdomain node-role.kubernetes.io/master=:NoSchedule #将 Master 恢复成 Master Only 状态</span><br></pre></table></figure><h2 id=路由选择>路由选择</h2><p>默认kube-proxy使用iptables实现，随着service、pod数量增加，iptables顺序遍历的方式就会凸显。可替代方案可以选择：<ul><li>iptables<li>IPVS</ul><p>kube-proxy支持的另一种模式，性能比iptables更高，推荐使用。参考<a href=https://www.cnblogs.com/ccbyk-90/p/11795903.html rel=noopener target=_blank>文章</a><ul><li>eBPF</ul><p>整体成熟度低，不建议单独使用，参考<a href=https://cloud.tencent.com/developer/article/1687922 rel=noopener target=_blank>文章</a><p>替换kube-proxy方法，参考<a href=https://zhuanlan.zhihu.com/p/137960916 rel=noopener target=_blank>文章</a><p>可以对数据包进行观测，参考<a href=https://www.jianshu.com/p/6d303f176463 rel=noopener target=_blank>文章</a><h2 id=网络配置>网络配置</h2><p>上面安装成功后如果通过查询kube-system下Pod的运行情况，会放下和网络相关的Pod都处于Pending的状态，这是因为缺少相关的网络插件，而网络插件有很多个（以下任选一个），可以选择自己需要的。参考：<a href=https://kubernetes.feisky.xyz/extension/network rel=noopener target=_blank>Kubernetes指南</a><h3 id=flannel>flannel</h3><p>参考<a href=https://github.com/flannel-io/flannel/blob/master/Documentation/kubernetes.md rel=noopener target=_blank>官网</a><p>官方网站，在<code>Documentation</code>文件夹中，参考<code>kube-flannel.yaml</code>, <code>kube-flannel-aliyun.yaml</code>, <code>kube-flannel-old.yaml</code>等<a href=https://github.com/flannel-io/flannel/tree/v0.14.1/Documentation rel=noopener target=_blank>描述</a>文件<p>kube-flannel.yaml文件内容：<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br><span class=line>180</span><br><span class=line>181</span><br><span class=line>182</span><br><span class=line>183</span><br><span class=line>184</span><br><span class=line>185</span><br><span class=line>186</span><br><span class=line>187</span><br><span class=line>188</span><br><span class=line>189</span><br><span class=line>190</span><br><span class=line>191</span><br><span class=line>192</span><br><span class=line>193</span><br><span class=line>194</span><br><span class=line>195</span><br><span class=line>196</span><br><span class=line>197</span><br><span class=line>198</span><br><span class=line>199</span><br><span class=line>200</span><br><span class=line>201</span><br><span class=line>202</span><br><span class=line>203</span><br><span class=line>204</span><br><span class=line>205</span><br><span class=line>206</span><br><span class=line>207</span><br><span class=line>208</span><br><span class=line>209</span><br><span class=line>210</span><br><span class=line>211</span><br><span class=line>212</span><br><span class=line>213</span><br><span class=line>214</span><br><span class=line>215</span><br><span class=line>216</span><br><span class=line>217</span><br><span class=line>218</span><br><span class=line>219</span><br><span class=line>220</span><br><span class=line>221</span><br><span class=line>222</span><br><span class=line>223</span><br></pre><td class=code><pre><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>policy/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>PodSecurityPolicy</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>psp.flannel.unprivileged</span></span><br><span class=line>  <span class=attr>annotations:</span></span><br><span class=line>    <span class=attr>seccomp.security.alpha.kubernetes.io/allowedProfileNames:</span> <span class=string>docker/default</span></span><br><span class=line>    <span class=attr>seccomp.security.alpha.kubernetes.io/defaultProfileName:</span> <span class=string>docker/default</span></span><br><span class=line>    <span class=attr>apparmor.security.beta.kubernetes.io/allowedProfileNames:</span> <span class=string>runtime/default</span></span><br><span class=line>    <span class=attr>apparmor.security.beta.kubernetes.io/defaultProfileName:</span> <span class=string>runtime/default</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>privileged:</span> <span class=literal>false</span></span><br><span class=line>  <span class=attr>volumes:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>configMap</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>secret</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>emptyDir</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>hostPath</span></span><br><span class=line>  <span class=attr>allowedHostPaths:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>pathPrefix:</span> <span class=string>"/etc/cni/net.d"</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>pathPrefix:</span> <span class=string>"/etc/kube-flannel"</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>pathPrefix:</span> <span class=string>"/run/flannel"</span></span><br><span class=line>  <span class=attr>readOnlyRootFilesystem:</span> <span class=literal>false</span></span><br><span class=line>  <span class=comment># Users and groups</span></span><br><span class=line>  <span class=attr>runAsUser:</span></span><br><span class=line>    <span class=attr>rule:</span> <span class=string>RunAsAny</span></span><br><span class=line>  <span class=attr>supplementalGroups:</span></span><br><span class=line>    <span class=attr>rule:</span> <span class=string>RunAsAny</span></span><br><span class=line>  <span class=attr>fsGroup:</span></span><br><span class=line>    <span class=attr>rule:</span> <span class=string>RunAsAny</span></span><br><span class=line>  <span class=comment># Privilege Escalation</span></span><br><span class=line>  <span class=attr>allowPrivilegeEscalation:</span> <span class=literal>false</span></span><br><span class=line>  <span class=attr>defaultAllowPrivilegeEscalation:</span> <span class=literal>false</span></span><br><span class=line>  <span class=comment># Capabilities</span></span><br><span class=line>  <span class=attr>allowedCapabilities:</span> [<span class=string>'NET_ADMIN'</span>, <span class=string>'NET_RAW'</span>]</span><br><span class=line>  <span class=attr>defaultAddCapabilities:</span> []</span><br><span class=line>  <span class=attr>requiredDropCapabilities:</span> []</span><br><span class=line>  <span class=comment># Host namespaces</span></span><br><span class=line>  <span class=attr>hostPID:</span> <span class=literal>false</span></span><br><span class=line>  <span class=attr>hostIPC:</span> <span class=literal>false</span></span><br><span class=line>  <span class=attr>hostNetwork:</span> <span class=literal>true</span></span><br><span class=line>  <span class=attr>hostPorts:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>min:</span> <span class=number>0</span></span><br><span class=line>    <span class=attr>max:</span> <span class=number>65535</span></span><br><span class=line>  <span class=comment># SELinux</span></span><br><span class=line>  <span class=attr>seLinux:</span></span><br><span class=line>    <span class=comment># SELinux is unused in CaaSP</span></span><br><span class=line>    <span class=attr>rule:</span> <span class=string>'RunAsAny'</span></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>flannel</span></span><br><span class=line><span class=attr>rules:</span></span><br><span class=line><span class=bullet>-</span> <span class=attr>apiGroups:</span> [<span class=string>'extensions'</span>]</span><br><span class=line>  <span class=attr>resources:</span> [<span class=string>'podsecuritypolicies'</span>]</span><br><span class=line>  <span class=attr>verbs:</span> [<span class=string>'use'</span>]</span><br><span class=line>  <span class=attr>resourceNames:</span> [<span class=string>'psp.flannel.unprivileged'</span>]</span><br><span class=line><span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>  <span class=attr>resources:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>pods</span></span><br><span class=line>  <span class=attr>verbs:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line><span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>  <span class=attr>resources:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>nodes</span></span><br><span class=line>  <span class=attr>verbs:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>list</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>watch</span></span><br><span class=line><span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>  <span class=attr>resources:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>nodes/status</span></span><br><span class=line>  <span class=attr>verbs:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>patch</span></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRoleBinding</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>flannel</span></span><br><span class=line><span class=attr>roleRef:</span></span><br><span class=line>  <span class=attr>apiGroup:</span> <span class=string>rbac.authorization.k8s.io</span></span><br><span class=line>  <span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>flannel</span></span><br><span class=line><span class=attr>subjects:</span></span><br><span class=line><span class=bullet>-</span> <span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>flannel</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>flannel</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ConfigMap</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>kube-flannel-cfg</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>tier:</span> <span class=string>node</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>flannel</span></span><br><span class=line><span class=attr>data:</span></span><br><span class=line>  <span class=attr>cni-conf.json:</span> <span class=string>|</span></span><br><span class=line><span class=string>    {</span></span><br><span class=line><span class=string>      "name": "cbr0",</span></span><br><span class=line><span class=string>      "cniVersion": "0.3.1",</span></span><br><span class=line><span class=string>      "plugins": [</span></span><br><span class=line><span class=string>        {</span></span><br><span class=line><span class=string>          "type": "flannel",</span></span><br><span class=line><span class=string>          "delegate": {</span></span><br><span class=line><span class=string>            "hairpinMode": true,</span></span><br><span class=line><span class=string>            "isDefaultGateway": true</span></span><br><span class=line><span class=string>          }</span></span><br><span class=line><span class=string>        },</span></span><br><span class=line><span class=string>        {</span></span><br><span class=line><span class=string>          "type": "portmap",</span></span><br><span class=line><span class=string>          "capabilities": {</span></span><br><span class=line><span class=string>            "portMappings": true</span></span><br><span class=line><span class=string>          }</span></span><br><span class=line><span class=string>        }</span></span><br><span class=line><span class=string>      ]</span></span><br><span class=line><span class=string>    }</span></span><br><span class=line><span class=string></span>  <span class=attr>net-conf.json:</span> <span class=string>|</span></span><br><span class=line><span class=string>    {</span></span><br><span class=line><span class=string>      "Network": "10.244.0.0/16",</span></span><br><span class=line><span class=string>      "Backend": {</span></span><br><span class=line><span class=string>        "Type": "host-gw"</span></span><br><span class=line><span class=string>      }</span></span><br><span class=line><span class=string>    }</span></span><br><span class=line><span class=string></span><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>DaemonSet</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>kube-flannel-ds</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>tier:</span> <span class=string>node</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>flannel</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app:</span> <span class=string>flannel</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>tier:</span> <span class=string>node</span></span><br><span class=line>        <span class=attr>app:</span> <span class=string>flannel</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>affinity:</span></span><br><span class=line>        <span class=attr>nodeAffinity:</span></span><br><span class=line>          <span class=attr>requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>            <span class=attr>nodeSelectorTerms:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>matchExpressions:</span></span><br><span class=line>              <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>kubernetes.io/os</span></span><br><span class=line>                <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>                <span class=attr>values:</span></span><br><span class=line>                <span class=bullet>-</span> <span class=string>linux</span></span><br><span class=line>      <span class=attr>hostNetwork:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>priorityClassName:</span> <span class=string>system-node-critical</span></span><br><span class=line>      <span class=attr>tolerations:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>operator:</span> <span class=string>Exists</span></span><br><span class=line>        <span class=attr>effect:</span> <span class=string>NoSchedule</span></span><br><span class=line>      <span class=attr>serviceAccountName:</span> <span class=string>flannel</span></span><br><span class=line>      <span class=attr>initContainers:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>install-cni</span></span><br><span class=line>        <span class=attr>image:</span> <span class=string>quay.io/coreos/flannel:v0.14.0</span></span><br><span class=line>        <span class=attr>command:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>cp</span></span><br><span class=line>        <span class=attr>args:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>-f</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>/etc/kube-flannel/cni-conf.json</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>/etc/cni/net.d/10-flannel.conflist</span></span><br><span class=line>        <span class=attr>volumeMounts:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>cni</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>/etc/cni/net.d</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>flannel-cfg</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>/etc/kube-flannel/</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>kube-flannel</span></span><br><span class=line>        <span class=attr>image:</span> <span class=string>quay.io/coreos/flannel:v0.14.0</span></span><br><span class=line>        <span class=attr>command:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>/opt/bin/flanneld</span></span><br><span class=line>        <span class=attr>args:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--ip-masq</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--kube-subnet-mgr</span></span><br><span class=line>        <span class=attr>resources:</span></span><br><span class=line>          <span class=attr>requests:</span></span><br><span class=line>            <span class=attr>cpu:</span> <span class=string>"100m"</span></span><br><span class=line>            <span class=attr>memory:</span> <span class=string>"50Mi"</span></span><br><span class=line>          <span class=attr>limits:</span></span><br><span class=line>            <span class=attr>cpu:</span> <span class=string>"100m"</span></span><br><span class=line>            <span class=attr>memory:</span> <span class=string>"50Mi"</span></span><br><span class=line>        <span class=attr>securityContext:</span></span><br><span class=line>          <span class=attr>privileged:</span> <span class=literal>false</span></span><br><span class=line>          <span class=attr>capabilities:</span></span><br><span class=line>            <span class=attr>add:</span> [<span class=string>"NET_ADMIN"</span>, <span class=string>"NET_RAW"</span>]</span><br><span class=line>        <span class=attr>env:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>POD_NAME</span></span><br><span class=line>          <span class=attr>valueFrom:</span></span><br><span class=line>            <span class=attr>fieldRef:</span></span><br><span class=line>              <span class=attr>fieldPath:</span> <span class=string>metadata.name</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>POD_NAMESPACE</span></span><br><span class=line>          <span class=attr>valueFrom:</span></span><br><span class=line>            <span class=attr>fieldRef:</span></span><br><span class=line>              <span class=attr>fieldPath:</span> <span class=string>metadata.namespace</span></span><br><span class=line>        <span class=attr>volumeMounts:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>run</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>/run/flannel</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>flannel-cfg</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>/etc/kube-flannel/</span></span><br><span class=line>      <span class=attr>volumes:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>run</span></span><br><span class=line>        <span class=attr>hostPath:</span></span><br><span class=line>          <span class=attr>path:</span> <span class=string>/run/flannel</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>cni</span></span><br><span class=line>        <span class=attr>hostPath:</span></span><br><span class=line>          <span class=attr>path:</span> <span class=string>/etc/cni/net.d</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>flannel-cfg</span></span><br><span class=line>        <span class=attr>configMap:</span></span><br><span class=line>          <span class=attr>name:</span> <span class=string>kube-flannel-cfg</span></span><br></pre></table></figure><p><code>Network.Network: 10.244.0.0/16</code>需要改成<code>kubeadm</code>初始化参数所带网络参数。<p><code>Network.Backend.Type: vxlan</code>为默认网络参数，已经改为<code>host-gw</code>，<a href=https://jimmysong.io/kubernetes-handbook/practice/network-and-cluster-perfermance-test.html rel=noopener target=_blank>测试文档</a>中发现host-gw模式性能更高。<p>创建网络：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl apply -f kube-flannel.yaml</span><br></pre></table></figure><p>等待片刻可以看到虚拟网桥<code>cni0</code>已经创建好。若coredns一直处于<code>pending</code>状态，请将<code>flannel</code>文件改为最新版本（0.19.2）<p>查看系统空间<code>kube-system</code>中<code>flannel</code>网络pod资源已经正常运行<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>kubectl -n kube-system get all</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>NAME                             READY   STATUS    RESTARTS   AGE</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/coredns-6f6b8cc4f6-95bng     1/1     Running   0          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/coredns-6f6b8cc4f6-hkdn8     1/1     Running   0          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/etcd-n1                      1/1     Running   1          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/kube-apiserver-n1            1/1     Running   1          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/kube-controller-manager-n1   1/1     Running   1          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/kube-flannel-ds-vz49s        1/1     Running   0          74s</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/kube-proxy-bbjzq             1/1     Running   1          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>pod/kube-scheduler-n1            1/1     Running   1          24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash></span></span><br><span class=line><span class=language-bash><span class=comment># NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>service/kube-dns   ClusterIP   10.96.0.10   &lt;none>        53/UDP,53/TCP,9153/TCP   24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash></span></span><br><span class=line><span class=language-bash><span class=comment># NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>daemonset.apps/kube-flannel-ds   1         1         1       1            1           &lt;none>                   74s</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>daemonset.apps/kube-proxy        1         1         1       1            1           kubernetes.io/os=linux   24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash></span></span><br><span class=line><span class=language-bash><span class=comment># NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>deployment.apps/coredns   2/2     2            2           24m</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash></span></span><br><span class=line><span class=language-bash><span class=comment># NAME                                 DESIRED   CURRENT   READY   AGE</span></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>replicaset.apps/coredns-6f6b8cc4f6   2         2         2       24m</span></span><br></pre></table></figure><h3 id=cni>cni</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>mkdir -p /etc/cni/net.d</span><br><span class=line>cat >/etc/cni/net.d/10-mynet.conf &lt;&lt;-EOF</span><br><span class=line>{</span><br><span class=line>    "cniVersion": "0.3.0",</span><br><span class=line>    "name": "mynet",</span><br><span class=line>    "type": "bridge",</span><br><span class=line>    "bridge": "cni0",</span><br><span class=line>    "isGateway": true,</span><br><span class=line>    "ipMasq": true,</span><br><span class=line>    "ipam": {</span><br><span class=line>        "type": "host-local",</span><br><span class=line>        "subnet": "10.244.0.0/16",</span><br><span class=line>        "routes": [</span><br><span class=line>            {"dst": "0.0.0.0/0"}</span><br><span class=line>        ]</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line>EOF</span><br><span class=line>cat >/etc/cni/net.d/99-loopback.conf &lt;&lt;-EOF</span><br><span class=line>{</span><br><span class=line>    "cniVersion": "0.3.0",</span><br><span class=line>    "type": "loopback"</span><br><span class=line>}</span><br><span class=line>EOF</span><br></pre></table></figure><p>等待片刻可以看到虚拟网桥<code>cni0</code>已经创建好。<h2 id=查看是否安装成功>查看是否安装成功</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>查看系统pod是否正常启动</span></span><br><span class=line>kubectl get pods -n kube-system</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>看到类似结果</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>NAME                           READY   STATUS    RESTARTS   AGE</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>coredns-6f6b8cc4f6-285bg       1/1     Running   0          7m38s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>coredns-6f6b8cc4f6-znlf7       1/1     Running   0          7m38s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>etcd-n175                      1/1     Running   0          7m46s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>kube-apiserver-n175            1/1     Running   0          7m46s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>kube-controller-manager-n175   1/1     Running   0          7m46s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>kube-flannel-ds-8p8xx          1/1     Running   0          95s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>kube-proxy-5zvr2               1/1     Running   0          7m38s</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>kube-scheduler-n175            1/1     Running   0          7m46s</span></span><br></pre></table></figure><h2 id=域名解析测试方法>域名解析测试方法</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动容器，-n xxx可以指定创建的命名空间</span></span><br><span class=line>kubectl run -it --rm --image=busybox:1.28.4 --restart=Never sh</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>解析域名地址，格式：&lt;Service>.&lt;Namespace>.svc.cluster.local</span></span><br><span class=line>nslookup kube-dns.kube-system</span><br><span class=line>nslookup kube-dns.kube-system.svc.cluster.ice</span><br><span class=line>nslookup ver-svc</span><br><span class=line>nslookup ver-svc.ver-dev</span><br><span class=line>nslookup ver-svc.ver-dev.svc</span><br><span class=line>nslookup ver-svc.ver-dev.svc.cluster</span><br><span class=line>nslookup ver-svc.ver-dev.svc.cluster.ice</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>正常能查看到类似结果</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>Server:    10.96.0.10</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>Address 1: 10.96.0.10 kube-dns.kube-system.svc.ice</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash></span></span><br><span class=line><span class=language-bash><span class=comment>#Name:      kube-dns.kube-system</span></span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>Address 1: 10.96.0.10 kube-dns.kube-system.svc.ice</span></span><br></pre></table></figure><p>域名解析时都会优先尝试直接域名解析，若无法连通则会逐步扩大解析范围。使用简短域名解析通过<code>tcpdump -i cni0 -w result.cap</code>抓包dns流程分析，简短域名解析耗时10+ms，而完整域名解析1+ms，因此推荐使用完整域名解析。<h2 id=工作node节点加入集群>工作Node节点加入集群</h2><p>操作步骤到安装辅助工具后，只需要加载pause、proxy、网络插件（若有）镜像。再运行主节点部署时的回显命令即可加入集群。<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>加载节点镜像</span></span><br><span class=line>docker image load -i k8s-images-1.21.8/registry.cn-hangzhou.aliyuncs.com_google_containers_pause_3.4.1.image</span><br><span class=line>docker image load -i k8s-images-1.21.8/registry.cn-hangzhou.aliyuncs.com_google_containers_kube-proxy_v1.21.8.image</span><br></pre></table></figure><h2 id=ingress类控制器安装>Ingress类控制器安装</h2><h3 id=ingress-nginx>ingress-nginx</h3><p>官方<a href=https://github.com/kubernetes/ingress-nginx rel=noopener target=_blank>GitHub</a>仓，注意官方使用的镜像k8s.gcr.io可能无法下载，需要替换一下<h4 id=nginx分支>nginx分支</h4><p>参考<a href=https://blog.csdn.net/weixin_44729138/article/details/105978555 rel=noopener target=_blank>文章</a><p>以<a href=https://github.com/kubernetes/ingress-nginx/tree/nginx-0.29.0 rel=noopener target=_blank>nginx-0.29.0</a>分支为例，进入到资源描述路径<code>deploy/static</code><ul><li><code>configmap.yaml</code> 提供configmap可以在线更新nginx的配置<li><code>namespace.yaml</code> 创建一个独立的命名空间 ingress-nginx<li><code>rbac.yaml</code> 创建对应的role rolebinding 用于rbac<li><code>with-rbac.yaml</code> 有应用rbac的nginx-ingress-controller组件<li><code>mandatory.yaml</code> 以上所有文件的集合</ul><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br><span class=line>180</span><br><span class=line>181</span><br><span class=line>182</span><br><span class=line>183</span><br><span class=line>184</span><br><span class=line>185</span><br><span class=line>186</span><br><span class=line>187</span><br><span class=line>188</span><br><span class=line>189</span><br><span class=line>190</span><br><span class=line>191</span><br><span class=line>192</span><br><span class=line>193</span><br><span class=line>194</span><br><span class=line>195</span><br><span class=line>196</span><br><span class=line>197</span><br><span class=line>198</span><br><span class=line>199</span><br><span class=line>200</span><br><span class=line>201</span><br><span class=line>202</span><br><span class=line>203</span><br><span class=line>204</span><br><span class=line>205</span><br><span class=line>206</span><br><span class=line>207</span><br><span class=line>208</span><br><span class=line>209</span><br><span class=line>210</span><br><span class=line>211</span><br><span class=line>212</span><br><span class=line>213</span><br><span class=line>214</span><br><span class=line>215</span><br><span class=line>216</span><br><span class=line>217</span><br><span class=line>218</span><br><span class=line>219</span><br><span class=line>220</span><br><span class=line>221</span><br><span class=line>222</span><br><span class=line>223</span><br><span class=line>224</span><br><span class=line>225</span><br><span class=line>226</span><br><span class=line>227</span><br><span class=line>228</span><br><span class=line>229</span><br><span class=line>230</span><br><span class=line>231</span><br><span class=line>232</span><br><span class=line>233</span><br><span class=line>234</span><br><span class=line>235</span><br><span class=line>236</span><br><span class=line>237</span><br><span class=line>238</span><br><span class=line>239</span><br><span class=line>240</span><br><span class=line>241</span><br><span class=line>242</span><br><span class=line>243</span><br><span class=line>244</span><br><span class=line>245</span><br><span class=line>246</span><br><span class=line>247</span><br><span class=line>248</span><br><span class=line>249</span><br><span class=line>250</span><br><span class=line>251</span><br><span class=line>252</span><br><span class=line>253</span><br><span class=line>254</span><br><span class=line>255</span><br><span class=line>256</span><br><span class=line>257</span><br><span class=line>258</span><br><span class=line>259</span><br><span class=line>260</span><br><span class=line>261</span><br><span class=line>262</span><br><span class=line>263</span><br><span class=line>264</span><br><span class=line>265</span><br><span class=line>266</span><br><span class=line>267</span><br><span class=line>268</span><br><span class=line>269</span><br><span class=line>270</span><br><span class=line>271</span><br><span class=line>272</span><br><span class=line>273</span><br><span class=line>274</span><br><span class=line>275</span><br><span class=line>276</span><br><span class=line>277</span><br><span class=line>278</span><br><span class=line>279</span><br><span class=line>280</span><br><span class=line>281</span><br><span class=line>282</span><br><span class=line>283</span><br><span class=line>284</span><br><span class=line>285</span><br><span class=line>286</span><br><span class=line>287</span><br><span class=line>288</span><br><span class=line>289</span><br><span class=line>290</span><br><span class=line>291</span><br><span class=line>292</span><br><span class=line>293</span><br><span class=line>294</span><br><span class=line>295</span><br><span class=line>296</span><br><span class=line>297</span><br><span class=line>298</span><br><span class=line>299</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Namespace</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=meta></span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ConfigMap</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-configuration</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ConfigMap</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>tcp-services</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ConfigMap</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>udp-services</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-serviceaccount</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-clusterrole</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>rules:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>configmaps</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>endpoints</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>nodes</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>pods</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>secrets</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>list</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>watch</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>nodes</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>services</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>list</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>watch</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>events</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>create</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>patch</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"extensions"</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"networking.k8s.io"</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>ingresses</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>list</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>watch</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"extensions"</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"networking.k8s.io"</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>ingresses/status</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>update</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Role</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-role</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>rules:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>configmaps</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>pods</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>secrets</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>namespaces</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>configmaps</span></span><br><span class=line>    <span class=attr>resourceNames:</span></span><br><span class=line>      <span class=comment># Defaults to "&lt;election-id>-&lt;ingress-class>"</span></span><br><span class=line>      <span class=comment># Here: "&lt;ingress-controller-leader>-&lt;nginx>"</span></span><br><span class=line>      <span class=comment># This has to be adapted if you change either parameter</span></span><br><span class=line>      <span class=comment># when launching the nginx-ingress-controller.</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"ingress-controller-leader-nginx"</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>update</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>configmaps</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>create</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>""</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>endpoints</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>RoleBinding</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-role-nisa-binding</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>roleRef:</span></span><br><span class=line>  <span class=attr>apiGroup:</span> <span class=string>rbac.authorization.k8s.io</span></span><br><span class=line>  <span class=attr>kind:</span> <span class=string>Role</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-role</span></span><br><span class=line><span class=attr>subjects:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>nginx-ingress-serviceaccount</span></span><br><span class=line>    <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRoleBinding</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-clusterrole-nisa-binding</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>roleRef:</span></span><br><span class=line>  <span class=attr>apiGroup:</span> <span class=string>rbac.authorization.k8s.io</span></span><br><span class=line>  <span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-clusterrole</span></span><br><span class=line><span class=attr>subjects:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>nginx-ingress-serviceaccount</span></span><br><span class=line>    <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=meta></span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Deployment</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress-controller</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>replicas:</span> <span class=number>1</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>      <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>        <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line>      <span class=attr>annotations:</span></span><br><span class=line>        <span class=attr>prometheus.io/port:</span> <span class=string>"10254"</span></span><br><span class=line>        <span class=attr>prometheus.io/scrape:</span> <span class=string>"true"</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>hostNetwork:</span> <span class=literal>true</span> <span class=comment># 设置物理网络</span></span><br><span class=line>      <span class=comment># wait up to five minutes for the drain of connections</span></span><br><span class=line>      <span class=attr>terminationGracePeriodSeconds:</span> <span class=number>300</span></span><br><span class=line>      <span class=attr>serviceAccountName:</span> <span class=string>nginx-ingress-serviceaccount</span></span><br><span class=line>      <span class=attr>nodeSelector:</span></span><br><span class=line>        <span class=attr>kubernetes.io/os:</span> <span class=string>linux</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>nginx-ingress-controller</span></span><br><span class=line>          <span class=attr>image:</span> <span class=string>quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.29.0</span></span><br><span class=line>          <span class=attr>args:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>/nginx-ingress-controller</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--configmap=$(POD_NAMESPACE)/nginx-configuration</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--publish-service=$(POD_NAMESPACE)/ingress-nginx</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--annotations-prefix=nginx.ingress.kubernetes.io</span></span><br><span class=line>            <span class=comment># 增加额外参数指定暴露端口</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--http-port=31080</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>--https-port=31443</span></span><br><span class=line>          <span class=attr>securityContext:</span></span><br><span class=line>            <span class=attr>allowPrivilegeEscalation:</span> <span class=literal>true</span></span><br><span class=line>            <span class=attr>capabilities:</span></span><br><span class=line>              <span class=attr>drop:</span></span><br><span class=line>                <span class=bullet>-</span> <span class=string>ALL</span></span><br><span class=line>              <span class=attr>add:</span></span><br><span class=line>                <span class=bullet>-</span> <span class=string>NET_BIND_SERVICE</span></span><br><span class=line>            <span class=comment># www-data -> 101</span></span><br><span class=line>            <span class=attr>runAsUser:</span> <span class=number>101</span></span><br><span class=line>          <span class=attr>env:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>POD_NAME</span></span><br><span class=line>              <span class=attr>valueFrom:</span></span><br><span class=line>                <span class=attr>fieldRef:</span></span><br><span class=line>                  <span class=attr>fieldPath:</span> <span class=string>metadata.name</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>POD_NAMESPACE</span></span><br><span class=line>              <span class=attr>valueFrom:</span></span><br><span class=line>                <span class=attr>fieldRef:</span></span><br><span class=line>                  <span class=attr>fieldPath:</span> <span class=string>metadata.namespace</span></span><br><span class=line>          <span class=attr>ports:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>http</span></span><br><span class=line>              <span class=attr>containerPort:</span> <span class=number>31080</span></span><br><span class=line>              <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>              <span class=attr>hostPort:</span> <span class=number>31080</span> <span class=comment># 指定物理映射端口，可添加也可不添加</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>https</span></span><br><span class=line>              <span class=attr>containerPort:</span> <span class=number>31443</span></span><br><span class=line>              <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>              <span class=attr>hostPort:</span> <span class=number>31443</span> <span class=comment># 指定物理映射端口，可添加也可不添加</span></span><br><span class=line>          <span class=attr>livenessProbe:</span></span><br><span class=line>            <span class=attr>failureThreshold:</span> <span class=number>3</span></span><br><span class=line>            <span class=attr>httpGet:</span></span><br><span class=line>              <span class=attr>path:</span> <span class=string>/healthz</span></span><br><span class=line>              <span class=attr>port:</span> <span class=number>10254</span></span><br><span class=line>              <span class=attr>scheme:</span> <span class=string>HTTP</span></span><br><span class=line>            <span class=attr>initialDelaySeconds:</span> <span class=number>10</span></span><br><span class=line>            <span class=attr>periodSeconds:</span> <span class=number>10</span></span><br><span class=line>            <span class=attr>successThreshold:</span> <span class=number>1</span></span><br><span class=line>            <span class=attr>timeoutSeconds:</span> <span class=number>10</span></span><br><span class=line>          <span class=attr>readinessProbe:</span></span><br><span class=line>            <span class=attr>failureThreshold:</span> <span class=number>3</span></span><br><span class=line>            <span class=attr>httpGet:</span></span><br><span class=line>              <span class=attr>path:</span> <span class=string>/healthz</span></span><br><span class=line>              <span class=attr>port:</span> <span class=number>10254</span></span><br><span class=line>              <span class=attr>scheme:</span> <span class=string>HTTP</span></span><br><span class=line>            <span class=attr>periodSeconds:</span> <span class=number>10</span></span><br><span class=line>            <span class=attr>successThreshold:</span> <span class=number>1</span></span><br><span class=line>            <span class=attr>timeoutSeconds:</span> <span class=number>10</span></span><br><span class=line>          <span class=attr>lifecycle:</span></span><br><span class=line>            <span class=attr>preStop:</span></span><br><span class=line>              <span class=attr>exec:</span></span><br><span class=line>                <span class=attr>command:</span></span><br><span class=line>                  <span class=bullet>-</span> <span class=string>/wait-shutdown</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=meta></span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>LimitRange</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>    <span class=attr>app.kubernetes.io/part-of:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>limits:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>min:</span></span><br><span class=line>      <span class=attr>memory:</span> <span class=string>90Mi</span></span><br><span class=line>      <span class=attr>cpu:</span> <span class=string>100m</span></span><br><span class=line>    <span class=attr>type:</span> <span class=string>Container</span></span><br></pre></table></figure><p>svc服务文件<code>deploy/baremetal/service-nodeport.yaml</code>，将ingress内部80端口暴露到节点<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>ingress-nginx</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>type:</span> <span class=string>ClusterIP</span></span><br><span class=line>  <span class=comment>#type: NodePort</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>http</span></span><br><span class=line>      <span class=attr>port:</span> <span class=number>31080</span></span><br><span class=line>      <span class=comment>#nodePort: 31080</span></span><br><span class=line>      <span class=attr>targetPort:</span> <span class=number>31080</span> </span><br><span class=line>      <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>https</span></span><br><span class=line>      <span class=attr>port:</span> <span class=number>31443</span></span><br><span class=line>      <span class=attr>targetPort:</span> <span class=number>31443</span></span><br><span class=line>      <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>ingress-nginx</span></span><br><span class=line>  <span class=comment>#externalTrafficPolicy: Cluster</span></span><br></pre></table></figure><p>默认nginx-ingress-controller会随意选择一个node节点运行pod，为此需要我们把nginx-ingress-controller运行到指定的node节点上。首先需要给需要运行nginx-ingress-controller的node节点打标签，在此我们把nginx-ingress-controller运行在指定的node节点上<p><strong>此步骤非必须</strong><p>为节点打标签<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>为指定节点打标签，标签可以换成其他的</span></span><br><span class=line>kubectl label node localhost.localdomain nodeFeature=nginx</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>查看节点已有标签</span></span><br><span class=line>kubectl get nodes --show-labels</span><br></pre></table></figure><p>在<code>mandatory.yaml</code>文件中<code>nodeSelector</code>属性中增加<code>nodeFeature: nginx</code><p><strong>验证程序</strong><p><code>ingress-nginx</code>测试程序<code>httpd-dep.yaml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br></pre><td class=code><pre><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>networking.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Ingress</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>httpd</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>httpd</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>rules:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>http:</span></span><br><span class=line>      <span class=attr>paths:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>pathType:</span> <span class=string>Prefix</span></span><br><span class=line>        <span class=attr>path:</span> <span class=string>"/"</span></span><br><span class=line>        <span class=attr>backend:</span></span><br><span class=line>          <span class=attr>service:</span></span><br><span class=line>            <span class=attr>name:</span> <span class=string>httpd</span></span><br><span class=line>            <span class=attr>port:</span> </span><br><span class=line>              <span class=attr>number:</span> <span class=number>8000</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>httpd</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>httpd</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>port:</span> <span class=number>8000</span></span><br><span class=line>    <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>    <span class=attr>targetPort:</span> <span class=number>80</span></span><br><span class=line>  <span class=attr>type:</span> <span class=string>ClusterIP</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Deployment</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>httpd</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>replicas:</span> <span class=number>4</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app:</span> <span class=string>httpd</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>app:</span> <span class=string>httpd</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>httpd</span></span><br><span class=line>        <span class=attr>image:</span> <span class=string>httpd:2.4.52</span></span><br><span class=line>        <span class=attr>resources:</span></span><br><span class=line>          <span class=attr>limits:</span></span><br><span class=line>            <span class=attr>memory:</span> <span class=string>"128Mi"</span></span><br><span class=line>            <span class=attr>cpu:</span> <span class=string>"500m"</span></span><br><span class=line>        <span class=attr>ports:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>containerPort:</span> <span class=number>80</span></span><br><span class=line></span><br></pre></table></figure><p>若未指定ingress会随机选择节点启动pod，查看命令<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>kubectl -n ingress-nginx get pod -o wide</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>NAME                                       READY   STATUS    RESTARTS   AGE    IP               NODE   NOMINATED NODE   READINESS GATES</span></span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>nginx-ingress-controller-fd46d8644-s772j   1/1     Running   0          103m   192.168.31.192   n2     &lt;none>           &lt;none></span></span><br></pre></table></figure><h2 id=k8s上部署redis集群>K8s上部署Redis集群</h2><p>【重点】不适合部署带持久化的Redis集群，因Redis集群以IP建立的。<p>重启后无法恢复原有集群。<p>本方案采用StatefulSet进行redis的部署。参考<a href=https://blog.csdn.net/web18484626332/article/details/123969158 rel=noopener target=_blank>文章</a><h3 id=环境信息>环境信息</h3><table><thead><tr class=header><th>序列<th>节点<th>IP<tbody><tr class=odd><td>1<td>master<td>192.168.1.100<tr class=even><td>2<td>node1<td>192.168.1.101<tr class=odd><td>3<td>node2<td>192.168.1.102<tr class=even><td>4<td>node3<td>192.168.1.103</table><h3 id=创建存储卷>创建存储卷</h3><ol type=1><li>安装nfs软件包</ol><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">#</span><span class=language-bash>任选一台节点(这里选k8s-master)</span></span><br><span class=line>yum –y install nfs-utils rpcbind</span><br></pre></table></figure><ol start=2 type=1><li>创建共享存储</ol><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>创建共享目录</span></span><br><span class=line>mkdir -p /home/data/redis/pv{1,2,3,4,5,6}</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>配置共享路径</span></span><br><span class=line>vi /etc/exports</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>增加如下配置</span></span><br><span class=line>/home/data/redis/pv1 192.168.11.0/24(rw,sync,no_root_squash)</span><br><span class=line>/home/data/redis/pv2 192.168.11.0/24(rw,sync,no_root_squash)</span><br><span class=line>/home/data/redis/pv3 192.168.11.0/24(rw,sync,no_root_squash)</span><br><span class=line>/home/data/redis/pv4 192.168.11.0/24(rw,sync,no_root_squash)</span><br><span class=line>/home/data/redis/pv5 192.168.11.0/24(rw,sync,no_root_squash)</span><br><span class=line>/home/data/redis/pv6 192.168.11.0/24(rw,sync,no_root_squash)</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>重启</span></span><br><span class=line>systemctl restart rpcbind</span><br><span class=line>systemctl restart nfs</span><br><span class=line>systemctl enable nfs</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>其他节点验证nfs</span></span><br><span class=line>yum -y install nfs-utils</span><br><span class=line>showmount -e 172.20.1.25</span><br></pre></table></figure><h3 id=创建pv>创建PV</h3><p>pv.yaml:<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br></pre><td class=code><pre><span class=line>---</span><br><span class=line>apiVersion: v1</span><br><span class=line>kind: PersistentVolume</span><br><span class=line>metadata:</span><br><span class=line>  name: nfs-pv1</span><br><span class=line>spec:</span><br><span class=line>  capacity:</span><br><span class=line>    storage: 2Gi</span><br><span class=line>  accessModes:</span><br><span class=line>- ReadWriteMany</span><br><span class=line>  volumeMode: Filesystem</span><br><span class=line>  persistentVolumeReclaimPolicy: Recycle</span><br><span class=line>  storageClassName: "redis"</span><br><span class=line>  nfs:</span><br><span class=line>    server: 192.168.1.10</span><br><span class=line>    path: "/usr/local/k8s/redis/pv1"</span><br><span class=line>---</span><br><span class=line>apiVersion: v1</span><br><span class=line>kind: PersistentVolume</span><br><span class=line>metadata:</span><br><span class=line>  name: nfs-vp2</span><br><span class=line>spec:</span><br><span class=line>  capacity:</span><br><span class=line>    storage: 2Gi</span><br><span class=line>  accessModes:</span><br><span class=line>- ReadWriteMany</span><br><span class=line>  volumeMode: Filesystem</span><br><span class=line>  persistentVolumeReclaimPolicy: Recycle</span><br><span class=line>  storageClassName: "redis"</span><br><span class=line>  nfs:</span><br><span class=line>    server: 192.168.1.10</span><br><span class=line>    path: "/usr/local/k8s/redis/pv2"</span><br><span class=line>---</span><br><span class=line>apiVersion: v1</span><br><span class=line>kind: PersistentVolume</span><br><span class=line>metadata:</span><br><span class=line>  name: nfs-pv3</span><br><span class=line>spec:</span><br><span class=line>  capacity:</span><br><span class=line>    storage: 2Gi</span><br><span class=line>  accessModes:</span><br><span class=line>- ReadWriteMany</span><br><span class=line>  volumeMode: Filesystem</span><br><span class=line>  persistentVolumeReclaimPolicy: Recycle</span><br><span class=line>  storageClassName: "redis"</span><br><span class=line>  nfs:</span><br><span class=line>    server: 192.168.1.10</span><br><span class=line>    path: "/usr/local/k8s/redis/pv3"</span><br><span class=line>---</span><br><span class=line>apiVersion: v1</span><br><span class=line>kind: PersistentVolume</span><br><span class=line>metadata:</span><br><span class=line>  name: nfs-vp4</span><br><span class=line>spec:</span><br><span class=line>  capacity:</span><br><span class=line>    storage: 2Gi</span><br><span class=line>  accessModes:</span><br><span class=line>- ReadWriteMany</span><br><span class=line>  volumeMode: Filesystem</span><br><span class=line>  persistentVolumeReclaimPolicy: Recycle</span><br><span class=line>  storageClassName: "redis"</span><br><span class=line>  nfs:</span><br><span class=line>    server: 192.168.1.10</span><br><span class=line>    path: "/usr/local/k8s/redis/pv4"</span><br><span class=line>---</span><br><span class=line>apiVersion: v1</span><br><span class=line>kind: PersistentVolume</span><br><span class=line>metadata:</span><br><span class=line>  name: nfs-pv5</span><br><span class=line>spec:</span><br><span class=line>  capacity:</span><br><span class=line>    storage: 2Gi</span><br><span class=line>  accessModes:</span><br><span class=line>- ReadWriteMany</span><br><span class=line>  volumeMode: Filesystem</span><br><span class=line>  persistentVolumeReclaimPolicy: Recycle</span><br><span class=line>  storageClassName: "redis"</span><br><span class=line>  nfs:</span><br><span class=line>    server: 192.168.1.10</span><br><span class=line>    path: "/usr/local/k8s/redis/pv5"</span><br><span class=line>---</span><br><span class=line>apiVersion: v1</span><br><span class=line>kind: PersistentVolume</span><br><span class=line>metadata:</span><br><span class=line>  name: nfs-vp6</span><br><span class=line>spec:</span><br><span class=line>  capacity:</span><br><span class=line>    storage: 2Gi</span><br><span class=line>  accessModes:</span><br><span class=line>- ReadWriteMany</span><br><span class=line>  volumeMode: Filesystem</span><br><span class=line>  persistentVolumeReclaimPolicy: Recycle</span><br><span class=line>  storageClassName: "redis"</span><br><span class=line>  nfs:</span><br><span class=line>    server: 192.168.1.10</span><br><span class=line>    path: "/usr/local/k8s/redis/pv6"</span><br></pre></table></figure><h3 id=创建configmap>创建configmap</h3><p>vim redis.conf<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=comment># appendonly yes</span></span><br><span class=line><span class=comment># cluster-enabled yes</span></span><br><span class=line><span class=comment># cluster-config-file /var/lib/redis/nodes.conf</span></span><br><span class=line><span class=comment># cluster-node-timeout 5000</span></span><br><span class=line><span class=comment># dir /var/lib/redis</span></span><br><span class=line><span class=comment># port 6379</span></span><br><span class=line><span class=comment># redis端口</span></span><br><span class=line>port 6379</span><br><span class=line><span class=comment># # 连接密码</span></span><br><span class=line><span class=comment># requirepass hzzhcs@2020</span></span><br><span class=line><span class=comment># masterauth hzzhcs@2020</span></span><br><span class=line><span class=comment># 关闭保护模式</span></span><br><span class=line>protected-mode no</span><br><span class=line><span class=comment># 开启集群</span></span><br><span class=line>cluster-enabled <span class=built_in>yes</span></span><br><span class=line><span class=comment># 集群节点配置</span></span><br><span class=line>cluster-config-file nodes-<span class=variable>${PORT}</span>.conf</span><br><span class=line><span class=comment># 超时</span></span><br><span class=line>cluster-node-timeout 5000</span><br><span class=line><span class=comment># # 集群节点IP host模式为宿主机IP</span></span><br><span class=line><span class=comment># # cluster-announce-ip 192.168.195.10</span></span><br><span class=line><span class=comment># # cluster-announce-ip 192.168.28.170</span></span><br><span class=line><span class=comment># cluster-announce-ip 192.168.11.215</span></span><br><span class=line><span class=comment># # 节点端口 6379 - 6381</span></span><br><span class=line><span class=comment># # 集群端口 16379 - 16381</span></span><br><span class=line><span class=comment># cluster-announce-port ${PORT}</span></span><br><span class=line><span class=comment># cluster-announce-bus-port ${CPORT}</span></span><br><span class=line><span class=comment># 开启 appendonly 备份模式</span></span><br><span class=line>appendonly <span class=built_in>yes</span></span><br><span class=line><span class=comment># 每秒钟备份</span></span><br><span class=line>appendfsync everysec</span><br><span class=line><span class=comment># 对aof文件进行压缩时，是否执行同步操作</span></span><br><span class=line>no-appendfsync-on-rewrite no</span><br><span class=line><span class=comment># 当目前aof文件大小超过上一次重写时的aof文件大小的100%时会再次进行重写</span></span><br><span class=line>auto-aof-rewrite-percentage 100</span><br><span class=line><span class=comment># 重写前AOF文件的大小最小值 默认 64mb</span></span><br><span class=line>auto-aof-rewrite-min-size 64mb</span><br><span class=line></span><br></pre></table></figure><p>创建<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl create configmap redis-conf --from-file=redis.conf</span><br></pre></table></figure><h3 id=创建headless-service>创建headless service</h3><p>vim headless-service.yaml<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>redis-service</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>redis</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>redis-port</span></span><br><span class=line>    <span class=attr>port:</span> <span class=number>6379</span></span><br><span class=line>  <span class=attr>clusterIP:</span> <span class=string>None</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line><span class=attr>app:</span> <span class=string>redis</span></span><br></pre></table></figure><h3 id=创建redis集群节点>创建redis集群节点</h3><p>通过StatefulSet创建6个redis的pod ，实现3主3从的redis集群。vim redis.yaml<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br></pre><td class=code><pre><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>StatefulSet</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>redis-app</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>serviceName:</span> <span class=string>"redis-service"</span></span><br><span class=line>  <span class=attr>replicas:</span> <span class=number>6</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app:</span> <span class=string>redis</span></span><br><span class=line>      <span class=attr>appCluster:</span> <span class=string>redis-cluster</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>app:</span> <span class=string>redis</span></span><br><span class=line>        <span class=attr>appCluster:</span> <span class=string>redis-cluster</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>redis</span></span><br><span class=line>        <span class=attr>image:</span> <span class=string>"redis:3.2.8"</span></span><br><span class=line>        <span class=attr>command:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>"redis-server"</span></span><br><span class=line>        <span class=attr>args:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>"/etc/redis/redis.conf"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>"-protected-mode"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>"no"</span></span><br><span class=line>        <span class=attr>resources:</span></span><br><span class=line>          <span class=attr>requests:</span></span><br><span class=line>            <span class=attr>cpu:</span> <span class=string>"100m"</span></span><br><span class=line>            <span class=attr>memory:</span> <span class=string>"100Mi"</span></span><br><span class=line>        <span class=attr>ports:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>redis</span></span><br><span class=line>          <span class=attr>containerPort:</span> <span class=number>6379</span></span><br><span class=line>          <span class=attr>protocol:</span> <span class=string>"TCP"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>cluster</span></span><br><span class=line>          <span class=attr>containerPort:</span> <span class=number>16379</span></span><br><span class=line>          <span class=attr>protocol:</span> <span class=string>"TCP"</span></span><br><span class=line>        <span class=attr>volumeMounts:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>"redis-conf"</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>"/etc/redis"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>"redis-data"</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>"/var/lib/redis"</span></span><br><span class=line>      <span class=attr>volumes:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>"redis-conf"</span></span><br><span class=line>        <span class=attr>configMap:</span></span><br><span class=line>          <span class=attr>name:</span> <span class=string>"redis-conf"</span></span><br><span class=line>          <span class=attr>items:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>"redis.conf"</span></span><br><span class=line>            <span class=attr>path:</span> <span class=string>"redis.conf"</span></span><br><span class=line>  <span class=attr>volumeClaimTemplates:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>name:</span> <span class=string>redis-data</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>accessModes:</span> [ <span class=string>"ReadWriteMany"</span> ]</span><br><span class=line>      <span class=attr>storageClassName:</span> <span class=string>"redispv"</span></span><br><span class=line>      <span class=attr>resources:</span></span><br><span class=line>        <span class=attr>requests:</span></span><br><span class=line>          <span class=attr>storage:</span> <span class=string>2Gi</span></span><br></pre></table></figure><h3 id=初始化redis集群>初始化redis集群</h3><p>获取节点信息<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>kubectl get pods -o wide</span><br><span class=line>NAME          READY   STATUS    RESTARTS   AGE     IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class=line>redis-app-0   1/1     Running   0          2m22s   10.244.0.248   n175   &lt;none>           &lt;none></span><br><span class=line>redis-app-1   1/1     Running   0          97s     10.244.0.252   n175   &lt;none>           &lt;none></span><br><span class=line>redis-app-2   1/1     Running   0          101s    10.244.0.251   n175   &lt;none>           &lt;none></span><br><span class=line>redis-app-3   1/1     Running   0          117s    10.244.0.250   n175   &lt;none>           &lt;none></span><br><span class=line>redis-app-4   1/1     Running   0          2m1s    10.244.0.249   n175   &lt;none>           &lt;none></span><br><span class=line>redis-app-5   1/1     Running   0          2m31s   10.244.0.247   n175   &lt;none>           &lt;none></span><br></pre></table></figure><p>进入任意节点执行命令初始化集群<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br></pre><td class=code><pre><span class=line>redis-cli --cluster create \</span><br><span class=line>    10.244.0.248:6379 \</span><br><span class=line>    10.244.0.252:6379 \</span><br><span class=line>    10.244.0.251:6379 \</span><br><span class=line>    10.244.0.250:6379 \</span><br><span class=line>    10.244.0.249:6379 \</span><br><span class=line>    10.244.0.247:6379 \</span><br><span class=line>    --cluster-replicas 1</span><br><span class=line>    </span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>无法正常建立集群</span></span><br><span class=line>redis-cli --cluster create \</span><br><span class=line>    redis-app-0.redis-service.default.svc.ice:6379 \</span><br><span class=line>    redis-app-1.redis-service.default.svc.ice:6379 \</span><br><span class=line>    redis-app-2.redis-service.default.svc.ice:6379 \</span><br><span class=line>    redis-app-3.redis-service.default.svc.ice:6379 \</span><br><span class=line>    redis-app-4.redis-service.default.svc.ice:6379 \</span><br><span class=line>    redis-app-5.redis-service.default.svc.ice:6379 \</span><br><span class=line>    --cluster-replicas 1</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>回显信息</span></span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Performing <span class=built_in>hash</span> slots allocation on 6 nodes...</span></span><br><span class=line>Master[0] -> Slots 0 - 5460</span><br><span class=line>Master[1] -> Slots 5461 - 10922</span><br><span class=line>Master[2] -> Slots 10923 - 16383</span><br><span class=line>Adding replica 10.244.0.249:6379 to 10.244.0.248:6379</span><br><span class=line>Adding replica 10.244.0.247:6379 to 10.244.0.252:6379</span><br><span class=line>Adding replica 10.244.0.250:6379 to 10.244.0.251:6379</span><br><span class=line>M: 8921255530faaa44fb793a7248d93c179211b7d9 10.244.0.248:6379</span><br><span class=line>   slots:[0-5460] (5461 slots) master</span><br><span class=line>M: f32bcfa4dcacef662096d5ccdef4d741588aa2cb 10.244.0.252:6379</span><br><span class=line>   slots:[5461-10922] (5462 slots) master</span><br><span class=line>M: dc0a1908830468f2070883e1c026fd5b1b2ff526 10.244.0.251:6379</span><br><span class=line>   slots:[10923-16383] (5461 slots) master</span><br><span class=line>S: b35dcfba64b30050d3f71dc347acd3ce222a99e5 10.244.0.250:6379</span><br><span class=line>   replicates dc0a1908830468f2070883e1c026fd5b1b2ff526</span><br><span class=line>S: 4ac41eded080c70132ab4de211fcdfa653874469 10.244.0.249:6379</span><br><span class=line>   replicates 8921255530faaa44fb793a7248d93c179211b7d9</span><br><span class=line>S: dc2ddbb2ef518a23583dab53bdecccc0e017146d 10.244.0.247:6379</span><br><span class=line>   replicates f32bcfa4dcacef662096d5ccdef4d741588aa2cb</span><br><span class=line>Can I set the above configuration? (type 'yes' to accept): yes</span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Nodes configuration updated</span></span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Assign a different config epoch to each node</span></span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Sending CLUSTER MEET messages to <span class=built_in>join</span> the cluster</span></span><br><span class=line>Waiting for the cluster to join</span><br><span class=line>..</span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Performing Cluster Check (using node 10.244.0.248:6379)</span></span><br><span class=line>M: 8921255530faaa44fb793a7248d93c179211b7d9 10.244.0.248:6379</span><br><span class=line>   slots:[0-5460] (5461 slots) master</span><br><span class=line>   1 additional replica(s)</span><br><span class=line>S: 4ac41eded080c70132ab4de211fcdfa653874469 10.244.0.249:6379</span><br><span class=line>   slots: (0 slots) slave</span><br><span class=line>   replicates 8921255530faaa44fb793a7248d93c179211b7d9</span><br><span class=line>M: f32bcfa4dcacef662096d5ccdef4d741588aa2cb 10.244.0.252:6379</span><br><span class=line>   slots:[5461-10922] (5462 slots) master</span><br><span class=line>   1 additional replica(s)</span><br><span class=line>S: b35dcfba64b30050d3f71dc347acd3ce222a99e5 10.244.0.250:6379</span><br><span class=line>   slots: (0 slots) slave</span><br><span class=line>   replicates dc0a1908830468f2070883e1c026fd5b1b2ff526</span><br><span class=line>S: dc2ddbb2ef518a23583dab53bdecccc0e017146d 10.244.0.247:6379</span><br><span class=line>   slots: (0 slots) slave</span><br><span class=line>   replicates f32bcfa4dcacef662096d5ccdef4d741588aa2cb</span><br><span class=line>M: dc0a1908830468f2070883e1c026fd5b1b2ff526 10.244.0.251:6379</span><br><span class=line>   slots:[10923-16383] (5461 slots) master</span><br><span class=line>   1 additional replica(s)</span><br><span class=line>[OK] All nodes agree about slots configuration.</span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Check <span class=keyword>for</span> open slots...</span></span><br><span class=line><span class="meta prompt_">></span><span class=language-bash>>> Check slots coverage...</span></span><br><span class=line>[OK] All 16384 slots covered.</span><br></pre></table></figure><p>验证状态<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line>redis-cli -c</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>操作回显信息</span></span><br><span class=line>127.0.0.1:6379> CLUSTER INFO</span><br><span class=line>cluster_state:ok</span><br><span class=line>cluster_slots_assigned:16384</span><br><span class=line>cluster_slots_ok:16384</span><br><span class=line>cluster_slots_pfail:0</span><br><span class=line>cluster_slots_fail:0</span><br><span class=line>cluster_known_nodes:6</span><br><span class=line>cluster_size:3</span><br><span class=line>cluster_current_epoch:6</span><br><span class=line>cluster_my_epoch:1</span><br><span class=line>cluster_stats_messages_ping_sent:315</span><br><span class=line>cluster_stats_messages_pong_sent:335</span><br><span class=line>cluster_stats_messages_sent:650</span><br><span class=line>cluster_stats_messages_ping_received:330</span><br><span class=line>cluster_stats_messages_pong_received:315</span><br><span class=line>cluster_stats_messages_meet_received:5</span><br><span class=line>cluster_stats_messages_received:650</span><br><span class=line>127.0.0.1:6379> CLUSTER NODES</span><br><span class=line>4ac41eded080c70132ab4de211fcdfa653874469 10.244.0.249:6379@16379 slave 8921255530faaa44fb793a7248d93c179211b7d9 0 1658228657078 1 connected</span><br><span class=line>f32bcfa4dcacef662096d5ccdef4d741588aa2cb 10.244.0.252:6379@16379 master - 0 1658228657580 2 connected 5461-10922</span><br><span class=line>b35dcfba64b30050d3f71dc347acd3ce222a99e5 10.244.0.250:6379@16379 slave dc0a1908830468f2070883e1c026fd5b1b2ff526 0 1658228658082 3 connected</span><br><span class=line>dc2ddbb2ef518a23583dab53bdecccc0e017146d 10.244.0.247:6379@16379 slave f32bcfa4dcacef662096d5ccdef4d741588aa2cb 0 1658228657000 2 connected</span><br><span class=line>8921255530faaa44fb793a7248d93c179211b7d9 10.244.0.248:6379@16379 myself,master - 0 1658228657000 1 connected 0-5460</span><br><span class=line>dc0a1908830468f2070883e1c026fd5b1b2ff526 10.244.0.251:6379@16379 master - 0 1658228657078 3 connected 10923-16383</span><br></pre></table></figure><h3 id=创建用于访问的service>创建用于访问的service</h3><p>之前创建了用于实现StatefulSet的Headless Service，但该Service没有Cluster IP，因此不能用于外界访问。所以，我们还需要创建一个Service，专用于为Redis集群提供访问和负载均衡；也可以部署为Ingress供集群外部访问。这里只创建用于内部访问的service<p>redis-access-service.yaml<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>redis-access-service</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>redis</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>redis-port</span></span><br><span class=line>    <span class=attr>protocol:</span> <span class=string>"TCP"</span></span><br><span class=line>    <span class=attr>port:</span> <span class=number>6379</span></span><br><span class=line>    <span class=attr>targetPort:</span> <span class=number>6379</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>redis</span></span><br><span class=line>    <span class=attr>appCluster:</span> <span class=string>redis-cluster</span></span><br></pre></table></figure><h2 id=k8s上部署kafka集群>K8s上部署Kafka集群</h2><h2 id=k8s上部署mysql集群>K8s上部署MySQL集群</h2><h1 id=helm离线安装chart包>Helm离线安装Chart包</h1><p>参考<a href=https://blog.csdn.net/arnolan/article/details/105304711 rel=noopener target=_blank>文章</a><h1 id=cicd引擎非必须>CICD引擎（非必须）</h1><p><a href="https://baijiahao.baidu.com/s?id=1695174825957404944&wfr=spider&for=pc" rel=noopener target=_blank>Jenkins替代工具</a><p>BuildMaster Drone.io GoCD<h2 id=argo>Argo</h2><h1 id=可视化管理工具非必须>可视化管理工具（非必须）</h1><h3 id=kuboard>kuboard</h3><p>在线安装<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">  # </span><span class=language-bash>也可以使用镜像 swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3 ，可以更快地完成镜像下载。</span></span><br><span class=line><span class="meta prompt_">  # </span><span class=language-bash>请不要使用 127.0.0.1 或者 localhost 作为内网 IP \</span></span><br><span class=line><span class=language-bash>  <span class=comment># Kuboard 不需要和 K8S 在同一个网段，Kuboard Agent 甚至可以通过代理访问 Kuboard Server \</span></span></span><br><span class=line><span class=language-bash><span class=built_in>sudo</span> docker run -d \</span></span><br><span class=line><span class=language-bash>  --restart=unless-stopped \</span></span><br><span class=line><span class=language-bash>  --name=kuboard \</span></span><br><span class=line><span class=language-bash>  -p 30080:80/tcp \</span></span><br><span class=line><span class=language-bash>  -p 31089:10081/tcp \</span></span><br><span class=line><span class=language-bash>  -e KUBOARD_ENDPOINT=<span class=string>"http://192.168.11.178:30080"</span> \</span></span><br><span class=line><span class=language-bash>  -e KUBOARD_AGENT_SERVER_TCP_PORT=<span class=string>"31089"</span> \</span></span><br><span class=line><span class=language-bash>  -v /opt/kuboard-data:/data \</span></span><br><span class=line><span class=language-bash>  swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3.4.1.0</span></span><br></pre></table></figure><p><code>docker-compose.yml</code>方式：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br></pre><td class=code><pre><span class=line>version: "3"</span><br><span class=line></span><br><span class=line>networks:</span><br><span class=line>  kuboard-net:</span><br><span class=line>    external: false</span><br><span class=line>    driver: bridge</span><br><span class=line>    # ipam:</span><br><span class=line>    #   config:</span><br><span class=line>    #     - subnet: 172.90.161.0/24</span><br><span class=line></span><br><span class=line>services:</span><br><span class=line>  kuboard:</span><br><span class=line>    image: swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3.4.1.0</span><br><span class=line>    container_name: kuboard</span><br><span class=line>    restart: unless-stopped # always</span><br><span class=line>    environment:</span><br><span class=line>      # user/passwd：admin/Kuboard123</span><br><span class=line>      # modify: Zdxf@2021</span><br><span class=line>      KUBOARD_ENDPOINT: "http://172.20.1.25:30080"</span><br><span class=line>      KUBOARD_AGENT_SERVER_TCP_PORT: "31089"</span><br><span class=line>      KUBERNETES_CLUSTER_DOMAIN: "ice"</span><br><span class=line>      KUBOARD_ICP_DESCRIPTION: "ICP备案号"</span><br><span class=line>      KUBOARD_DISABLE_AUDIT: true</span><br><span class=line>    ports:</span><br><span class=line>      - 30080:80/tcp</span><br><span class=line>      - 31089:10081/tcp</span><br><span class=line>    volumes:</span><br><span class=line>      - /etc/localtime:/etc/localtime:ro</span><br><span class=line>      - ./data:/data</span><br><span class=line>    networks:</span><br><span class=line>      - kuboard-net</span><br><span class=line></span><br><span class=line>    logging:</span><br><span class=line>      #driver: none</span><br><span class=line>      driver: json-file</span><br><span class=line>      options:</span><br><span class=line>        max-size: "200k"</span><br><span class=line>        max-file: "1"</span><br><span class=line></span><br><span class=line>    # 使用deploy限制资源，启动时需要增加--compatibility参数，防止报错</span><br><span class=line>    deploy:</span><br><span class=line>      resources:</span><br><span class=line>        limits:</span><br><span class=line>          cpus: '1'</span><br><span class=line>          memory: 1G</span><br><span class=line>        reservations:</span><br><span class=line>          cpus: '1'</span><br><span class=line>          memory: 200M</span><br></pre></table></figure><p>在浏览器输入 <code>http://your-host-ip:31088</code> 即可访问 Kuboard v3.x 的界面，登录方式：<ul><li>用户名： <code>admin</code><li>密 码： <code>Kuboard123</code></ul><p>浏览器兼容性<p>请使用 Chrome / FireFox / Safari 等浏览器<p>不兼容 IE 以及以 IE 为内核的浏览器<h4 id=资源监控>资源监控</h4><p><code>metrics-server.yaml</code>内容：<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br><span class=line>180</span><br><span class=line>181</span><br><span class=line>182</span><br><span class=line>183</span><br><span class=line>184</span><br><span class=line>185</span><br><span class=line>186</span><br><span class=line>187</span><br><span class=line>188</span><br><span class=line>189</span><br><span class=line>190</span><br><span class=line>191</span><br><span class=line>192</span><br><span class=line>193</span><br><span class=line>194</span><br><span class=line>195</span><br><span class=line>196</span><br><span class=line>197</span><br><span class=line>198</span><br><span class=line>199</span><br><span class=line>200</span><br><span class=line>201</span><br><span class=line>202</span><br><span class=line>203</span><br><span class=line>204</span><br><span class=line>205</span><br><span class=line>206</span><br><span class=line>207</span><br><span class=line>208</span><br><span class=line>209</span><br><span class=line>210</span><br><span class=line>211</span><br><span class=line>212</span><br><span class=line>213</span><br><span class=line>214</span><br><span class=line>215</span><br><span class=line>216</span><br><span class=line>217</span><br><span class=line>218</span><br><span class=line>219</span><br><span class=line>220</span><br><span class=line>221</span><br><span class=line>222</span><br><span class=line>223</span><br><span class=line>224</span><br><span class=line>225</span><br><span class=line>226</span><br><span class=line>227</span><br><span class=line>228</span><br><span class=line>229</span><br><span class=line>230</span><br><span class=line>231</span><br><span class=line>232</span><br><span class=line>233</span><br><span class=line>234</span><br><span class=line>235</span><br><span class=line>236</span><br><span class=line>237</span><br><span class=line>238</span><br><span class=line>239</span><br><span class=line>240</span><br><span class=line>241</span><br><span class=line>242</span><br></pre><td class=code><pre><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>https</span></span><br><span class=line>      <span class=attr>port:</span> <span class=number>443</span></span><br><span class=line>      <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>      <span class=attr>targetPort:</span> <span class=number>443</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>    <span class=attr>rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class=string>'true'</span></span><br><span class=line>    <span class=attr>rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class=string>'true'</span></span><br><span class=line>    <span class=attr>rbac.authorization.k8s.io/aggregate-to-view:</span> <span class=string>'true'</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>'system:aggregated-metrics-reader'</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>rules:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>metrics.k8s.io</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>pods</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>nodes</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>list</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>watch</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>'system:metrics-server'</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>rules:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>apiGroups:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>''</span></span><br><span class=line>    <span class=attr>resources:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>pods</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>nodes</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>nodes/stats</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>namespaces</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>configmaps</span></span><br><span class=line>    <span class=attr>verbs:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>get</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>list</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>watch</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRoleBinding</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>'metrics-server:system:auth-delegator'</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>roleRef:</span></span><br><span class=line>  <span class=attr>apiGroup:</span> <span class=string>rbac.authorization.k8s.io</span></span><br><span class=line>  <span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>'system:auth-delegator'</span></span><br><span class=line><span class=attr>subjects:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>    <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ClusterRoleBinding</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>'system:metrics-server'</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>roleRef:</span></span><br><span class=line>  <span class=attr>apiGroup:</span> <span class=string>rbac.authorization.k8s.io</span></span><br><span class=line>  <span class=attr>kind:</span> <span class=string>ClusterRole</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>'system:metrics-server'</span></span><br><span class=line><span class=attr>subjects:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>    <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>rbac.authorization.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>RoleBinding</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>metrics-server-auth-reader</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>roleRef:</span></span><br><span class=line>  <span class=attr>apiGroup:</span> <span class=string>rbac.authorization.k8s.io</span></span><br><span class=line>  <span class=attr>kind:</span> <span class=string>Role</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>extension-apiserver-authentication-reader</span></span><br><span class=line><span class=attr>subjects:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>    <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ServiceAccount</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>apiregistration.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>APIService</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>v1beta1.metrics.k8s.io</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>group:</span> <span class=string>metrics.k8s.io</span></span><br><span class=line>  <span class=attr>groupPriorityMinimum:</span> <span class=number>100</span></span><br><span class=line>  <span class=attr>insecureSkipTLSVerify:</span> <span class=literal>true</span></span><br><span class=line>  <span class=attr>service:</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>    <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line>  <span class=attr>version:</span> <span class=string>v1beta1</span></span><br><span class=line>  <span class=attr>versionPriority:</span> <span class=number>100</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Deployment</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>replicas:</span> <span class=number>1</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>strategy:</span></span><br><span class=line>    <span class=attr>rollingUpdate:</span></span><br><span class=line>      <span class=attr>maxUnavailable:</span> <span class=number>1</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>affinity:</span></span><br><span class=line>        <span class=attr>nodeAffinity:</span></span><br><span class=line>          <span class=attr>preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>preference:</span></span><br><span class=line>                <span class=attr>matchExpressions:</span></span><br><span class=line>                  <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>node-role.kubernetes.io/master</span></span><br><span class=line>                    <span class=attr>operator:</span> <span class=string>Exists</span></span><br><span class=line>              <span class=attr>weight:</span> <span class=number>100</span></span><br><span class=line>        <span class=attr>podAntiAffinity:</span></span><br><span class=line>          <span class=attr>requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>labelSelector:</span></span><br><span class=line>                <span class=attr>matchLabels:</span></span><br><span class=line>                  <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br><span class=line>              <span class=attr>namespaces:</span></span><br><span class=line>                <span class=bullet>-</span> <span class=string>kube-system</span></span><br><span class=line>              <span class=attr>topologyKey:</span> <span class=string>kubernetes.io/hostname</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>args:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--cert-dir=/tmp'</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--secure-port=443'</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname'</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--kubelet-use-node-status-port'</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--kubelet-insecure-tls=true'</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--authorization-always-allow-paths=/livez,/readyz'</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>'--metric-resolution=15s'</span></span><br><span class=line>          <span class=attr>image:</span> <span class=string>>-</span></span><br><span class=line><span class=string>            swr.cn-east-2.myhuaweicloud.com/kuboard-dependency/metrics-server:v0.5.0</span></span><br><span class=line><span class=string></span>          <span class=attr>imagePullPolicy:</span> <span class=string>IfNotPresent</span></span><br><span class=line>          <span class=attr>livenessProbe:</span></span><br><span class=line>            <span class=attr>failureThreshold:</span> <span class=number>3</span></span><br><span class=line>            <span class=attr>httpGet:</span></span><br><span class=line>              <span class=attr>path:</span> <span class=string>/livez</span></span><br><span class=line>              <span class=attr>port:</span> <span class=string>https</span></span><br><span class=line>              <span class=attr>scheme:</span> <span class=string>HTTPS</span></span><br><span class=line>            <span class=attr>periodSeconds:</span> <span class=number>10</span></span><br><span class=line>          <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>          <span class=attr>ports:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>containerPort:</span> <span class=number>443</span></span><br><span class=line>              <span class=attr>name:</span> <span class=string>https</span></span><br><span class=line>              <span class=attr>protocol:</span> <span class=string>TCP</span></span><br><span class=line>          <span class=attr>readinessProbe:</span></span><br><span class=line>            <span class=attr>failureThreshold:</span> <span class=number>3</span></span><br><span class=line>            <span class=attr>httpGet:</span></span><br><span class=line>              <span class=attr>path:</span> <span class=string>/readyz</span></span><br><span class=line>              <span class=attr>port:</span> <span class=string>https</span></span><br><span class=line>              <span class=attr>scheme:</span> <span class=string>HTTPS</span></span><br><span class=line>            <span class=attr>initialDelaySeconds:</span> <span class=number>20</span></span><br><span class=line>            <span class=attr>periodSeconds:</span> <span class=number>10</span></span><br><span class=line>          <span class=attr>resources:</span></span><br><span class=line>            <span class=attr>requests:</span></span><br><span class=line>              <span class=attr>cpu:</span> <span class=string>100m</span></span><br><span class=line>              <span class=attr>memory:</span> <span class=string>200Mi</span></span><br><span class=line>          <span class=attr>securityContext:</span></span><br><span class=line>            <span class=attr>readOnlyRootFilesystem:</span> <span class=literal>true</span></span><br><span class=line>            <span class=attr>runAsNonRoot:</span> <span class=literal>true</span></span><br><span class=line>            <span class=attr>runAsUser:</span> <span class=number>1000</span></span><br><span class=line>          <span class=attr>volumeMounts:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>mountPath:</span> <span class=string>/tmp</span></span><br><span class=line>              <span class=attr>name:</span> <span class=string>tmp-dir</span></span><br><span class=line>      <span class=attr>nodeSelector:</span></span><br><span class=line>        <span class=attr>kubernetes.io/os:</span> <span class=string>linux</span></span><br><span class=line>      <span class=attr>priorityClassName:</span> <span class=string>system-cluster-critical</span></span><br><span class=line>      <span class=attr>serviceAccountName:</span> <span class=string>metrics-server</span></span><br><span class=line>      <span class=attr>tolerations:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>effect:</span> <span class=string>''</span></span><br><span class=line>          <span class=attr>key:</span> <span class=string>node-role.kubernetes.io/master</span></span><br><span class=line>          <span class=attr>operator:</span> <span class=string>Exists</span></span><br><span class=line>      <span class=attr>volumes:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>emptyDir:</span> {}</span><br><span class=line>          <span class=attr>name:</span> <span class=string>tmp-dir</span></span><br><span class=line></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>policy/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>PodDisruptionBudget</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>metrics-server</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>minAvailable:</span> <span class=number>1</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>k8s-app:</span> <span class=string>metrics-server</span></span><br></pre></table></figure><h3 id=k8slens>k8sLens</h3><p><a href=https://k8slens.dev/ rel=noopener target=_blank>官方网站</a><h1 id=k8s配置>K8s配置</h1><h2 id=删除资源>删除资源</h2><p>若资源是DEPLOY.yaml创建的，则可以使用命令<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>删除yaml文件中描述的资源</span></span><br><span class=line>kubectl delete -f DEPLOY.yaml</span><br></pre></table></figure><p>删除命名空间中所有资源–暂时未验证<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>1、先查找该命名空间下的资源有哪些，</span><br><span class=line>kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -n ingress-nginx</span><br><span class=line>确定资源类型如下，</span><br><span class=line>ingress</span><br><span class=line>deployment</span><br><span class=line>service</span><br><span class=line></span><br><span class=line>2、清理ingress-nginx命名空间下的资源</span><br><span class=line>kubectl get ingress -n ingress-nginx |grep clife |awk '{print $1}'|xargs kubectl delete ingress -n ingress-nginx</span><br><span class=line>kubectl get service -n ingress-nginx |grep clife |awk '{print $1}'|xargs kubectl delete service -n ingress-nginx</span><br><span class=line>kubectl get deployment -n ingress-nginx |grep clife |awk '{print $1}'|xargs kubectl delete deployment -n ingress-nginx</span><br><span class=line>3、删除命名空间ingress-nginx</span><br><span class=line>kubectl delete ns ingress-nginx</span><br><span class=line>4、查看该命名空间是否已删除</span><br><span class=line>kubectl get ns ingress-nginx</span><br></pre></table></figure><h2 id=命令补全工具>命令补全工具</h2><h3 id=bash>bash</h3><p><code>bash</code>需要安装<code>bash-completion</code>:<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>yum install bash-completion</span><br><span class=line>echo "source &lt;(kubectl completion bash)" >> ~/.bashrc</span><br><span class=line>source ~/.bashrc</span><br></pre></table></figure><h3 id=zsh>zsh</h3><p>命令行执行：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>echo "source &lt;(kubectl completion zsh)" >> ~/.zshrc</span><br><span class=line>source ~/.zshrc</span><br></pre></table></figure><h2 id=普通用户命令权限>普通用户命令权限</h2><p>命令行执行：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>比如用户名为USER</span></span><br><span class=line>mkdir -p ~/.kube</span><br><span class=line>sudo cp -i /etc/kubernetes/admin.conf ~/.kube</span><br><span class=line>sudo chown USER:USER /etc/kubernetes/admin.conf</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>配置环境变量</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>zsh配置到.zshrc文件中添加</span></span><br><span class=line>export KUBECONFIG=~/.kube/admin.conf</span><br></pre></table></figure><h1 id=集群证书>集群证书</h1><p>集群证书存放位置<code>/etc/kubernetes/pki/</code><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>检查哪些证书过期</span></span><br><span class=line>kubeadm certs check-expiration</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>手动刷新证书</span></span><br><span class=line>kubeadm certs renew all</span><br></pre></table></figure><h1 id=性能测试>性能测试</h1><p>工具使用参考<a href=https://jimmysong.io/kubernetes-handbook/practice/network-and-cluster-perfermance-test.html rel=noopener target=_blank>测试文档</a><p>基础网络工具有：curl,iperf,<a href=http://locust.io/ rel=noopener target=_blank>Locust</a>,<a href=https://github.com/kubernetes/kubernetes/tree/master/test/e2e rel=noopener target=_blank>kubemark</a><p>业务性能测试有：JMeter, LoadRunner<p>Apache JMeter是压力测试工具。<p>LoadRunner是一种预测系统行为和性能的负载测试工具。<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>时间指标说明</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>单位：秒</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>time_connect：建立到服务器的 TCP 连接所用的时间</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>time_starttransfer：在发出请求之后，Web 服务器返回数据的第一个字节所用的时间</span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>time_total：完成请求所用的时间</span></span><br><span class=line>curl -o /dev/null -s -w '%{time_connect} %{time_starttransfer} %{time_total}' "http://sample-webapp:8000/"</span><br></pre></table></figure><p>iperf在CentOS安装方法<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>yum install epel-release</span><br><span class=line>yum update</span><br><span class=line>yum install iperf</span><br></pre></table></figure><p>使用方法<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动tcp服务端</span></span><br><span class=line>iperf -s</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动客户端测试</span></span><br><span class=line>iperf -c &lt;SERVER_IP></span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动udp服务端</span></span><br><span class=line>iperf -s -u</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>启动客户端测试，udp可能受参数限制带宽，可以用-b更改最大带宽</span></span><br><span class=line>iperf -c &lt;SERVER_IP> -u</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>双向测试只需要客户端增加-d参数</span></span><br></pre></table></figure><h1 id=容器化构建发布>容器化构建发布</h1><h2 id=构建发布>构建发布</h2><p>参考<a href=https://github.com/kubernetes/ingress-nginx/blob/5a52d99ae85cfe5ef9535291b8326b0006e75066/images/go-grpc-greeter-server/rootfs/Dockerfile rel=noopener target=_blank>文章</a>，Dockerfile：<figure class="highlight dockerfile"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>FROM</span> golang:buster as build</span><br><span class=line><span class=keyword>WORKDIR</span><span class=language-bash> /go/src/greeter-server</span></span><br><span class=line><span class=keyword>RUN</span><span class=language-bash> curl -o main.go https://github.com/grpc/grpc-go/blob/91e0aeb192456225adf27966d04ada4cf8599915/examples/features/reflection/server/main.go && \</span></span><br><span class=line><span class=language-bash>  go mod init greeter-server && \</span></span><br><span class=line><span class=language-bash>  go mod tidy && \</span></span><br><span class=line><span class=language-bash>  go build -o /greeter-server main.go</span></span><br><span class=line></span><br><span class=line><span class=keyword>FROM</span> gcr.io/distroless/base-debian10</span><br><span class=line><span class=keyword>COPY</span><span class=language-bash> --from=build /greeter-server /</span></span><br><span class=line><span class=keyword>EXPOSE</span> <span class=number>50051</span></span><br><span class=line><span class=keyword>CMD</span><span class=language-bash> [<span class=string>"/greeter-server"</span>]</span></span><br></pre></table></figure><h2 id=grpc示例>grpc示例</h2><p>ingress支持grpc示例，参考<a href=https://github.com/kubernetes/ingress-nginx/tree/main/docs/examples/grpc rel=noopener target=_blank>文章</a><h1 id=卸载k8s>卸载K8s</h1><h2 id=清理本体>清理本体</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>卸载集群本体</span></span><br><span class=line>kubeadm reset -f</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>清理本体文件夹</span></span><br><span class=line>rm -rf ~/.kube/ /etc/kubernetes/ /etc/cni /opt/cni /var/lib/etcd</span><br></pre></table></figure><h2 id=清理组件>清理组件</h2><h3 id=centos主机-5>CentOS主机</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>清理组件</span></span><br><span class=line>yum autoremove -y kubelet kubeadm kubectl && rm -rf /usr/bin/kube*</span><br></pre></table></figure><h3 id=debianubuntu主机>Debian/Ubuntu主机</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>清理组件</span></span><br><span class=line>apt-get remove kube*</span><br><span class=line>rm -rf /usr/bin/kube*</span><br></pre></table></figure><h2 id=清理相关镜像>清理相关镜像</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>由于从registry.cn-hangzhou.aliyuncs.com拉取的镜像，将镜像删除</span></span><br><span class=line>docker image ls | grep -v grep | grep -v REPOSITORY | grep registry.cn-hangzhou.aliyuncs.com | awk '{print $3}' | xargs docker image rm -</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>将所有镜像全部删除</span></span><br><span class=line>docker image ls | grep -v REPOSITORY | awk '{print $3}' | xargs docker image rm -</span><br></pre></table></figure><h1 id=faq>FAQ</h1><h2 id=bridge-nf-call-iptables异常>bridge-nf-call-iptables异常</h2><p>安装时报错<code>[ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridge-nf-call-iptables contents are not set to 1</code><p>参考<a href=https://developer.aliyun.com/article/701252 rel=noopener target=_blank>文章</a><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>解决方案</span></span><br><span class=line>echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class=line>echo 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables</span><br></pre></table></figure><h2 id=flannel无法访问kubernetes资源10.96.0.1不可达>flannel无法访问kubernetes资源10.96.0.1不可达</h2><p><code>10.96.0.1</code>地址是指向k8s集群<code>default</code>空间创建的<code>kubernetes</code>服务的，底层基础网络不通（tcpdump无法抓到到此IP的包，可以考虑更换工具或者增加参数）。虚拟机使用的是虚拟主机网络，怀疑是网络配置问题，将此网络包丢弃导致。虚拟机更换为普通桥接问题解决。<p>先参考<a href=https://blog.csdn.net/nanhavezhi/article/details/103470449 rel=noopener target=_blank>资料</a><p>kube-proxy开启ipvs的前置条件（所有节点）<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>cat > /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF</span><br><span class=line><span class="meta prompt_">#</span><span class=language-bash>!/bin/bash</span></span><br><span class=line>modprobe -- ip_vs</span><br><span class=line>modprobe -- ip_vs_rr</span><br><span class=line>modprobe -- ip_vs_wrr</span><br><span class=line>modprobe -- ip_vs_sh</span><br><span class=line>modprobe -- nf_conntrack_ipv4</span><br><span class=line>EOF</span><br><span class=line>chmod 755 /etc/sysconfig/modules/ipvs.modules</span><br></pre></table></figure><p>docker使用systemd的cgroup<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>/etc/docker/daemon.json中增加</span><br><span class=line>"exec-opts": ["native.cgroupdriver=systemd"]</span><br><span class=line>Cgroup Driver: cgroupfs</span><br></pre></table></figure><p>1<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>kubeadm config print init-defaults > kubeadm-config.yaml</span><br><span class=line></span><br><span class=line>修改advertiseAddress值为本机IP</span><br><span class=line>修改kubernetesVersion为k8s版本</span><br><span class=line>修改dnsDomain为最高级域名--非必须</span><br><span class=line>新增podSubnet: 10.244.0.0/16容器子网--非必须</span><br><span class=line>修改serviceSubnet服务子网--非必须</span><br><span class=line><span class="meta prompt_"></span></span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>镜像名需要改--</span></span><br><span class=line>kubeadm init --config=kubeadm-config.yaml --upload-certs | tee kubeadm-init.log</span><br><span class=line><span class="meta prompt_"># </span><span class=language-bash>简化初始化流程</span></span><br><span class=line>kubeadm init --apiserver-advertise-address=192.168.208.3 --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers --service-dns-domain=imsv2</span><br><span class=line></span><br><span class=line>kubectl -n kube-system get all</span><br></pre></table></figure><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>日志中关键错误</span></span><br><span class=line>E1228 14:03:55.799748       1 main.go:234] Failed to create SubnetManager: error retrieving pod spec for 'kube-system/kube-flannel-ds-rbzdn': Get "https://10.96.0.1:443/api/v1/namespaces/kube-system/pods/kube-flannel-ds-rbzdn": dial tcp 10.96.0.1:443: connect: network is unreachable</span><br></pre></table></figure><h2 id=网络性能调优>网络性能调优</h2><p>参考<a href=https://www.cnblogs.com/zhangrui153169/p/15176212.html rel=noopener target=_blank>文章</a><h2 id=centos7内核版本低导致部分域名解析失败>CentOS7内核版本低导致部分域名解析失败</h2><p>参考<a href=https://blog.csdn.net/qq_34533957/article/details/111409196 rel=noopener target=_blank>文章</a></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2023/09/28/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-C%E7%9A%84%E6%8C%87%E9%92%88%E9%97%AE%E9%A2%98/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2023/09/28/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-C%E7%9A%84%E6%8C%87%E9%92%88%E9%97%AE%E9%A2%98/ itemprop=url>编程语言-C的指针问题</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2023-09-28 22:47:53" datetime=2023-09-28T22:47:53+08:00>2023-09-28</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>1.8k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>7 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><p>为什么说指针是C语言的精髓？ 指针有什么用 举例说明<p>C语言的指针和语言历史背景相关，这个得从在上个世纪60年代说起……<p>一位年轻小伙小丹（Dennis MacAlistair Ritchie），需要编写一个操作系统，但缺少合适的语言工具。那时B语言精炼且接近硬件，但过于简单且数据无类型。用汇编写引导程序合适，大型操作系统效率有点低。年轻人想法就是多，没有工具就自制工具上，于是小丹同学就顺手设计了C语言。<p>作为一门语言工具的目的很纯粹，为操作系统而生[旺柴]<ul><li>开发效率高的高级语言；<li>能够直接操作硬件；<li>编译后的代码执行效率高；</ul><p>C作为高级语言，与同时期的高级语言比肯定不能弱，毕竟那时没有Java、C++、PHP、Go、Python、C#等高级语言，而且这一点和题目没什么关系[旺柴]<hr><p>正式回到主题<p><strong>1. 操作硬件</strong><p>这个主要是应用在与硬件非常近的场景，主要用于<strong>读写特定寄存器</strong>，比如：嵌入式开发、驱动软件开发、操作系统开发等。<p>这里先以以简单的stm32f103为例。GPIOB8管脚有连接一个LED灯，此时若想点亮这个灯就需要控制管脚输出高电平：<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> GPIOB_BSRR *((volatile unsigned int *)(0x40010C00 + 0x10))</span></span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>void</span>)</span></span><br><span class=line>{</span><br><span class=line>    ...</span><br><span class=line>    <span class=comment>//点亮LED</span></span><br><span class=line>    GPIOB_BSRR = <span class=number>1</span> &lt;&lt; <span class=number>8</span>;</span><br><span class=line>	...</span><br><span class=line>}</span><br></pre></table></figure><p>注意看，宏<code>GPIOB_BSRR</code>定义为<code>*((volatile unsigned int *)0x40010C10)</code>，这里已经应用了指针的知识，这个地址就是GPIOB口的BSRR寄存器。至于为什么是这个地址和写入值的含义与处理器相关，具体可以查看STM32F103芯片手册。换一种写法就是<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>void</span>)</span></span><br><span class=line>{</span><br><span class=line>    <span class=keyword>volatile</span> <span class=type>unsigned</span> <span class=type>int</span> *pGPIO_BSRR = (<span class=keyword>volatile</span> <span class=type>unsigned</span> <span class=type>int</span> *)<span class=number>0x40010C10</span>;</span><br><span class=line>    ...</span><br><span class=line>    <span class=comment>//点亮LED</span></span><br><span class=line>    *pGPIO_BSRR = <span class=number>0x100000000</span>;</span><br><span class=line>    ...</span><br><span class=line>}</span><br></pre></table></figure><p>指针是一种变量，<code>pGPIO_BSRR</code>中存储的值是<code>0x40010C10</code>，则点亮LED语句就是向地址<code>0x40010C10</code>写入一个整数值<code>0x100000000</code>。<strong>若不用指针用普通变量能表达向特定寄存器赋值的语义吗？显然是不能的</strong>。<p>毕竟声明一个整数变量，它地址是<code>0x40010C10</code>概率还没我中大奖的概率大。每个特定处理器寄存器的地址是固定的，与内存地址范围没有交叠，所以编译器也不会给普通变量分配这样的地址。<p>部分同学可能不熟悉嵌入式，再找找上古Linux 0.11中有这么一个函数<code>con_init</code>，读取显示参数（<code>0x90006</code>地址存储显示参数在启动时获取的存储的）<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> ORIG_VIDEO_COLS (((*(unsigned short *)0x90006) & 0xff00) >> 8)</span></span><br><span class=line></span><br><span class=line><span class=type>void</span> <span class="title function_">con_init</span><span class=params>(<span class=type>void</span>)</span></span><br><span class=line>{</span><br><span class=line>    ...</span><br><span class=line>    video_num_columns = ORIG_VIDEO_COLS;</span><br><span class=line>    ...</span><br><span class=line>}</span><br></pre></table></figure><p>换种写法就是<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=type>void</span> <span class="title function_">con_init</span><span class=params>(<span class=type>void</span>)</span></span><br><span class=line>{</span><br><span class=line>    ...</span><br><span class=line>    <span class=type>unsigned</span> <span class=type>short</span> *pORIG_VIDEO = (<span class=type>unsigned</span> <span class=type>short</span> *)<span class=number>0x90006</span>;</span><br><span class=line>    <span class=type>unsigned</span> <span class=type>short</span> ORIG_VIDEO_COLS = ((*pORIG_VIDEO)>><span class=number>8</span>) & <span class=number>0xff</span>;</span><br><span class=line>    video_num_columns = ORIG_VIDEO_COLS;</span><br><span class=line>    ...</span><br><span class=line>}</span><br></pre></table></figure><p>这段就是将参数从内存地址<code>0x90006</code>中取出来，参数高字节就是显示列数。与嵌入式不同的是，这个地址就是普通内存地址，还是有运气遇到这个地址的[旺柴]<p><strong>2. 执行效率高</strong><p>其他老师不太清楚，我们像上课那会儿，老师怎么介绍指针的？<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=type>int</span> a = <span class=number>5</span>;</span><br><span class=line><span class=type>int</span> *pa = &a;</span><br><span class=line>*pa = <span class=number>6</span>;</span><br><span class=line><span class=built_in>printf</span>(<span class=string>"a=%d\n"</span>, *pa);</span><br></pre></table></figure><p>本人：「老师，为啥不直接使用变量<code>a</code>」<p>老师：「这里讲解指针<code>pa</code>的用途」<p>[旺柴]<p>其实，<strong>指针很多时候是为提高执行效率，避免大块数据拷贝</strong>。比如，在收到一个1.5K的网络二进制包，需要调用解析函数<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> PACKAGE_SIZE 1500</span></span><br><span class=line></span><br><span class=line><span class=keyword>typedef</span> <span class=class><span class=keyword>struct</span> <span class=title>net_raw_s</span></span></span><br><span class=line><span class=class>{</span></span><br><span class=line>    <span class=type>int</span> data[PACKAGE_SIZE];</span><br><span class=line>    ...</span><br><span class=line>} <span class=type>net_raw_t</span>;</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">parse</span><span class=params>(<span class=type>const</span> <span class=type>net_raw_t</span> raw)</span></span><br><span class=line>{</span><br><span class=line>    <span class=comment>// 具体解析数据流程，保密</span></span><br><span class=line>    ...</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>()</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>net_raw_t</span> recv_net_data;</span><br><span class=line>	...</span><br><span class=line>    <span class=comment>// 接收到网络数据准备解析</span></span><br><span class=line>    <span class=type>int</span> ret = parse(recv_net_data);</span><br><span class=line>	...</span><br><span class=line>}</span><br></pre></table></figure><p>每次调用<code>parse</code>函数都会拷贝<code>net_raw_t</code>类型数据，这个数据包有1.5K大小耗时非常多的。从执行效率考虑，此处非常适合使用指针方式，虽然要麻烦一点点<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> PACKAGE_SIZE 1500</span></span><br><span class=line></span><br><span class=line><span class=keyword>typedef</span> <span class=class><span class=keyword>struct</span> <span class=title>net_raw_s</span></span></span><br><span class=line><span class=class>{</span></span><br><span class=line>    <span class=type>int</span> data[PACKAGE_SIZE];</span><br><span class=line>    ...</span><br><span class=line>} <span class=type>net_raw_t</span>;</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">parse</span><span class=params>(<span class=type>net_raw_t</span> *<span class=type>const</span> raw)</span></span><br><span class=line>{</span><br><span class=line>    <span class=comment>// 具体解析数据流程，保密</span></span><br><span class=line>    ...</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>()</span></span><br><span class=line>{</span><br><span class=line>    <span class=type>net_raw_t</span> recv_net_data;</span><br><span class=line>	...</span><br><span class=line>    <span class=comment>// 接收到网络数据准备解析</span></span><br><span class=line>    <span class=type>int</span> ret = parse(&recv_net_data);</span><br><span class=line>	...</span><br><span class=line>}</span><br></pre></table></figure><p>本质上说，<strong>函数参数永远都是值传递，没有所谓的地址传递</strong>。函数参数<code>raw</code>指针变量只是赋值为<code>recv_net_data变量的地址</code>，没有所谓的地址传递。而<strong>指针的优势是，不管什么类型的指针，它自身都只占用4字节内存（32位），所以赋值效率高</strong>。若将函数<code>parse</code>修改为传递1.5K个指针，相信它的执行效率比最初版本<code>parse</code>还要慢。<hr><p>还有一个抽象性应该很多高级语言都有，只是C语言需要利用指针来完成。<p><strong>3. 抽象性</strong><p>主要涉及函数指针，在模块设计时用处比较大，就是模块对外提供抽象接口。<strong>可以降低模块的耦合性，提升功能内聚性，提高协同开发效率，整体降低工程成本</strong>。这个特性在Linux内核中应用也非常广泛，下面主要以字符驱动为例进行说明。没接触过Linux字符驱动的建议先参考这篇文章<p><a href=https://zhuanlan.zhihu.com/p/506834783 rel=noopener target=_blank>Linux设备驱动之字符设备驱动（超级详细~）</a><p>Linux字符设备驱动的通用操作<ul><li>初始化<li>打开设备<li>读数据<li>写数据<li>关闭设备<li>等等操作</ul><p>所有设备都按下面这个模板实现接口逻辑，就形成各种字符设备驱动。下面这个是并口打印机的驱动（源文件在<code>linux-2.6.12/drivers/char/lp.c</code>）：<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>struct</span> <span class=title>file_operations</span> {</span></span><br><span class=line>    ...</span><br><span class=line>	<span class=type>int</span> (*open) (<span class=keyword>struct</span> inode *, <span class=keyword>struct</span> file *);</span><br><span class=line>    ...</span><br><span class=line>};</span><br><span class=line></span><br><span class=line><span class=type>static</span> <span class=class><span class=keyword>struct</span> <span class=title>file_operations</span> <span class=title>lp_fops</span> =</span> {</span><br><span class=line>	.owner		= THIS_MODULE,</span><br><span class=line>	.write		= lp_write,</span><br><span class=line>	.ioctl		= lp_ioctl,</span><br><span class=line>	.open		= lp_open,</span><br><span class=line>	.release	= lp_release,</span><br><span class=line>	.read		= lp_read,</span><br><span class=line>};</span><br><span class=line></span><br><span class=line><span class=type>static</span> <span class=type>int</span> <span class="title function_">lp_open</span><span class=params>(<span class=keyword>struct</span> inode * inode, <span class=keyword>struct</span> file * file)</span></span><br><span class=line>{</span><br><span class=line>    ...</span><br><span class=line>}</span><br></pre></table></figure><p>在加载了这个驱动后，应用程序只需要调用<code>open</code>、<code>read</code>、<code>close</code>等接口就能操作这个字符设备。当然应用程序需要通过打印机打印信息时，需要先打开打印机设备，就要调用内核<code>open</code>函数。此时调用的<code>open</code>不是结构体<code>struct file_operations</code>中的函数指针，而是内核接口封装过的，但最终是调用<code>lp_open</code>，这样设备就初始化好就能继续操作。<p>在打开设备过程中，内核调用它们的都是结构体<code>struct file_operations</code>中的<code>open</code>函数指针。此时内核只关注要打开设备，而不关注设备如何打开，这些其实就是抽象。不管是打印机设备还是串口设备，只要需要打开动作，内核就负责找到设备的结构体<code>struct file_operations</code>中的<code>open</code>函数指针调用即可。<p>若没有这个抽象性，那编写内核时就要直接调用驱动接口。则一个开发人员既要掌握内核驱动管理逻辑细节，又要掌握设备驱动逻辑细节，最后软件维护成本必然很高。<hr><p>上面说的这些都是了解的C语言指针的用处，只想说它太重要了，这也是这门上古语言能流传至今的秘宝。<p><strong>以上都是个人对指针的理解，若有纰漏望轻喷[旺柴]</strong>。</div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://oz1010.github.com/2023/09/28/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-Haskell%E7%AE%80%E4%BB%8B/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.jpg itemprop=image> <meta content=oz1010 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content="oz1010's blog" itemprop=name> <meta content=普通而有趣的技术员 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content=" | oz1010's blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2023/09/28/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-Haskell%E7%AE%80%E4%BB%8B/ itemprop=url>编程语言-Haskell简介</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2023-09-28 22:47:48" datetime=2023-09-28T22:47:48+08:00>2023-09-28</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-08-25 21:59:14" datetime=2025-08-25T21:59:14+08:00 itemprop=dateModified>2025-08-25</time> </span><span class=post-meta-break></span><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>13</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>1 分钟</span> </span></div></div></header><div class=post-body itemprop=articleBody><p>函数式编程<p><a href=https://www.haskell.org/ rel=noopener target=_blank>官方主页</a><p><a href=https://www.w3cschool.cn/hsriti/r6w1aozt.html rel=noopener target=_blank>网上教程</a></div><footer class=post-footer><div class=post-eof></div></footer></article></div><nav class=pagination><a class="extend prev" aria-label=上一页 href=/ rel=prev title=上一页><i class="fa fa-angle-left"></i></a><a class=page-number href=/>1</a><span class="page-number current">2</span><a class=page-number href=/page/3/>3</a><a class="extend next" aria-label=下一页 href=/page/3/ rel=next title=下一页><i class="fa fa-angle-right"></i></a></nav></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2025</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>oz1010</span></div><div class=wordcount><span class=post-meta-item> <span class=post-meta-item-icon> <i class="fa fa-chart-line"></i> </span> <span title=站点总字数>84k</span> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="fa fa-coffee"></i> </span> <span title=站点阅读时长>5:04</span> </span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript>